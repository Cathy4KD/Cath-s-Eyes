<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Soumission - Arr√™t Annuel</title>
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#1a237e">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- PDF pour export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a87;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .portal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .portal-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .portal-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .entreprise-badge {
            background: var(--accent);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .info-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Main content */
        .portal-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Stats bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--surface-light);
        }

        .stat-card .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-card .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Tabs */
        .portal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .portal-tab {
            padding: 12px 24px;
            background: var(--surface);
            border: none;
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .portal-tab:hover {
            background: var(--surface-light);
        }

        .portal-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Section card */
        .section-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--surface-light);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Travaux list */
        .travaux-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .travail-card {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--surface-light);
            transition: all 0.2s;
        }

        .travail-card:hover {
            border-color: var(--accent);
            transform: translateX(5px);
        }

        .travail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .travail-ot {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .travail-priorite {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priorite-haute { background: #dc2626; color: white; }
        .priorite-moyenne { background: #f59e0b; color: #000; }
        .priorite-basse { background: #10b981; color: white; }

        .travail-description {
            font-size: 1.05rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .travail-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .detail-value {
            font-weight: 500;
        }

        /* Photos gallery */
        .travail-photos {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--surface-light);
        }

        .photo-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo-thumb:hover {
            transform: scale(1.1);
        }

        /* Historique badge */
        .historique-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* Plan section */
        .plan-container {
            position: relative;
            background: var(--background);
            border-radius: 12px;
            overflow: hidden;
            min-height: 400px;
        }

        .plan-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .plan-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: var(--accent);
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: #000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .plan-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
        }

        /* Soumission form */
        .soumission-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            background: var(--background);
            border: 1px solid var(--surface-light);
            border-radius: 8px;
            padding: 12px;
            color: var(--text);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Soumission par travail */
        .soumission-travail {
            background: var(--background);
            border-radius: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
            border: 1px solid var(--surface-light);
        }

        .soumission-travail-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .soumission-travail-ot {
            font-weight: 600;
            color: var(--accent);
        }

        .soumission-travail-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .soumission-input {
            width: 120px;
            text-align: right;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: #000;
        }

        .btn-primary:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Actions bar */
        .actions-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid var(--surface-light);
            margin-top: 20px;
        }

        /* Historique section */
        .historique-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .historique-item {
            background: var(--background);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #8b5cf6;
        }

        .historique-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .historique-annee {
            background: #8b5cf6;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 600;
        }

        .historique-prix {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success);
        }

        /* Loading & Error states */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--surface-light);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-container {
            text-align: center;
            padding: 60px 20px;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .error-message {
            color: var(--text-muted);
        }

        /* Date limite */
        .date-limite-banner {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .date-limite-banner.urgent {
            animation: pulse-urgent 2s infinite;
        }

        @keyframes pulse-urgent {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        }

        .date-limite-text {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .date-limite-countdown {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--danger);
        }

        /* Photo modal */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .photo-modal.show {
            display: flex;
        }

        .photo-modal img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .portal-title {
                flex-direction: column;
            }

            .header-info {
                justify-content: center;
            }

            .portal-tabs {
                justify-content: center;
            }

            .travail-header {
                flex-direction: column;
            }

            .soumission-travail {
                grid-template-columns: 1fr;
            }

            .soumission-input {
                width: 100%;
            }

            .actions-bar {
                justify-content: center;
            }
        }

        /* Soumission d√©j√† envoy√©e */
        .soumission-confirmee {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
        }

        .soumission-confirmee-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .soumission-confirmee h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .soumission-confirmee p {
            color: rgba(255,255,255,0.8);
            font-size: 1.1rem;
        }

        .soumission-resume {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Chargement du portail...</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="photo-modal" id="photoModal" onclick="PortailEntrepreneur.closePhotoModal()">
        <button class="photo-modal-close">&times;</button>
        <img id="photoModalImg" src="" alt="Photo">
    </div>

    <script src="firebase.js"></script>
    <script>
        // Portail Entrepreneur - Application
        const PortailEntrepreneur = {
            appelId: null,
            appelData: null,
            entreprise: null,
            travaux: [],
            historique: {},
            soumissionEnvoyee: false,

            async init() {
                // R√©cup√©rer l'ID de l'appel depuis l'URL
                const params = new URLSearchParams(window.location.search);
                this.appelId = params.get('id');

                if (!this.appelId) {
                    this.showError('Lien invalide', 'Ce lien de soumission n\'est pas valide. Veuillez contacter le gestionnaire.');
                    return;
                }

                try {
                    await this.loadAppelData();
                } catch (error) {
                    console.error('Erreur chargement:', error);
                    this.showError('Erreur de chargement', 'Impossible de charger les donn√©es. Veuillez r√©essayer.');
                }
            },

            async loadAppelData() {
                // Charger les donn√©es de l'appel depuis Firebase
                const doc = await firebase.firestore().collection('appels_soumission').doc(this.appelId).get();

                if (!doc.exists) {
                    this.showError('Appel non trouv√©', 'Cet appel de soumission n\'existe pas ou a expir√©.');
                    return;
                }

                this.appelData = doc.data();
                this.entreprise = this.appelData.entreprise;
                this.travaux = this.appelData.travaux || [];

                // V√©rifier si une soumission existe d√©j√†
                const soumissionDoc = await firebase.firestore()
                    .collection('soumissions_recues')
                    .doc(this.appelId)
                    .get();

                if (soumissionDoc.exists) {
                    this.soumissionEnvoyee = true;
                    this.soumissionData = soumissionDoc.data();
                }

                // Charger l'historique des travaux similaires
                await this.loadHistorique();

                this.render();
            },

            async loadHistorique() {
                // Charger l'historique par √©quipement (simplifi√© sans orderBy pour √©viter erreur d'index)
                try {
                    const equipements = [...new Set(this.travaux.map(t => t.equipement).filter(e => e))];

                    for (const equip of equipements) {
                        try {
                            const snapshot = await firebase.firestore()
                                .collection('historique_travaux')
                                .where('equipement', '==', equip)
                                .limit(5)
                                .get();

                            if (!snapshot.empty) {
                                this.historique[equip] = snapshot.docs.map(d => d.data());
                            }
                        } catch (e) {
                            console.log('Pas d\'historique pour', equip);
                        }
                    }
                } catch (error) {
                    console.log('Historique non disponible:', error);
                }
            },

            showError(title, message) {
                document.getElementById('app').innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">‚ùå</div>
                        <h1 class="error-title">${title}</h1>
                        <p class="error-message">${message}</p>
                    </div>
                `;
            },

            render() {
                const app = document.getElementById('app');
                const dateLimite = this.appelData.dateLimite ? new Date(this.appelData.dateLimite) : null;
                const joursRestants = dateLimite ? Math.ceil((dateLimite - new Date()) / (1000 * 60 * 60 * 24)) : null;
                const isUrgent = joursRestants !== null && joursRestants <= 3;

                const totalHeures = this.travaux.reduce((sum, t) => sum + (t.estimationHeures || 0), 0);

                app.innerHTML = `
                    <header class="portal-header">
                        <div class="header-content">
                            <div class="portal-title">
                                <h1>üîß Portail Soumission</h1>
                                <span class="entreprise-badge">${this.entreprise}</span>
                            </div>
                            <div class="header-info">
                                <div class="info-item">
                                    <span class="info-label">Arr√™t</span>
                                    <span class="info-value">${this.appelData.nomArret || 'Arr√™t Annuel 2025'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Travaux</span>
                                    <span class="info-value">${this.travaux.length}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Heures estim√©es</span>
                                    <span class="info-value">${totalHeures}h</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main class="portal-content">
                        ${dateLimite ? `
                            <div class="date-limite-banner ${isUrgent ? 'urgent' : ''}">
                                <span class="date-limite-text">
                                    ‚è∞ Date limite de soumission: ${dateLimite.toLocaleDateString('fr-CA')}
                                </span>
                                <span class="date-limite-countdown">
                                    ${joursRestants > 0 ? `${joursRestants} jour${joursRestants > 1 ? 's' : ''} restant${joursRestants > 1 ? 's' : ''}` : 'EXPIR√â'}
                                </span>
                            </div>
                        ` : ''}

                        ${this.soumissionEnvoyee ? this.renderSoumissionConfirmee() : this.renderPortail()}
                    </main>
                `;

                // Initialiser les √©v√©nements
                this.initEvents();
            },

            renderSoumissionConfirmee() {
                return `
                    <div class="soumission-confirmee">
                        <div class="soumission-confirmee-icon">‚úÖ</div>
                        <h2>Soumission envoy√©e avec succ√®s!</h2>
                        <p>Votre soumission a √©t√© re√ßue le ${new Date(this.soumissionData.dateEnvoi).toLocaleDateString('fr-CA')} √† ${new Date(this.soumissionData.dateEnvoi).toLocaleTimeString('fr-CA')}</p>

                        <div class="soumission-resume">
                            <h3>R√©sum√© de votre soumission</h3>
                            <p><strong>Montant total:</strong> ${this.soumissionData.montantTotal?.toLocaleString() || 'N/A'} $</p>
                            <p><strong>D√©lai estim√©:</strong> ${this.soumissionData.delaiEstime || 'N/A'}</p>
                            ${this.soumissionData.commentaires ? `<p><strong>Commentaires:</strong> ${this.soumissionData.commentaires}</p>` : ''}
                        </div>

                        <div class="actions-bar" style="justify-content: center; border: none; margin-top: 30px;">
                            <button class="btn btn-secondary" onclick="PortailEntrepreneur.exportPDF()">
                                üìÑ T√©l√©charger PDF
                            </button>
                        </div>
                    </div>
                `;
            },

            renderPortail() {
                return `
                    <div class="portal-tabs">
                        <button class="portal-tab active" data-tab="travaux">
                            üìã Liste des travaux
                        </button>
                        <button class="portal-tab" data-tab="plan">
                            üó∫Ô∏è Plan / Localisation
                        </button>
                        <button class="portal-tab" data-tab="historique">
                            üìä Historique
                        </button>
                        <button class="portal-tab" data-tab="soumission">
                            üí∞ Soumettre
                        </button>
                    </div>

                    <div id="tab-content">
                        ${this.renderTravauxTab()}
                    </div>
                `;
            },

            renderTravauxTab() {
                return `
                    <div class="section-card">
                        <div class="section-header">
                            <h2 class="section-title">üìã Travaux √† soumissionner</h2>
                            <button class="btn btn-secondary" onclick="PortailEntrepreneur.exportPDF()">
                                üìÑ Export PDF
                            </button>
                        </div>

                        <div class="travaux-grid">
                            ${this.travaux.map((t, index) => this.renderTravailCard(t, index)).join('')}
                        </div>
                    </div>
                `;
            },

            renderTravailCard(travail, index) {
                const prioriteClass = (travail.priorite || '').toLowerCase().includes('haute') ? 'priorite-haute' :
                                      (travail.priorite || '').toLowerCase().includes('moyenne') ? 'priorite-moyenne' : 'priorite-basse';

                const historiqueEquip = this.historique[travail.equipement] || [];
                const photos = travail.photos || [];

                return `
                    <div class="travail-card">
                        <div class="travail-header">
                            <span class="travail-ot">${travail.ot || 'N/A'}</span>
                            <span class="travail-priorite ${prioriteClass}">${travail.priorite || 'Normal'}</span>
                        </div>

                        <div class="travail-description">${travail.description || 'Aucune description'}</div>

                        <div class="travail-details">
                            <div class="detail-item">
                                <span class="detail-label">√âquipement</span>
                                <span class="detail-value">${travail.equipement || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Discipline</span>
                                <span class="detail-value">${travail.discipline || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Heures estim√©es</span>
                                <span class="detail-value">${travail.estimationHeures || '-'}h</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Localisation</span>
                                <span class="detail-value">${travail.localisation || travail.secteur || '-'}</span>
                            </div>
                        </div>

                        ${travail.conditions ? `
                            <div class="detail-item" style="margin-top: 10px;">
                                <span class="detail-label">Conditions particuli√®res</span>
                                <span class="detail-value">${travail.conditions}</span>
                            </div>
                        ` : ''}

                        ${photos.length > 0 ? `
                            <div class="travail-photos">
                                ${photos.map(p => `
                                    <img src="${p}" class="photo-thumb" onclick="PortailEntrepreneur.showPhoto('${p}')" alt="Photo travail">
                                `).join('')}
                            </div>
                        ` : ''}

                        ${historiqueEquip.length > 0 ? `
                            <div class="historique-badge">
                                üìú Historique: ${historiqueEquip.length} travaux similaires sur cet √©quipement
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            renderPlanTab() {
                const planImage = this.appelData.planImage || null;

                return `
                    <div class="section-card">
                        <div class="section-header">
                            <h2 class="section-title">üó∫Ô∏è Localisation des travaux</h2>
                        </div>

                        ${planImage ? `
                            <div class="plan-container" id="planContainer">
                                <img src="${planImage}" class="plan-image" id="planImage" onload="PortailEntrepreneur.placerMarqueurs()">
                            </div>
                            <p style="color: var(--text-muted); margin-top: 10px; font-size: 0.9rem;">
                                Cliquez sur un marqueur pour voir les d√©tails du travail
                            </p>
                        ` : `
                            <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 15px;">üó∫Ô∏è</div>
                                <p>Aucun plan disponible pour cet appel</p>
                            </div>
                        `}
                    </div>
                `;
            },

            renderHistoriqueTab() {
                const equipements = Object.keys(this.historique);

                return `
                    <div class="section-card">
                        <div class="section-header">
                            <h2 class="section-title">üìä Historique des travaux similaires</h2>
                        </div>

                        ${equipements.length > 0 ? `
                            <div class="historique-list">
                                ${equipements.map(equip => `
                                    <div style="margin-bottom: 25px;">
                                        <h3 style="margin-bottom: 15px; color: var(--accent);">üìç ${equip}</h3>
                                        ${this.historique[equip].map(h => `
                                            <div class="historique-item">
                                                <div class="historique-header">
                                                    <span class="historique-annee">${h.annee}</span>
                                                    ${h.prix ? `<span class="historique-prix">${h.prix.toLocaleString()} $</span>` : ''}
                                                </div>
                                                <p style="margin-bottom: 8px;">${h.description || 'Travail similaire'}</p>
                                                <div style="display: flex; gap: 20px; color: var(--text-muted); font-size: 0.85rem;">
                                                    <span>üè¢ ${h.entreprise || 'N/A'}</span>
                                                    <span>‚è±Ô∏è ${h.heures || 'N/A'}h</span>
                                                    ${h.notes ? `<span>üìù ${h.notes}</span>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 15px;">üìä</div>
                                <p>Aucun historique disponible pour ces √©quipements</p>
                                <p style="font-size: 0.85rem; margin-top: 10px;">L'historique se construit au fil des ann√©es</p>
                            </div>
                        `}
                    </div>
                `;
            },

            renderSoumissionTab() {
                return `
                    <div class="section-card">
                        <div class="section-header">
                            <h2 class="section-title">üí∞ Votre soumission</h2>
                        </div>

                        <form class="soumission-form" id="soumissionForm" onsubmit="PortailEntrepreneur.envoyerSoumission(event)">
                            <h3 style="margin-bottom: 15px;">Prix par travail (optionnel)</h3>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px;">
                                ${this.travaux.map((t, i) => `
                                    <div class="soumission-travail">
                                        <div class="soumission-travail-info">
                                            <span class="soumission-travail-ot">${t.ot || 'N/A'}</span>
                                            <span class="soumission-travail-desc">${(t.description || '').substring(0, 60)}...</span>
                                        </div>
                                        <input type="number" class="form-group soumission-input"
                                               name="prix_${i}" placeholder="Prix $" min="0" step="0.01">
                                        <input type="number" class="form-group soumission-input"
                                               name="heures_${i}" placeholder="Heures" min="0" step="0.5">
                                    </div>
                                `).join('')}
                            </div>

                            <h3 style="margin-bottom: 15px;">Soumission globale</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Montant total ($) *</label>
                                    <input type="number" name="montantTotal" required min="0" step="0.01" placeholder="Ex: 15000">
                                </div>
                                <div class="form-group">
                                    <label>D√©lai estim√© *</label>
                                    <input type="text" name="delaiEstime" required placeholder="Ex: 5 jours ouvrables">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nombre de travailleurs pr√©vus</label>
                                    <input type="number" name="nbTravailleurs" min="1" placeholder="Ex: 4">
                                </div>
                                <div class="form-group">
                                    <label>Date de d√©but souhait√©e</label>
                                    <input type="date" name="dateDebut">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Commentaires / Questions / Conditions</label>
                                <textarea name="commentaires" placeholder="Ajoutez vos commentaires, questions ou conditions particuli√®res..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Contact (Nom et t√©l√©phone)</label>
                                <input type="text" name="contact" placeholder="Ex: Jean Tremblay - 514-555-1234">
                            </div>

                            <div class="actions-bar">
                                <button type="button" class="btn btn-secondary" onclick="PortailEntrepreneur.sauvegarderBrouillon()">
                                    üíæ Sauvegarder brouillon
                                </button>
                                <button type="submit" class="btn btn-success">
                                    ‚úÖ Envoyer la soumission
                                </button>
                            </div>
                        </form>
                    </div>
                `;
            },

            initEvents() {
                // Tab switching
                document.querySelectorAll('.portal-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.portal-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');

                        const tabName = e.target.dataset.tab;
                        const content = document.getElementById('tab-content');

                        switch(tabName) {
                            case 'travaux':
                                content.innerHTML = this.renderTravauxTab();
                                break;
                            case 'plan':
                                content.innerHTML = this.renderPlanTab();
                                break;
                            case 'historique':
                                content.innerHTML = this.renderHistoriqueTab();
                                break;
                            case 'soumission':
                                content.innerHTML = this.renderSoumissionTab();
                                break;
                        }
                    });
                });
            },

            placerMarqueurs() {
                const container = document.getElementById('planContainer');
                if (!container) return;

                // Placer les marqueurs pour chaque travail avec position
                this.travaux.forEach((t, i) => {
                    if (t.positionPlan) {
                        const marker = document.createElement('div');
                        marker.className = 'plan-marker';
                        marker.style.left = t.positionPlan.x + '%';
                        marker.style.top = t.positionPlan.y + '%';
                        marker.textContent = i + 1;
                        marker.title = `${t.ot} - ${t.description}`;
                        marker.onclick = () => this.showTravailDetail(i);
                        container.appendChild(marker);
                    }
                });
            },

            showTravailDetail(index) {
                const t = this.travaux[index];
                alert(`OT: ${t.ot}\n\n${t.description}\n\n√âquipement: ${t.equipement}\nHeures: ${t.estimationHeures}h`);
            },

            showPhoto(src) {
                document.getElementById('photoModalImg').src = src;
                document.getElementById('photoModal').classList.add('show');
            },

            closePhotoModal() {
                document.getElementById('photoModal').classList.remove('show');
            },

            async envoyerSoumission(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                const soumission = {
                    appelId: this.appelId,
                    entreprise: this.entreprise,
                    dateEnvoi: new Date().toISOString(),
                    montantTotal: parseFloat(formData.get('montantTotal')),
                    delaiEstime: formData.get('delaiEstime'),
                    nbTravailleurs: parseInt(formData.get('nbTravailleurs')) || null,
                    dateDebut: formData.get('dateDebut') || null,
                    commentaires: formData.get('commentaires'),
                    contact: formData.get('contact'),
                    prixParTravail: {}
                };

                // Collecter les prix par travail
                this.travaux.forEach((t, i) => {
                    const prix = parseFloat(formData.get(`prix_${i}`));
                    const heures = parseFloat(formData.get(`heures_${i}`));
                    if (prix || heures) {
                        soumission.prixParTravail[t.ot] = { prix, heures };
                    }
                });

                try {
                    // Sauvegarder dans Firebase
                    await firebase.firestore()
                        .collection('soumissions_recues')
                        .doc(this.appelId)
                        .set(soumission);

                    // Mettre √† jour le statut de l'appel
                    await firebase.firestore()
                        .collection('appels_soumission')
                        .doc(this.appelId)
                        .update({
                            soumissionRecue: true,
                            dateSoumission: new Date().toISOString()
                        });

                    this.soumissionEnvoyee = true;
                    this.soumissionData = soumission;
                    this.showToast('Soumission envoy√©e avec succ√®s!');
                    this.render();

                } catch (error) {
                    console.error('Erreur envoi soumission:', error);
                    this.showToast('Erreur lors de l\'envoi. Veuillez r√©essayer.', 'error');
                }
            },

            sauvegarderBrouillon() {
                const form = document.getElementById('soumissionForm');
                const formData = new FormData(form);
                const brouillon = {};
                formData.forEach((value, key) => brouillon[key] = value);

                localStorage.setItem(`brouillon_${this.appelId}`, JSON.stringify(brouillon));
                this.showToast('Brouillon sauvegard√©!');
            },

            exportPDF() {
                // Export simple en PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.text(`Soumission - ${this.entreprise}`, 20, 20);

                doc.setFontSize(12);
                doc.text(`Arr√™t: ${this.appelData.nomArret || 'Arr√™t Annuel'}`, 20, 35);
                doc.text(`Nombre de travaux: ${this.travaux.length}`, 20, 45);

                let y = 60;
                this.travaux.forEach((t, i) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.setFontSize(10);
                    doc.text(`${i+1}. [${t.ot}] ${(t.description || '').substring(0, 70)}`, 20, y);
                    doc.text(`   √âquipement: ${t.equipement || '-'} | Heures: ${t.estimationHeures || '-'}h`, 20, y + 5);
                    y += 15;
                });

                doc.save(`Soumission_${this.entreprise}_${new Date().toISOString().split('T')[0]}.pdf`);
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        };

        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', () => {
            PortailEntrepreneur.init();
        });
    </script>
</body>
</html>
