<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Soumission - Arrêt Annuel</title>
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#1e3a5f">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- PDF pour export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #1e293b;
            min-height: 100vh;
        }

        /* Header */
        .portal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 25px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .portal-title h1 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .portal-title p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .entreprise-badge {
            background: #f59e0b;
            color: #000;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .header-stats {
            display: flex;
            gap: 25px;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-num {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
        }

        /* Main content */
        .portal-content {
            max-width: 100%;
            margin: 0;
            padding: 20px;
        }

        /* Info banner */
        .info-banner {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .info-banner-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .info-banner-icon {
            font-size: 2rem;
        }

        .info-banner h2 {
            font-size: 1.1rem;
            color: #1e293b;
        }

        .info-banner p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-limite {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 10px 16px;
            border-radius: 10px;
            text-align: center;
        }

        .date-limite-label {
            font-size: 0.75rem;
            color: #92400e;
            text-transform: uppercase;
            font-weight: 600;
        }

        .date-limite-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #b45309;
        }

        .btn-pdf {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .btn-pdf:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        .btn-visite-pdf {
            background: linear-gradient(135deg, #be185d 0%, #9d174d 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(190, 24, 93, 0.3);
        }

        .btn-visite-pdf:hover {
            background: linear-gradient(135deg, #9d174d 0%, #831843 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(190, 24, 93, 0.4);
        }

        /* Bilan heures */
        .bilan-heures {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .bilan-heures-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bilan-heures-content {
            display: flex;
            align-items: flex-start;
            gap: 30px;
            flex-wrap: wrap;
        }

        .bilan-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .bilan-input-label {
            font-size: 0.7rem;
            color: #0369a1;
            font-weight: 600;
        }

        .bilan-input {
            width: 55px;
            padding: 6px 8px;
            border: 2px solid #7dd3fc;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
            color: #0369a1;
            background: white;
        }

        .bilan-input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .bilan-resultats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            flex: 1;
        }

        .bilan-stat {
            background: white;
            border-radius: 8px;
            padding: 8px 12px;
            text-align: center;
            min-width: 60px;
            box-shadow: 0 2px 6px rgba(14, 165, 233, 0.15);
        }

        .bilan-stat-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: #0369a1;
        }

        .bilan-stat-label {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 2px;
        }

        .bilan-stat.highlight {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }

        .bilan-stat.highlight .bilan-stat-value,
        .bilan-stat.highlight .bilan-stat-label {
            color: white;
        }

        .bilan-detail {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #bae6fd;
        }

        .bilan-ligne-complete {
            display: flex;
            align-items: center;
            gap: 0;
            flex-wrap: wrap;
        }

        /* Calculateurs séparés AA et TPAA */
        .bilan-calculateurs {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .bilan-calculateur-section {
            flex: 1;
            min-width: 280px;
            background: white;
            border-radius: 10px;
            padding: 12px 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .bilan-calculateur-section.section-aa {
            border-left: 4px solid #7c3aed;
        }

        .bilan-calculateur-section.section-tpaa {
            border-left: 4px solid #2563eb;
        }

        .bilan-calc-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .bilan-calc-title {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .bilan-calc-title.title-aa {
            color: #5b21b6;
        }

        .bilan-calc-title.title-tpaa {
            color: #1e40af;
        }

        .bilan-calc-heures {
            font-size: 1.1rem;
            font-weight: 800;
        }

        .bilan-calc-heures.heures-aa {
            color: #7c3aed;
        }

        .bilan-calc-heures.heures-tpaa {
            color: #2563eb;
        }

        .bilan-calc-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .bilan-calc-input-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bilan-calc-input-label {
            font-size: 0.75rem;
            color: #64748b;
        }

        .bilan-calc-input {
            width: 50px;
            padding: 5px 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
        }

        .bilan-calc-input:focus {
            outline: none;
            border-color: #0ea5e9;
        }

        .bilan-calc-stats {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            flex: 1;
            justify-content: flex-end;
        }

        .bilan-calc-stat {
            background: #f8fafc;
            border-radius: 6px;
            padding: 4px 10px;
            text-align: center;
            min-width: 50px;
        }

        .bilan-calc-stat-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: #1e293b;
        }

        .bilan-calc-stat-label {
            font-size: 0.65rem;
            color: #64748b;
        }

        .bilan-calc-stat.highlight-aa {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        .bilan-calc-stat.highlight-aa .bilan-calc-stat-value,
        .bilan-calc-stat.highlight-aa .bilan-calc-stat-label {
            color: white;
        }

        .bilan-calc-stat.highlight-tpaa {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .bilan-calc-stat.highlight-tpaa .bilan-calc-stat-value,
        .bilan-calc-stat.highlight-tpaa .bilan-calc-stat-label {
            color: white;
        }

        /* Sélecteur durée journée (8h/10h/12h) */
        .bilan-duree-selector {
            display: flex;
            gap: 4px;
            margin-left: 10px;
        }

        .bilan-duree-btn {
            padding: 4px 8px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748b;
        }

        .bilan-duree-btn:hover {
            border-color: #94a3b8;
        }

        .bilan-duree-btn.active-aa {
            border-color: #7c3aed;
            background: #7c3aed;
            color: white;
        }

        .bilan-duree-btn.active-tpaa {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
        }

        @media (max-width: 600px) {
            .bilan-calculateurs {
                flex-direction: column;
            }

            .bilan-calculateur-section {
                min-width: 100%;
            }

            .bilan-calc-row {
                flex-direction: column;
                align-items: stretch;
            }

            .bilan-calc-stats {
                justify-content: center;
                margin-top: 8px;
            }
        }

        .bilan-type {
            background: white;
            border-radius: 8px;
            padding: 8px 12px;
            text-align: center;
            min-width: 70px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .bilan-separator {
            width: 1px;
            height: 35px;
            background: #cbd5e1;
            margin: 0 8px;
        }

        .bilan-separator-large {
            width: 2px;
            height: 45px;
            background: #94a3b8;
            margin: 0 15px;
        }

        .bilan-type-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .bilan-type-value {
            font-size: 1.3rem;
            font-weight: 800;
        }

        .bilan-type-aa {
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        }
        .bilan-type-aa .bilan-type-label { color: #7c3aed; }
        .bilan-type-aa .bilan-type-value { color: #5b21b6; }

        .bilan-type-tpaa {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        .bilan-type-tpaa .bilan-type-label { color: #2563eb; }
        .bilan-type-tpaa .bilan-type-value { color: #1e40af; }

        .bilan-type-mixte {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        .bilan-type-mixte .bilan-type-label { color: #d97706; }
        .bilan-type-mixte .bilan-type-value { color: #92400e; }

        .bilan-type-total {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }
        .bilan-type-total .bilan-type-label { color: rgba(255,255,255,0.85); }
        .bilan-type-total .bilan-type-value { color: #ffffff; }

        /* Section title */
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #1e3a5f;
            display: inline-block;
        }

        /* Layout Master-Detail pour Desktop */
        .travaux-master-detail {
            display: none;
        }

        /* Mobile: affichage cartes classique */
        #travauxContainer {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Desktop: layout master-detail */
        @media (min-width: 1024px) {
            #travauxContainer {
                display: none !important;
            }

            .travaux-master-detail {
                display: flex;
                gap: 20px;
                min-height: 600px;
                max-height: calc(100vh - 400px);
            }

            /* Panneau gauche: tableau Excel */
            .travaux-list-panel {
                width: 45%;
                min-width: 400px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .travaux-table-container {
                flex: 1;
                overflow-y: auto;
                scrollbar-width: thin;
                scrollbar-color: #94a3b8 #f1f5f9;
            }

            .travaux-table-container::-webkit-scrollbar {
                width: 10px;
            }

            .travaux-table-container::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 5px;
            }

            .travaux-table-container::-webkit-scrollbar-thumb {
                background: #94a3b8;
                border-radius: 5px;
            }

            .travaux-table-container::-webkit-scrollbar-thumb:hover {
                background: #64748b;
            }

            .travaux-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.85rem;
            }

            .travaux-table thead {
                position: sticky;
                top: 0;
                background: #1e3a5f;
                color: white;
                z-index: 10;
            }

            .travaux-table th {
                padding: 10px 8px;
                text-align: left;
                font-weight: 600;
                font-size: 0.75rem;
                text-transform: uppercase;
                white-space: nowrap;
            }

            .travaux-table td {
                padding: 10px 8px;
                border-bottom: 1px solid #e2e8f0;
                vertical-align: middle;
            }

            .travaux-table tbody tr {
                cursor: pointer;
                transition: background 0.15s;
            }

            .travaux-table tbody tr:hover {
                background: #f1f5f9;
            }

            .travaux-table tbody tr.selected {
                background: #dbeafe;
                border-left: 3px solid #3b82f6;
            }

            .travaux-table .col-ot {
                font-weight: 700;
                color: #1e3a5f;
                width: 70px;
            }

            .travaux-table .col-desc {
                max-width: 250px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .travaux-table .col-heures {
                text-align: center;
                width: 50px;
                font-weight: 600;
            }

            .travaux-table .col-type {
                width: 60px;
            }

            .travaux-table .col-visite {
                width: 40px;
                text-align: center;
            }

            .travaux-table .badge-mini {
                font-size: 0.7rem;
                padding: 2px 6px;
                border-radius: 4px;
            }

            .travaux-table .badge-mini-aa {
                background: #ede9fe;
                color: #6d28d9;
            }

            .travaux-table .badge-mini-tpaa {
                background: #dbeafe;
                color: #1e40af;
            }

            .travaux-table .badge-mini-mixte {
                background: #fef3c7;
                color: #92400e;
            }

            /* Panneau droit: détails */
            .travaux-detail-panel {
                flex: 1;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .detail-panel-header {
                padding: 15px 20px;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
                color: white;
            }

            .detail-panel-header h3 {
                margin: 0;
                font-size: 1.1rem;
            }

            .detail-panel-header .detail-ot {
                background: #f59e0b;
                color: #000;
                padding: 4px 12px;
                border-radius: 4px;
                font-weight: 700;
                display: inline-block;
                margin-bottom: 8px;
            }

            .detail-panel-body {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                scrollbar-width: thin;
                scrollbar-color: #94a3b8 #f1f5f9;
            }

            .detail-panel-body::-webkit-scrollbar {
                width: 10px;
            }

            .detail-panel-body::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 5px;
            }

            .detail-panel-body::-webkit-scrollbar-thumb {
                background: #94a3b8;
                border-radius: 5px;
            }

            .detail-panel-body::-webkit-scrollbar-thumb:hover {
                background: #64748b;
            }

            .detail-empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #94a3b8;
                text-align: center;
                padding: 40px;
            }

            .detail-empty-state .icon {
                font-size: 4rem;
                margin-bottom: 15px;
            }

            .detail-section {
                margin-bottom: 20px;
            }

            .detail-section-title {
                font-size: 0.75rem;
                text-transform: uppercase;
                color: #64748b;
                font-weight: 600;
                margin-bottom: 8px;
                padding-bottom: 5px;
                border-bottom: 1px solid #e2e8f0;
            }

            .detail-info-grid {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .detail-info-item {
                background: #f8fafc;
                padding: 6px 10px;
                border-radius: 6px;
                display: inline-flex;
                align-items: center;
                gap: 6px;
            }

            .detail-info-label {
                font-size: 0.65rem;
                color: #64748b;
                text-transform: uppercase;
            }

            .detail-info-value {
                font-weight: 600;
                color: #1e293b;
                font-size: 0.85rem;
            }

            .detail-description {
                font-size: 0.95rem;
                line-height: 1.4;
                color: #1e293b;
            }

            .detail-photos-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 12px;
            }

            .detail-photo-thumb {
                width: 100%;
                height: 150px;
                object-fit: cover;
                border-radius: 8px;
                cursor: pointer;
                border: 2px solid #e2e8f0;
                transition: all 0.2s;
            }

            .detail-photo-thumb:hover {
                transform: scale(1.05);
                border-color: #3b82f6;
            }

            .detail-comment-box {
                margin-top: 15px;
            }

            .detail-comment-box textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #d1fae5;
                border-radius: 8px;
                font-size: 0.95rem;
                font-family: inherit;
                resize: vertical;
                min-height: 100px;
            }

            .detail-comment-box textarea:focus {
                outline: none;
                border-color: #10b981;
            }
        }

        /* Écrans très larges */
        @media (min-width: 1400px) {
            .travaux-list-panel {
                width: 50%;
            }
        }

        /* Travail card - compact et pleine largeur */
        .travail-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            overflow: hidden;
            border-left: 4px solid #1e3a5f;
            display: flex;
            flex-direction: column;
        }

        .travail-header {
            background: #f8fafc;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .travail-ot {
            background: #1e3a5f;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .travail-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-tpaa {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-aa {
            background: #ede9fe;
            color: #6d28d9;
        }

        .badge-aa-tpaa {
            background: linear-gradient(135deg, #ede9fe 50%, #dbeafe 50%);
            color: #4c1d95;
        }

        .badge-jeudi {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-hors-jeudi {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-priorite-haute {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-priorite-moyenne {
            background: #fef3c7;
            color: #b45309;
        }

        .badge-visite {
            background: #fce7f3;
            color: #be185d;
        }

        /* Case à cocher "À voir sur place" */
        .visite-checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);
            border-radius: 8px;
            margin-top: 12px;
            border: 2px solid #f9a8d4;
            cursor: pointer;
            transition: all 0.2s;
        }

        .visite-checkbox-container:hover {
            border-color: #ec4899;
            background: linear-gradient(135deg, #fbcfe8 0%, #fce7f3 100%);
        }

        .visite-checkbox-container.checked {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            border-color: #be185d;
        }

        .visite-checkbox-container.checked .visite-label {
            color: white;
        }

        .visite-checkbox-container.checked .visite-icon {
            color: white;
        }

        .visite-checkbox {
            width: 24px;
            height: 24px;
            border: 3px solid #ec4899;
            border-radius: 6px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .visite-checkbox-container.checked .visite-checkbox {
            background: white;
            border-color: white;
        }

        .visite-checkbox-check {
            display: none;
            color: #ec4899;
            font-size: 16px;
            font-weight: bold;
        }

        .visite-checkbox-container.checked .visite-checkbox-check {
            display: block;
        }

        .visite-icon {
            font-size: 1.5rem;
            color: #ec4899;
        }

        .visite-label {
            font-weight: 600;
            color: #be185d;
            font-size: 1rem;
        }

        .visite-sublabel {
            font-size: 0.8rem;
            color: #9d174d;
            opacity: 0.8;
        }

        .visite-checkbox-container.checked .visite-sublabel {
            color: rgba(255,255,255,0.9);
        }

        /* Section visite sur place (photos + mesures) */
        .visite-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #fdf2f8;
            border-radius: 10px;
            border: 2px dashed #f9a8d4;
        }

        .visite-section.show {
            display: block;
        }

        .visite-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #be185d;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .visite-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .visite-btn {
            flex: 1;
            min-width: 140px;
            padding: 15px 20px;
            border: 2px solid #ec4899;
            border-radius: 10px;
            background: white;
            color: #be185d;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .visite-btn:hover {
            background: #fce7f3;
            transform: translateY(-2px);
        }

        .visite-btn:active {
            transform: translateY(0);
        }

        .visite-btn-icon {
            font-size: 2rem;
        }

        .visite-btn-label {
            font-size: 0.9rem;
        }

        /* Photos sur place */
        .visite-photos-container {
            margin-top: 12px;
        }

        .visite-photos-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .visite-photo-item {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .visite-photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #f9a8d4;
            cursor: pointer;
        }

        .visite-photo-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mesures sur place */
        .visite-mesures-container {
            margin-top: 12px;
        }

        .visite-mesure-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #f9a8d4;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            background: white;
        }

        .visite-mesure-input:focus {
            outline: none;
            border-color: #ec4899;
        }

        .visite-mesure-input::placeholder {
            color: #d946ef;
            opacity: 0.6;
        }

        /* Mobile optimizations pour visite et utilisation terrain */
        @media (max-width: 600px) {
            .visite-checkbox-container {
                padding: 18px;
            }

            .visite-label {
                font-size: 1.2rem;
            }

            .visite-sublabel {
                font-size: 0.9rem;
            }

            .visite-btn {
                padding: 25px;
                min-width: 100%;
            }

            .visite-btn-icon {
                font-size: 3rem;
            }

            .visite-btn-label {
                font-size: 1.1rem;
            }

            .visite-photo-item {
                width: 90px;
                height: 90px;
            }

            .visite-photo-delete {
                width: 30px;
                height: 30px;
                font-size: 18px;
            }

            .visite-mesure-input {
                font-size: 1.1rem;
                min-height: 100px;
                padding: 15px;
            }

            /* Boutons et inputs plus grands pour le tactile */
            .filter-input, .filter-select {
                padding: 12px 15px;
                font-size: 1rem;
                min-height: 48px;
            }

            .comment-travail-input {
                font-size: 1rem;
                padding: 12px;
                min-height: 100px;
            }

            .btn {
                padding: 15px 25px;
                font-size: 1.1rem;
                min-height: 52px;
            }

            /* Header stats plus compact */
            .header-stats {
                gap: 15px;
            }

            .header-stat-num {
                font-size: 1.5rem;
            }

            /* Info boxes plus lisibles */
            .info-box {
                padding: 10px 14px;
            }

            .info-box-value {
                font-size: 0.95rem;
            }

            /* Toast plus visible */
            .toast {
                bottom: 80px;
                left: 20px;
                right: 20px;
                text-align: center;
                font-size: 1rem;
            }
        }

        /* Très petits écrans */
        @media (max-width: 400px) {
            .portal-header {
                padding: 15px;
            }

            .portal-title h1 {
                font-size: 1.3rem;
            }

            .entreprise-badge {
                font-size: 1rem;
                padding: 8px 15px;
            }

            .visite-actions {
                flex-direction: column;
            }

            .visite-btn {
                min-width: 100%;
            }
        }

        /* Mode paysage mobile - optimisé terrain */
        @media (max-width: 900px) and (orientation: landscape) {
            .visite-actions {
                flex-direction: row;
            }

            .visite-btn {
                min-width: auto;
                flex: 1;
            }
        }

        /* Section upload photos/documents entrepreneur */
        .entrepreneur-uploads-section {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 10px;
            border: 2px solid #bae6fd;
        }

        .uploads-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .uploads-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .upload-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px 15px;
            border: 2px dashed #0ea5e9;
            border-radius: 10px;
            background: white;
            color: #0369a1;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: #e0f2fe;
            border-color: #0284c7;
        }

        .upload-btn .icon {
            font-size: 1.3rem;
        }

        /* Grille photos entrepreneur */
        .entrepreneur-photos-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .entrepreneur-photo-item {
            position: relative;
            width: 90px;
            height: 90px;
        }

        .entrepreneur-photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #0ea5e9;
            cursor: pointer;
        }

        .entrepreneur-photo-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Liste documents entrepreneur */
        .entrepreneur-docs-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .entrepreneur-doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }

        .entrepreneur-doc-icon {
            font-size: 1.5rem;
        }

        .entrepreneur-doc-info {
            flex: 1;
            min-width: 0;
        }

        .entrepreneur-doc-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entrepreneur-doc-size {
            font-size: 0.75rem;
            color: #64748b;
        }

        .entrepreneur-doc-delete {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .entrepreneur-doc-delete:hover {
            background: #fee2e2;
        }

        .entrepreneur-doc-view {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .entrepreneur-doc-view:hover {
            background: #dbeafe;
        }

        /* Mobile uploads */
        @media (max-width: 600px) {
            .uploads-row {
                flex-direction: column;
            }

            .upload-btn {
                min-width: 100%;
                padding: 15px;
            }

            .entrepreneur-photo-item {
                width: 80px;
                height: 80px;
            }

            .entrepreneur-doc-item {
                flex-wrap: wrap;
            }

            .entrepreneur-doc-info {
                width: 100%;
                order: 1;
            }

            .entrepreneur-doc-view,
            .entrepreneur-doc-delete {
                order: 2;
                flex: 1;
                text-align: center;
            }
        }

        .travail-body {
            padding: 12px 15px;
        }

        .travail-description {
            font-size: 1rem;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        /* Grille d'infos - layout horizontal compact */
        .travail-infos {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .info-box {
            background: #f8fafc;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .info-box-label {
            font-size: 0.65rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-box-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: #1e293b;
        }

        /* Layout avec photo à droite */
        .travail-content-wrapper {
            display: flex;
            gap: 20px;
        }

        .travail-card.has-photo .travail-body {
            flex: 1;
            min-width: 0;
        }

        .travail-photo-side {
            flex-shrink: 0;
            width: 220px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-self: stretch;
        }

        .photo-preview {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
            flex: 1;
            min-height: 180px;
        }

        .photo-preview:hover {
            transform: scale(1.02);
            border-color: #1e3a5f;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .more-photos {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .photo-thumb-small {
            width: 68px;
            height: 68px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .photo-thumb-small:hover {
            transform: scale(1.1);
            border-color: #1e3a5f;
        }

        /* Photos - inline (pour compatibilité si pas de layout 2 colonnes) */
        .travail-photos {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .photos-title {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .photos-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .photo-thumb {
            width: 80px;
            height: 80px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .photo-thumb:hover {
            transform: scale(1.05);
            border-color: #1e3a5f;
        }

        /* Mobile : photo en dessous */
        @media (max-width: 600px) {
            .travail-content-wrapper {
                flex-direction: column-reverse;
            }

            .travail-photo-side {
                width: 100%;
                flex-direction: row;
                align-items: center;
            }

            .photo-preview {
                width: 120px;
                height: 90px;
            }

            .more-photos {
                flex: 1;
            }
        }

        /* Documents */
        .travail-documents {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .document-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #eff6ff;
            color: #1e40af;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            margin-right: 10px;
            margin-bottom: 8px;
        }

        .document-link:hover {
            background: #dbeafe;
        }

        /* Commentaire gestionnaire (jaune) */
        .travail-commentaire {
            margin-top: 10px;
            padding: 10px 12px;
            background: #fffbeb;
            border-radius: 6px;
            border-left: 3px solid #f59e0b;
        }

        .commentaire-label {
            font-size: 0.7rem;
            color: #92400e;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .commentaire-text {
            color: #78350f;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Section Type de travail (AA/TPAA + Jour) */
        .travail-type-section {
            margin-top: 12px;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .type-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .type-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .type-separator {
            color: #cbd5e1;
            font-weight: 300;
            margin: 0 4px;
        }

        .badge-large {
            padding: 6px 12px !important;
            font-size: 0.9rem !important;
            font-weight: 600;
        }

        /* Ligne des deux commentaires côte à côte */
        .comments-row {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .comments-row .travail-commentaire {
            flex: 1;
            margin-top: 0;
            display: flex;
            flex-direction: column;
        }

        .comments-row .travail-commentaire .commentaire-text {
            flex: 1;
            min-height: 80px;
        }

        .comments-row .entrepreneur-travail-comment {
            flex: 1;
            margin-top: 0;
            display: flex;
            flex-direction: column;
        }

        /* Commentaire entrepreneur par travail */
        .entrepreneur-travail-comment {
            padding: 10px 12px;
            background: #f0fdf4;
            border-radius: 6px;
            border-left: 3px solid #10b981;
        }

        .entrepreneur-travail-comment .commentaire-label {
            color: #065f46;
            margin-bottom: 8px;
        }

        .comment-travail-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d1fae5;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            flex: 1;
        }

        .comment-travail-input:focus {
            outline: none;
            border-color: #10b981;
        }

        /* Filtres de recherche */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        .filter-input, .filter-select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .filter-count {
            margin-left: auto;
            font-size: 0.9rem;
            color: #64748b;
        }

        @media (max-width: 600px) {
            .comments-row {
                flex-direction: column;
            }

            .filters-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }

            .filter-input, .filter-select {
                width: 100%;
            }
        }

        .comment-travail-input::placeholder {
            color: #94a3b8;
        }

        /* Plan section */
        .plan-section {
            margin-bottom: 30px;
        }

        .plan-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .plan-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .plan-image:hover {
            transform: scale(1.02);
        }

        /* Section commentaire entrepreneur */
        .entrepreneur-comment-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 5px solid #10b981;
        }

        .comment-box {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-box textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .comment-box textarea:focus {
            outline: none;
            border-color: #10b981;
        }

        .comment-box .btn {
            align-self: flex-start;
        }

        .comment-saved {
            color: #10b981;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 5px;
        }

        .comment-saved.show {
            display: flex;
        }

        /* Boutons */
        .actions-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #1e3a5f;
            color: white;
        }

        .btn-primary:hover {
            background: #2d5a87;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        /* Loading */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #1e3a5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #64748b;
            font-size: 1rem;
        }

        /* Error */
        .error-container {
            text-align: center;
            padding: 80px 20px;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 1.5rem;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .error-message {
            color: #64748b;
        }

        /* Photo modal */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .photo-modal.show {
            display: flex;
        }

        .photo-modal img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #ef4444;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-stats {
                justify-content: center;
            }

            .info-banner {
                flex-direction: column;
                text-align: center;
            }

            .travail-infos {
                grid-template-columns: 1fr 1fr;
            }

            .photo-thumb {
                width: 80px;
                height: 80px;
            }
        }

        /* Print styles */
        @media print {
            .portal-header {
                background: #1e3a5f !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .actions-bar {
                display: none;
            }

            .travail-card {
                break-inside: avoid;
            }

            .help-btn {
                display: none !important;
            }
        }

        /* Bouton d'aide flottant */
        .help-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            z-index: 999;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .help-btn:active {
            transform: scale(0.95);
        }

        /* Modal d'aide */
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
            overflow-y: auto;
        }

        .help-modal.show {
            display: flex;
        }

        .help-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .help-modal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .help-modal-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .help-modal-header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .help-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .help-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .help-modal-body {
            padding: 30px;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .help-section-title .icon {
            font-size: 1.5rem;
        }

        .help-text {
            color: #475569;
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .help-text p {
            margin-bottom: 12px;
        }

        .help-text ul {
            margin: 12px 0;
            padding-left: 25px;
        }

        .help-text li {
            margin-bottom: 8px;
        }

        .help-highlight {
            background: #fef3c7;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #f59e0b;
            margin: 15px 0;
        }

        .help-highlight-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
        }

        .help-tip {
            background: #ecfdf5;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #10b981;
            margin: 15px 0;
        }

        .help-tip-title {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 8px;
        }

        .help-warning {
            background: #fef2f2;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #ef4444;
            margin: 15px 0;
        }

        .help-warning-title {
            font-weight: 600;
            color: #b91c1c;
            margin-bottom: 8px;
        }

        .help-feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .help-feature-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .help-feature-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .help-feature-card h4 {
            color: #1e3a5f;
            margin-bottom: 8px;
        }

        .help-feature-card p {
            font-size: 0.85rem;
            color: #64748b;
        }

        .help-step {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .help-step-num {
            background: #1e3a5f;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .help-step-content h4 {
            color: #1e293b;
            margin-bottom: 5px;
        }

        .help-step-content p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .help-badge-demo {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 3px;
        }

        .help-badge-demo.visite {
            background: #fce7f3;
            color: #be185d;
        }

        .help-badge-demo.aa {
            background: #ede9fe;
            color: #6d28d9;
        }

        .help-badge-demo.tpaa {
            background: #dbeafe;
            color: #1e40af;
        }

        .help-badge-demo.jeudi {
            background: #fef3c7;
            color: #92400e;
        }

        /* Mobile pour aide */
        @media (max-width: 600px) {
            .help-btn {
                bottom: 20px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.6rem;
            }

            .help-modal-content {
                max-height: 95vh;
                margin: 10px;
            }

            .help-modal-header {
                padding: 20px;
            }

            .help-modal-header h2 {
                font-size: 1.3rem;
            }

            .help-modal-body {
                padding: 20px;
            }

            .help-section-title {
                font-size: 1.1rem;
            }

            .help-feature-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p class="loading-text">Chargement du portail...</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Bouton d'aide flottant -->
    <button class="help-btn" onclick="PortailEntrepreneur.openHelp()" title="Aide et guide d'utilisation">?</button>

    <!-- Modal d'aide -->
    <div class="help-modal" id="helpModal" onclick="PortailEntrepreneur.closeHelpOnBackdrop(event)">
        <div class="help-modal-content" onclick="event.stopPropagation()">
            <div class="help-modal-header">
                <h2>Guide d'utilisation du portail</h2>
                <p>Tout ce que vous devez savoir pour bien utiliser ce portail</p>
                <button class="help-modal-close" onclick="PortailEntrepreneur.closeHelp()">&times;</button>
            </div>
            <div class="help-modal-body">
                <!-- Section 1: Apercu -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">📋</span> Qu'est-ce que ce portail ?</h3>
                    <div class="help-text">
                        <p>Ce portail vous permet de consulter les travaux pour lesquels une soumission est demandee et d'y repondre directement en ligne.</p>

                        <div class="help-feature-grid">
                            <div class="help-feature-card">
                                <div class="icon">📄</div>
                                <h4>Consulter</h4>
                                <p>Voir tous les details des travaux a soumissionner</p>
                            </div>
                            <div class="help-feature-card">
                                <div class="icon">💬</div>
                                <h4>Commenter</h4>
                                <p>Ajouter vos remarques et questions</p>
                            </div>
                            <div class="help-feature-card">
                                <div class="icon">📍</div>
                                <h4>Planifier</h4>
                                <p>Marquer les travaux a voir sur place</p>
                            </div>
                            <div class="help-feature-card">
                                <div class="icon">📷</div>
                                <h4>Documenter</h4>
                                <p>Prendre des photos et notes sur le terrain</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: En-tete -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">🔝</span> L'en-tete du portail</h3>
                    <div class="help-text">
                        <p>L'en-tete affiche les informations principales :</p>
                        <ul>
                            <li><strong>Nom de votre entreprise</strong> - Badge orange avec le nom de l'entrepreneur</li>
                            <li><strong>Nombre de travaux</strong> - Combien de travaux sont inclus dans cet appel</li>
                            <li><strong>Heures estimees</strong> - Total des heures estimees pour l'ensemble</li>
                            <li><strong>Visites</strong> - Nombre de travaux marques "a voir sur place"</li>
                        </ul>

                        <div class="help-highlight">
                            <div class="help-highlight-title">Date limite</div>
                            Si une date limite est definie, elle s'affiche dans un encadre jaune. Assurez-vous de completer votre soumission avant cette date.
                        </div>
                    </div>
                </div>

                <!-- Section 3: Filtres -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">🔍</span> Les filtres de recherche</h3>
                    <div class="help-text">
                        <p>Utilisez les filtres pour trouver rapidement les travaux qui vous interessent :</p>
                        <ul>
                            <li><strong>Recherche</strong> - Tapez un mot-cle (OT, description, equipement)</li>
                            <li><strong>Equipement</strong> - Filtrer par equipement specifique</li>
                            <li><strong>Type</strong> - AA (Arret Annuel), TPAA, ou les deux</li>
                            <li><strong>Jour</strong> - Jeudi d'arret ou Hors jeudi</li>
                            <li><strong>Visite sur place</strong> - Voir uniquement les travaux a visiter</li>
                        </ul>

                        <div class="help-tip">
                            <div class="help-tip-title">Astuce terrain</div>
                            Utilisez le filtre "A voir sur place" quand vous etes sur le site pour voir uniquement les travaux que vous devez inspecter.
                        </div>
                    </div>
                </div>

                <!-- Section 4: Cartes de travaux -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">📝</span> Les cartes de travaux</h3>
                    <div class="help-text">
                        <p>Chaque travail est presente dans une carte contenant :</p>
                        <ul>
                            <li><strong>Numero OT</strong> - Identifiant du bon de travail (en haut a gauche)</li>
                            <li><strong>Description</strong> - Detail du travail a realiser</li>
                            <li><strong>Informations</strong> - Equipement, operation, heures, localisation</li>
                            <li><strong>Photos</strong> - Images fournies par le gestionnaire (si disponibles)</li>
                            <li><strong>Type et Jour</strong> - Quand le travail doit etre fait</li>
                        </ul>

                        <p><strong>Badges de statut :</strong></p>
                        <div style="margin: 10px 0;">
                            <span class="help-badge-demo aa">AA</span>
                            <span class="help-badge-demo tpaa">TPAA</span>
                            <span class="help-badge-demo jeudi">Jeudi</span>
                            <span class="help-badge-demo visite">A voir sur place</span>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Commentaires -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">💬</span> Les commentaires</h3>
                    <div class="help-text">
                        <p>Deux types de commentaires sont disponibles :</p>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #f59e0b;">1</div>
                            <div class="help-step-content">
                                <h4>Note du gestionnaire (jaune)</h4>
                                <p>Informations importantes du gestionnaire concernant ce travail specifique. Lisez-les attentivement.</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #10b981;">2</div>
                            <div class="help-step-content">
                                <h4>Votre commentaire (vert)</h4>
                                <p>Zone pour ajouter vos remarques, questions ou informations de prix pour ce travail.</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #1e3a5f;">3</div>
                            <div class="help-step-content">
                                <h4>Commentaire global (en bas)</h4>
                                <p>Section pour vos remarques generales sur l'ensemble de la soumission.</p>
                            </div>
                        </div>

                        <div class="help-warning">
                            <div class="help-warning-title">Important</div>
                            N'oubliez pas de cliquer sur "Enregistrer le commentaire" pour sauvegarder vos remarques globales.
                        </div>
                    </div>
                </div>

                <!-- Section 6: Visite sur place -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">📍</span> Fonction "A voir sur place"</h3>
                    <div class="help-text">
                        <p>Cette fonction vous permet de marquer les travaux que vous devez visiter physiquement avant de soumettre votre offre.</p>

                        <div class="help-step">
                            <div class="help-step-num">1</div>
                            <div class="help-step-content">
                                <h4>Cocher la case</h4>
                                <p>Cliquez sur la zone rose "A voir sur place" pour marquer un travail. Un badge apparaitra sur la carte.</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num">2</div>
                            <div class="help-step-content">
                                <h4>Prendre des photos</h4>
                                <p>Une fois coche, vous pouvez prendre des photos directement avec votre telephone (jusqu'a 10 par travail).</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num">3</div>
                            <div class="help-step-content">
                                <h4>Noter vos mesures</h4>
                                <p>Utilisez la zone de texte pour noter vos mesures, observations et remarques prises sur le terrain.</p>
                            </div>
                        </div>

                        <div class="help-tip">
                            <div class="help-tip-title">Utilisation sur mobile</div>
                            Cette fonction est optimisee pour le terrain. Sur votre telephone, le bouton "Prendre photo" ouvrira directement l'appareil photo.
                        </div>
                    </div>
                </div>

                <!-- Section 7: Upload photos et documents -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">📎</span> Ajouter des pieces jointes</h3>
                    <div class="help-text">
                        <p>Pour chaque travail, vous pouvez joindre des photos et des documents :</p>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #0ea5e9;">1</div>
                            <div class="help-step-content">
                                <h4>Ajouter des photos</h4>
                                <p>Cliquez sur "Ajouter photos" pour selectionner plusieurs images depuis votre appareil (jusqu'a 20 par travail).</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #0ea5e9;">2</div>
                            <div class="help-step-content">
                                <h4>Ajouter des documents</h4>
                                <p>Cliquez sur "Ajouter documents" pour joindre des fichiers PDF, Word, Excel ou texte (jusqu'a 10 par travail, max 5MB chacun).</p>
                            </div>
                        </div>

                        <div class="help-tip">
                            <div class="help-tip-title">Formats acceptes</div>
                            <ul style="margin-top: 8px;">
                                <li><strong>Photos</strong> : JPG, PNG, GIF et autres formats image</li>
                                <li><strong>Documents</strong> : PDF, DOC, DOCX, XLS, XLSX, TXT</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Section 8: Export -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">📄</span> Export et impression</h3>
                    <div class="help-text">
                        <p>En bas de page, vous trouverez deux options :</p>
                        <ul>
                            <li><strong>Exporter en PDF</strong> - Genere un document PDF avec tous les travaux</li>
                            <li><strong>Imprimer</strong> - Ouvre la fenetre d'impression de votre navigateur</li>
                        </ul>
                    </div>
                </div>

                <!-- Section 9: Sauvegarde et synchronisation -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">💾</span> Sauvegarde et synchronisation</h3>
                    <div class="help-text">
                        <div class="help-tip">
                            <div class="help-tip-title">Synchronisation temps reel!</div>
                            Toutes les modifications sont synchronisees instantanement entre tous les appareils :
                            <ul style="margin-top: 10px;">
                                <li>Les cases "A voir sur place" - mise a jour immediate</li>
                                <li>Les photos et documents - visibles instantanement</li>
                                <li>Les notes de terrain - synchronisees en temps reel</li>
                                <li>Commentaires - partages entre mobile et ordinateur</li>
                            </ul>
                        </div>
                        <div class="help-highlight">
                            <div class="help-highlight-title">Indicateur de synchronisation</div>
                            Un indicateur vert "Synchronise" apparait en haut de l'ecran. Quand une modification arrive d'un autre appareil, vous verrez "Mise a jour recue".
                        </div>
                        <p>Vous pouvez travailler sur plusieurs appareils simultanement - les changements sont visibles partout en temps reel.</p>
                    </div>
                </div>

                <!-- Section 9: Support -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">🆘</span> Besoin d'aide ?</h3>
                    <div class="help-text">
                        <p>Si vous rencontrez des difficultes ou avez des questions concernant les travaux :</p>
                        <ul>
                            <li>Utilisez le champ commentaire pour poser vos questions</li>
                            <li>Contactez le gestionnaire qui vous a envoye ce lien</li>
                        </ul>

                        <div class="help-highlight">
                            <div class="help-highlight-title">Rappel</div>
                            Ce portail est accessible uniquement via le lien unique qui vous a ete envoye. Conservez ce lien pour pouvoir y revenir.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="photo-modal" id="photoModal" onclick="PortailEntrepreneur.closePhotoModal()">
        <button class="photo-modal-close" onclick="PortailEntrepreneur.closePhotoModal()">&times;</button>
        <img id="photoModalImg" src="" alt="Photo">
    </div>

    <script src="firebase.js"></script>
    <script>
        const PortailEntrepreneur = {
            appelId: null,
            appelData: null,
            entreprise: null,
            travaux: [],
            unsubscribeCommentaires: null, // Listener temps réel
            isUpdatingFromServer: false, // Flag pour éviter les boucles

            async init() {
                const params = new URLSearchParams(window.location.search);
                this.appelId = params.get('id');

                if (!this.appelId) {
                    this.showError('Lien invalide', 'Ce lien de soumission n\'est pas valide.');
                    return;
                }

                try {
                    await this.loadAppelData();
                    // Démarrer l'écoute temps réel
                    this.startRealtimeSync();
                } catch (error) {
                    console.error('Erreur:', error);
                    this.showError('Erreur de chargement', 'Impossible de charger les données.');
                }
            },

            async loadAppelData() {
                const doc = await firebase.firestore().collection('appels_soumission').doc(this.appelId).get();

                if (!doc.exists) {
                    this.showError('Appel non trouvé', 'Cet appel de soumission n\'existe pas ou a expiré.');
                    return;
                }

                this.appelData = doc.data();
                this.entreprise = this.appelData.entreprise;
                this.travaux = this.appelData.travaux || [];

                // Charger le commentaire entrepreneur s'il existe
                await this.loadCommentaireEntrepreneur();

                this.render();
            },

            // ========== SYNCHRONISATION TEMPS RÉEL ==========

            startRealtimeSync() {
                // Écouter les changements sur le document commentaires_entrepreneurs
                this.unsubscribeCommentaires = firebase.firestore()
                    .collection('commentaires_entrepreneurs')
                    .doc(this.appelId)
                    .onSnapshot((doc) => {
                        if (doc.exists && !this.isUpdatingFromServer) {
                            const data = doc.data();
                            this.handleRealtimeUpdate(data);
                        }
                    }, (error) => {
                        console.error('Erreur sync temps réel:', error);
                    });

                // Afficher indicateur de connexion
                this.showSyncStatus('connected');
            },

            handleRealtimeUpdate(data) {
                // Comparer et mettre à jour seulement si différent
                const newCommentaire = data.commentaire || '';
                const newCommentairesTravaux = data.commentairesTravaux || [];
                const newVisitesData = data.visitesData || [];
                const newUploadsData = data.uploadsData || [];

                let hasChanges = false;

                // Vérifier si le commentaire global a changé
                if (newCommentaire !== this.commentaireEntrepreneur) {
                    this.commentaireEntrepreneur = newCommentaire;
                    const textarea = document.getElementById('commentaireEntrepreneur');
                    if (textarea && document.activeElement !== textarea) {
                        textarea.value = newCommentaire;
                    }
                    hasChanges = true;
                }

                // Vérifier les commentaires par travail
                if (JSON.stringify(newCommentairesTravaux) !== JSON.stringify(this.commentairesTravaux)) {
                    this.commentairesTravaux = newCommentairesTravaux;
                    newCommentairesTravaux.forEach((comment, index) => {
                        const textarea = document.getElementById(`comment-travail-${index}`);
                        if (textarea && document.activeElement !== textarea) {
                            textarea.value = comment || '';
                        }
                    });
                    hasChanges = true;
                }

                // Vérifier les données de visite
                if (JSON.stringify(newVisitesData) !== JSON.stringify(this.visitesData)) {
                    this.visitesData = newVisitesData;
                    this.updateAllVisitesUI();
                    hasChanges = true;
                }

                // Vérifier les uploads
                if (JSON.stringify(newUploadsData) !== JSON.stringify(this.uploadsData)) {
                    this.uploadsData = newUploadsData;
                    this.updateAllUploadsUI();
                    hasChanges = true;
                }

                if (hasChanges) {
                    this.showSyncNotification();
                    this.updateVisitesCounter();
                }
            },

            updateAllVisitesUI() {
                this.travaux.forEach((t, index) => {
                    const container = document.getElementById(`visite-container-${index}`);
                    const section = document.getElementById(`visite-section-${index}`);
                    const card = document.querySelector(`.travail-card[data-index="${index}"]`);
                    const isChecked = this.visitesData[index]?.aVoirSurPlace || false;

                    if (container) {
                        container.classList.toggle('checked', isChecked);
                    }
                    if (section) {
                        section.classList.toggle('show', isChecked);
                    }

                    // Badge
                    const badgesDiv = card?.querySelector('.travail-badges');
                    if (badgesDiv) {
                        const existingBadge = badgesDiv.querySelector('.badge-visite');
                        if (isChecked && !existingBadge) {
                            badgesDiv.innerHTML = '<span class="badge badge-visite">📍 À voir sur place</span>' + badgesDiv.innerHTML;
                        } else if (!isChecked && existingBadge) {
                            existingBadge.remove();
                        }
                    }

                    // Photos visite
                    this.updateVisitePhotosUI(index);

                    // Mesures
                    const mesuresInput = document.getElementById(`visite-mesures-${index}`);
                    if (mesuresInput && document.activeElement !== mesuresInput) {
                        mesuresInput.value = this.visitesData[index]?.mesures || '';
                    }
                });
            },

            updateAllUploadsUI() {
                this.travaux.forEach((t, index) => {
                    this.updateEntrepreneurPhotosUI(index);
                    this.updateEntrepreneurDocsUI(index);
                });
            },

            showSyncStatus(status) {
                // Créer indicateur si n'existe pas
                let indicator = document.getElementById('syncIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'syncIndicator';
                    indicator.style.cssText = `
                        position: fixed;
                        top: 10px;
                        left: 50%;
                        transform: translateX(-50%);
                        padding: 6px 15px;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        font-weight: 600;
                        z-index: 1000;
                        transition: all 0.3s;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    `;
                    document.body.appendChild(indicator);
                }

                if (status === 'connected') {
                    indicator.innerHTML = '🟢 Synchronisé';
                    indicator.style.background = '#d1fae5';
                    indicator.style.color = '#065f46';
                    // Masquer après 3 secondes
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                    }, 3000);
                }
            },

            showSyncNotification() {
                const indicator = document.getElementById('syncIndicator');
                if (indicator) {
                    indicator.innerHTML = '🔄 Mise à jour reçue';
                    indicator.style.background = '#dbeafe';
                    indicator.style.color = '#1e40af';
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.innerHTML = '🟢 Synchronisé';
                        indicator.style.background = '#d1fae5';
                        indicator.style.color = '#065f46';
                        setTimeout(() => {
                            indicator.style.opacity = '0';
                        }, 2000);
                    }, 1500);
                }
            },

            // Arrêter l'écoute quand on quitte la page
            stopRealtimeSync() {
                if (this.unsubscribeCommentaires) {
                    this.unsubscribeCommentaires();
                    this.unsubscribeCommentaires = null;
                }
            },

            showError(title, message) {
                document.getElementById('app').innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">❌</div>
                        <h1 class="error-title">${title}</h1>
                        <p class="error-message">${message}</p>
                    </div>
                `;
            },

            render() {
                const totalHeures = this.travaux.reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const heuresAA = this.travaux.filter(t => t.typeTravail === 'aa').reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const heuresTPAA = this.travaux.filter(t => t.typeTravail === 'tpaa').reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const heuresAAouTPAA = this.travaux.filter(t => t.typeTravail === 'aa-tpaa').reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const dateLimite = this.appelData.dateLimite ? new Date(this.appelData.dateLimite) : null;
                const nbVisites = this.visitesData.filter(v => v?.aVoirSurPlace).length;

                document.getElementById('app').innerHTML = `
                    <header class="portal-header">
                        <div class="header-content">
                            <div class="portal-title">
                                <h1>📋 Appel de Soumission</h1>
                                <p>${this.appelData.nomArret || 'Arrêt Annuel'}</p>
                            </div>
                            <span class="entreprise-badge">${this.entreprise}</span>
                            <div class="header-stats">
                                <div class="header-stat">
                                    <div class="header-stat-num">${this.travaux.length}</div>
                                    <div class="header-stat-label">Travaux</div>
                                </div>
                                <div class="header-stat">
                                    <div class="header-stat-num">${totalHeures}h</div>
                                    <div class="header-stat-label">Estimées</div>
                                </div>
                                <div class="header-stat" id="header-visites" style="color: ${nbVisites > 0 ? '#fce7f3' : 'inherit'}">
                                    <div class="header-stat-num">${nbVisites}</div>
                                    <div class="header-stat-label">📍 Visites</div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main class="portal-content">
                        <div class="info-banner">
                            <div class="info-banner-left">
                                <div class="info-banner-icon">📄</div>
                                <div>
                                    <h2>Liste des travaux à soumissionner</h2>
                                    <p>Veuillez consulter les détails ci-dessous et soumettre votre offre.</p>
                                </div>
                            </div>
                            <div class="header-actions">
                                ${dateLimite ? `
                                    <div class="date-limite">
                                        <div class="date-limite-label">Date limite</div>
                                        <div class="date-limite-value">${dateLimite.toLocaleDateString('fr-CA')}</div>
                                    </div>
                                ` : ''}
                                <button class="btn btn-pdf" onclick="PortailEntrepreneur.exportPDF()">
                                    Exporter PDF
                                </button>
                                <button class="btn btn-visite-pdf" onclick="PortailEntrepreneur.exportPDFVisites()">
                                    📍 PDF Visites terrain
                                </button>
                            </div>
                        </div>

                        <!-- Bilan des heures -->
                        <div class="bilan-heures">
                            <div class="bilan-heures-title">
                                <span>Calculateur de charge de travail</span>
                            </div>

                            <!-- Ligne unique avec types à gauche et stats à droite -->
                            <!-- Résumé des heures par type -->
                            <div class="bilan-ligne-complete">
                                <div class="bilan-type bilan-type-aa">
                                    <div class="bilan-type-label">Arret Annuel</div>
                                    <div class="bilan-type-value">${heuresAA}h</div>
                                </div>
                                <div class="bilan-separator"></div>
                                <div class="bilan-type bilan-type-tpaa">
                                    <div class="bilan-type-label">TPAA</div>
                                    <div class="bilan-type-value">${heuresTPAA}h</div>
                                </div>
                                ${heuresAAouTPAA > 0 ? `
                                <div class="bilan-separator"></div>
                                <div class="bilan-type bilan-type-mixte">
                                    <div class="bilan-type-label">AA ou TPAA</div>
                                    <div class="bilan-type-value">${heuresAAouTPAA}h</div>
                                </div>
                                ` : ''}
                                <div class="bilan-separator"></div>
                                <div class="bilan-type bilan-type-total">
                                    <div class="bilan-type-label">TOTAL</div>
                                    <div class="bilan-type-value">${totalHeures}h</div>
                                </div>
                            </div>

                            <!-- Calculateurs séparés AA et TPAA -->
                            <div class="bilan-calculateurs">
                                <!-- Calculateur AA -->
                                <div class="bilan-calculateur-section section-aa">
                                    <div class="bilan-calc-header">
                                        <span class="bilan-calc-title title-aa">Arrêt Annuel</span>
                                        <span class="bilan-calc-heures heures-aa">${heuresAA}h</span>
                                    </div>
                                    <div class="bilan-calc-row">
                                        <div class="bilan-calc-input-group">
                                            <span class="bilan-calc-input-label">Tech.</span>
                                            <input type="number" class="bilan-calc-input" id="bilanTechAA" value="1" min="1" max="50" onchange="PortailEntrepreneur.calculerBilan()">
                                        </div>
                                        <div class="bilan-duree-selector" id="dureeAA">
                                            <button class="bilan-duree-btn active-aa" data-duree="8" onclick="PortailEntrepreneur.setDureeJour('AA', 8)">8h</button>
                                            <button class="bilan-duree-btn" data-duree="10" onclick="PortailEntrepreneur.setDureeJour('AA', 10)">10h</button>
                                            <button class="bilan-duree-btn" data-duree="12" onclick="PortailEntrepreneur.setDureeJour('AA', 12)">12h</button>
                                        </div>
                                        <div class="bilan-calc-stats">
                                            <div class="bilan-calc-stat">
                                                <div class="bilan-calc-stat-value" id="bilanHeuresParTechAA">${heuresAA}</div>
                                                <div class="bilan-calc-stat-label">h/tech</div>
                                            </div>
                                            <div class="bilan-calc-stat highlight-aa">
                                                <div class="bilan-calc-stat-value" id="bilanJourneesAA">${Math.floor(heuresAA / 8)}</div>
                                                <div class="bilan-calc-stat-label">jours</div>
                                            </div>
                                            <div class="bilan-calc-stat">
                                                <div class="bilan-calc-stat-value" id="bilanResteAA">${heuresAA % 8}</div>
                                                <div class="bilan-calc-stat-label">h rest.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Calculateur TPAA -->
                                <div class="bilan-calculateur-section section-tpaa">
                                    <div class="bilan-calc-header">
                                        <span class="bilan-calc-title title-tpaa">TPAA</span>
                                        <span class="bilan-calc-heures heures-tpaa">${heuresTPAA}h</span>
                                    </div>
                                    <div class="bilan-calc-row">
                                        <div class="bilan-calc-input-group">
                                            <span class="bilan-calc-input-label">Tech.</span>
                                            <input type="number" class="bilan-calc-input" id="bilanTechTPAA" value="1" min="1" max="50" onchange="PortailEntrepreneur.calculerBilan()">
                                        </div>
                                        <div class="bilan-duree-selector" id="dureeTPAA">
                                            <button class="bilan-duree-btn active-tpaa" data-duree="8" onclick="PortailEntrepreneur.setDureeJour('TPAA', 8)">8h</button>
                                            <button class="bilan-duree-btn" data-duree="10" onclick="PortailEntrepreneur.setDureeJour('TPAA', 10)">10h</button>
                                            <button class="bilan-duree-btn" data-duree="12" onclick="PortailEntrepreneur.setDureeJour('TPAA', 12)">12h</button>
                                        </div>
                                        <div class="bilan-calc-stats">
                                            <div class="bilan-calc-stat">
                                                <div class="bilan-calc-stat-value" id="bilanHeuresParTechTPAA">${heuresTPAA}</div>
                                                <div class="bilan-calc-stat-label">h/tech</div>
                                            </div>
                                            <div class="bilan-calc-stat highlight-tpaa">
                                                <div class="bilan-calc-stat-value" id="bilanJourneesTPAA">${Math.floor(heuresTPAA / 8)}</div>
                                                <div class="bilan-calc-stat-label">jours</div>
                                            </div>
                                            <div class="bilan-calc-stat">
                                                <div class="bilan-calc-stat-value" id="bilanResteTPAA">${heuresTPAA % 8}</div>
                                                <div class="bilan-calc-stat-label">h rest.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${this.appelData.planImage ? `
                            <div class="plan-section">
                                <h2 class="section-title">🗺️ Plan de localisation</h2>
                                <div class="plan-container">
                                    <img src="${this.appelData.planImage}" alt="Plan" class="plan-image" onclick="PortailEntrepreneur.showPhoto('${this.appelData.planImage}')">
                                </div>
                            </div>
                        ` : ''}

                        <h2 class="section-title">📋 Travaux (${this.travaux.length})</h2>

                        <!-- Filtres de recherche -->
                        <div class="filters-section">
                            <div class="filter-group">
                                <span class="filter-label">Recherche</span>
                                <input type="text" class="filter-input" id="filterSearch" placeholder="OT, description..." oninput="PortailEntrepreneur.filterTravaux()">
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Équipement</span>
                                <select class="filter-select" id="filterEquipement" onchange="PortailEntrepreneur.filterTravaux()">
                                    <option value="">Tous</option>
                                    ${[...new Set(this.travaux.map(t => t.equipement).filter(Boolean))].sort().map(e => `<option value="${e}">${e}</option>`).join('')}
                                </select>
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Type</span>
                                <select class="filter-select" id="filterType" onchange="PortailEntrepreneur.filterTravaux()">
                                    <option value="">Tous</option>
                                    <option value="aa">AA (Arrêt Annuel)</option>
                                    <option value="tpaa">TPAA</option>
                                    <option value="aa-tpaa">AA ou TPAA</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Jour</span>
                                <select class="filter-select" id="filterJour" onchange="PortailEntrepreneur.filterTravaux()">
                                    <option value="">Tous</option>
                                    <option value="jeudi">Jeudi d'arrêt</option>
                                    <option value="hors-jeudi">Hors jeudi</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Visite sur place</span>
                                <select class="filter-select" id="filterVisite" onchange="PortailEntrepreneur.filterTravaux()">
                                    <option value="">Tous</option>
                                    <option value="oui">À voir sur place</option>
                                    <option value="non">Sans visite</option>
                                </select>
                            </div>
                            <span class="filter-count" id="filterCount">${this.travaux.length} travaux</span>
                        </div>

                        <!-- Layout Master-Detail pour Desktop -->
                        <div class="travaux-master-detail">
                            <!-- Panneau gauche: tableau -->
                            <div class="travaux-list-panel">
                                <div class="travaux-table-container">
                                    <table class="travaux-table">
                                        <thead>
                                            <tr>
                                                <th>OT</th>
                                                <th>Description</th>
                                                <th>Équip.</th>
                                                <th>Heures</th>
                                                <th>Type</th>
                                                <th>📍</th>
                                            </tr>
                                        </thead>
                                        <tbody id="travauxTableBody">
                                            ${this.travaux.map((t, i) => this.renderTravailRow(t, i)).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Panneau droit: détails -->
                            <div class="travaux-detail-panel">
                                <div id="travailDetailContent">
                                    <div class="detail-empty-state">
                                        <div class="icon">👈</div>
                                        <p>Sélectionnez un travail dans la liste pour voir ses détails</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Layout Mobile: cartes classiques -->
                        <div id="travauxContainer">
                            ${this.travaux.map((t, i) => this.renderTravailCard(t, i)).join('')}
                        </div>

                        <!-- Section commentaire entrepreneur -->
                        <div class="entrepreneur-comment-section">
                            <h2 class="section-title">💬 Votre commentaire</h2>
                            <div class="comment-box">
                                <textarea id="commentaireEntrepreneur"
                                          placeholder="Ajoutez vos remarques, questions ou commentaires ici..."
                                          rows="4">${this.commentaireEntrepreneur || ''}</textarea>
                                <button class="btn btn-primary" onclick="PortailEntrepreneur.sauvegarderCommentaire()">
                                    💾 Enregistrer le commentaire
                                </button>
                            </div>
                        </div>

                        <div class="actions-bar">
                            <button class="btn btn-secondary" onclick="window.print()">
                                Imprimer
                            </button>
                        </div>
                    </main>
                `;
            },

            renderTravailCard(travail, index) {
                // Type de travail : AA, TPAA ou AA ou TPAA (depuis la colonne Type)
                const isTypeAA = travail.typeTravail === 'aa';
                const isTypeTPAA = travail.typeTravail === 'tpaa';
                const isTypeAaOuTpaa = travail.typeTravail === 'aa-tpaa';

                // Jour : Jeudi ou Hors Jeudi (depuis la colonne Jour)
                const isJeudi = travail.jourArret === 'jeudi';
                const isHorsJeudi = travail.jourArret === 'hors-jeudi';

                const hasPhotos = travail.photos && travail.photos.length > 0;

                const aVoirSurPlace = this.visitesData[index]?.aVoirSurPlace || false;

                return `
                    <div class="travail-card ${hasPhotos ? 'has-photo' : ''}" data-index="${index}">
                        <div class="travail-header">
                            <span class="travail-ot">${travail.ot || `#${index + 1}`}</span>
                            <div class="travail-badges">
                                ${aVoirSurPlace ? '<span class="badge badge-visite">📍 À voir sur place</span>' : ''}
                            </div>
                        </div>

                        <div class="travail-content-wrapper">
                            <!-- Colonne gauche : infos -->
                            <div class="travail-body">
                                <div class="travail-description">${travail.description || 'Aucune description'}</div>

                                <div class="travail-infos">
                                    <div class="info-box">
                                        <div class="info-box-label">Équipement</div>
                                        <div class="info-box-value">${travail.equipement || '-'}</div>
                                    </div>
                                    <div class="info-box">
                                        <div class="info-box-label">Opération</div>
                                        <div class="info-box-value">${travail.operation || '-'}</div>
                                    </div>
                                    <div class="info-box">
                                        <div class="info-box-label">Heures estimées</div>
                                        <div class="info-box-value">${travail.estimationHeures || '-'} h</div>
                                    </div>
                                    <div class="info-box">
                                        <div class="info-box-label">Secteur / Localisation</div>
                                        <div class="info-box-value">${travail.localisation || travail.secteur || '-'}</div>
                                    </div>
                                    ${travail.conditions ? `
                                    <div class="info-box">
                                        <div class="info-box-label">Conditions</div>
                                        <div class="info-box-value">${travail.conditions}</div>
                                    </div>
                                    ` : ''}
                                </div>

                                ${(travail.documents && travail.documents.length > 0) ? `
                                    <div class="travail-documents">
                                        <div class="photos-title">📎 Documents</div>
                                        ${travail.documents.map(d => `
                                            <a href="${d.url}" target="_blank" class="document-link">
                                                📄 ${d.nom || 'Document'}
                                            </a>
                                        `).join('')}
                                    </div>
                                ` : ''}

                                <!-- Type de travail (AA/TPAA + Jour) sur une seule ligne -->
                                ${(isTypeAA || isTypeTPAA || isTypeAaOuTpaa) ? `
                                    <div class="travail-type-section">
                                        <div class="type-row">
                                            <span class="type-label">Doit être fait pendant :</span>
                                            ${isTypeAA ? '<span class="badge badge-aa badge-large">🔧 Arrêt Annuel</span>' : ''}
                                            ${isTypeTPAA ? '<span class="badge badge-tpaa badge-large">📋 TPAA</span>' : ''}
                                            ${isTypeAaOuTpaa ? '<span class="badge badge-aa-tpaa badge-large">🔧📋 AA ou TPAA</span>' : ''}
                                            ${(isTypeTPAA || isTypeAaOuTpaa) && (isJeudi || isHorsJeudi) ? `
                                                <span class="type-separator">—</span>
                                                <span class="type-label">Durant :</span>
                                                ${isJeudi ? '<span class="badge badge-jeudi badge-large">🗓️ Jeudi d\'arrêt</span>' : ''}
                                                ${isHorsJeudi ? '<span class="badge badge-hors-jeudi badge-large">✓ Hors jeudi</span>' : ''}
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Commentaires côte à côte : gestionnaire (jaune) + entrepreneur (vert) -->
                                <div class="comments-row">
                                    ${travail.commentaire ? `
                                        <div class="travail-commentaire">
                                            <div class="commentaire-label">💬 Note du gestionnaire</div>
                                            <div class="commentaire-text">${travail.commentaire}</div>
                                        </div>
                                    ` : ''}
                                    <div class="entrepreneur-travail-comment">
                                        <div class="commentaire-label">✏️ Votre commentaire</div>
                                        <textarea class="comment-travail-input"
                                                  id="comment-travail-${index}"
                                                  data-travail-index="${index}"
                                                  placeholder="Remarques, questions ou prix..."
                                                  rows="2">${this.commentairesTravaux[index] || ''}</textarea>
                                    </div>
                                </div>

                                <!-- Case à cocher "À voir sur place" -->
                                <div class="visite-checkbox-container ${this.visitesData[index]?.aVoirSurPlace ? 'checked' : ''}"
                                     onclick="PortailEntrepreneur.toggleVisite(${index})"
                                     id="visite-container-${index}">
                                    <div class="visite-checkbox">
                                        <span class="visite-checkbox-check">✓</span>
                                    </div>
                                    <span class="visite-icon">📍</span>
                                    <div>
                                        <div class="visite-label">À voir sur place</div>
                                        <div class="visite-sublabel">Cochez si vous devez venir sur site</div>
                                    </div>
                                </div>

                                <!-- Section visite (photos + mesures) - visible si coché -->
                                <div class="visite-section ${this.visitesData[index]?.aVoirSurPlace ? 'show' : ''}" id="visite-section-${index}">
                                    <div class="visite-section-title">📸 Photos et mesures sur place</div>

                                    <div class="visite-actions">
                                        <label class="visite-btn" for="visite-photo-input-${index}">
                                            <span class="visite-btn-icon">📷</span>
                                            <span class="visite-btn-label">Prendre photo</span>
                                            <input type="file"
                                                   id="visite-photo-input-${index}"
                                                   accept="image/*"
                                                   capture="environment"
                                                   multiple
                                                   style="display:none"
                                                   onchange="PortailEntrepreneur.ajouterPhotoVisite(${index}, this.files)">
                                        </label>
                                    </div>

                                    <!-- Photos prises sur place -->
                                    <div class="visite-photos-container" id="visite-photos-${index}">
                                        ${(this.visitesData[index]?.photos || []).length > 0 ? `
                                            <div class="visite-photos-grid">
                                                ${(this.visitesData[index]?.photos || []).map((photo, photoIndex) => `
                                                    <div class="visite-photo-item">
                                                        <img src="${photo}" class="visite-photo-img" onclick="PortailEntrepreneur.showPhoto('${photo}')">
                                                        <button class="visite-photo-delete" onclick="PortailEntrepreneur.supprimerPhotoVisite(${index}, ${photoIndex})">×</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- Zone mesures/notes terrain -->
                                    <div class="visite-mesures-container">
                                        <div class="visite-section-title" style="margin-top:15px">📏 Notes et mesures terrain</div>
                                        <textarea class="visite-mesure-input"
                                                  id="visite-mesures-${index}"
                                                  placeholder="Notez vos mesures, observations ou remarques prises sur place..."
                                                  onchange="PortailEntrepreneur.sauvegarderMesures(${index}, this.value)">${this.visitesData[index]?.mesures || ''}</textarea>
                                    </div>
                                </div>

                                <!-- Section upload photos et documents entrepreneur -->
                                <div class="entrepreneur-uploads-section">
                                    <div class="uploads-section-title">📎 Vos pièces jointes</div>
                                    <div class="uploads-row">
                                        <label class="upload-btn" for="entrepreneur-photos-input-${index}">
                                            <span class="icon">🖼️</span>
                                            Ajouter photos
                                            <input type="file"
                                                   id="entrepreneur-photos-input-${index}"
                                                   accept="image/*"
                                                   multiple
                                                   style="display:none"
                                                   onchange="PortailEntrepreneur.ajouterPhotosEntrepreneur(${index}, this.files)">
                                        </label>
                                        <label class="upload-btn" for="entrepreneur-docs-input-${index}">
                                            <span class="icon">📄</span>
                                            Ajouter documents
                                            <input type="file"
                                                   id="entrepreneur-docs-input-${index}"
                                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.txt"
                                                   multiple
                                                   style="display:none"
                                                   onchange="PortailEntrepreneur.ajouterDocsEntrepreneur(${index}, this.files)">
                                        </label>
                                    </div>

                                    <!-- Photos uploadées -->
                                    <div id="entrepreneur-photos-${index}">
                                        ${this.renderEntrepreneurPhotos(index)}
                                    </div>

                                    <!-- Documents uploadés -->
                                    <div id="entrepreneur-docs-${index}">
                                        ${this.renderEntrepreneurDocs(index)}
                                    </div>
                                </div>
                            </div>

                            <!-- Colonne droite : photo -->
                            ${hasPhotos ? `
                                <div class="travail-photo-side">
                                    <img src="${travail.photos[0]}"
                                         class="photo-preview"
                                         onclick="PortailEntrepreneur.showPhoto('${travail.photos[0]}')"
                                         alt="Photo">
                                    ${travail.photos.length > 1 ? `
                                        <div class="more-photos">
                                            ${travail.photos.slice(1).map(p => `
                                                <img src="${p}" class="photo-thumb-small" onclick="PortailEntrepreneur.showPhoto('${p}')" alt="Photo">
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            // Render une ligne du tableau pour le layout desktop
            renderTravailRow(travail, index) {
                const aVoirSurPlace = this.visitesData[index]?.aVoirSurPlace || false;
                const typeBadge = travail.typeTravail === 'aa' ? '<span class="badge-mini badge-mini-aa">AA</span>' :
                                  travail.typeTravail === 'tpaa' ? '<span class="badge-mini badge-mini-tpaa">TPAA</span>' :
                                  travail.typeTravail === 'aa-tpaa' ? '<span class="badge-mini badge-mini-mixte">AA/TPAA</span>' : '-';

                return `
                    <tr data-index="${index}" onclick="PortailEntrepreneur.selectTravail(${index})">
                        <td class="col-ot">${travail.ot || '#' + (index + 1)}</td>
                        <td class="col-desc" title="${travail.description || ''}">${(travail.description || '-').substring(0, 60)}${(travail.description || '').length > 60 ? '...' : ''}</td>
                        <td>${(travail.equipement || '-').substring(0, 15)}</td>
                        <td class="col-heures">${travail.estimationHeures || '-'}</td>
                        <td class="col-type">${typeBadge}</td>
                        <td class="col-visite">${aVoirSurPlace ? '📍' : ''}</td>
                    </tr>
                `;
            },

            selectedTravailIndex: null,

            selectTravail(index) {
                this.selectedTravailIndex = index;

                // Mettre à jour la sélection visuelle dans le tableau
                document.querySelectorAll('.travaux-table tbody tr').forEach(tr => {
                    tr.classList.remove('selected');
                });
                const selectedRow = document.querySelector(`.travaux-table tbody tr[data-index="${index}"]`);
                if (selectedRow) {
                    selectedRow.classList.add('selected');
                }

                // Afficher les détails
                const travail = this.travaux[index];
                document.getElementById('travailDetailContent').innerHTML = this.renderTravailDetail(travail, index);
            },

            renderTravailDetail(travail, index) {
                const isTypeAA = travail.typeTravail === 'aa';
                const isTypeTPAA = travail.typeTravail === 'tpaa';
                const isTypeAaOuTpaa = travail.typeTravail === 'aa-tpaa';
                const isJeudi = travail.jourArret === 'jeudi';
                const isHorsJeudi = travail.jourArret === 'hors-jeudi';
                const hasPhotos = travail.photos && travail.photos.length > 0;
                const aVoirSurPlace = this.visitesData[index]?.aVoirSurPlace || false;

                return `
                    <div class="detail-panel-header">
                        <span class="detail-ot">${travail.ot || '#' + (index + 1)}</span>
                        ${aVoirSurPlace ? '<span class="badge badge-visite" style="margin-left:10px;">📍 À voir sur place</span>' : ''}
                        <h3>${(travail.description || 'Aucune description').substring(0, 100)}</h3>
                    </div>
                    <div class="detail-panel-body">
                        <!-- Description complète -->
                        <div class="detail-section">
                            <div class="detail-section-title">Description</div>
                            <p class="detail-description">${travail.description || 'Aucune description'}</p>
                        </div>

                        <!-- Informations compactes -->
                        <div class="detail-section">
                            <div class="detail-info-grid">
                                <div class="detail-info-item">
                                    <span class="detail-info-label">Équip:</span>
                                    <span class="detail-info-value">${travail.equipement || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">Op:</span>
                                    <span class="detail-info-value">${travail.operation || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">Heures:</span>
                                    <span class="detail-info-value">${travail.estimationHeures || '-'}h</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">Secteur:</span>
                                    <span class="detail-info-value">${travail.localisation || travail.secteur || '-'}</span>
                                </div>
                                ${travail.conditions ? `
                                <div class="detail-info-item">
                                    <span class="detail-info-label">Cond:</span>
                                    <span class="detail-info-value">${travail.conditions}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Type de travail -->
                        ${(isTypeAA || isTypeTPAA || isTypeAaOuTpaa) ? `
                        <div class="detail-section">
                            <div class="detail-section-title">Type de travail</div>
                            <div class="type-row">
                                ${isTypeAA ? '<span class="badge badge-aa badge-large">🔧 Arrêt Annuel</span>' : ''}
                                ${isTypeTPAA ? '<span class="badge badge-tpaa badge-large">📋 TPAA</span>' : ''}
                                ${isTypeAaOuTpaa ? '<span class="badge badge-aa-tpaa badge-large">🔧📋 AA ou TPAA</span>' : ''}
                                ${isJeudi ? '<span class="badge badge-jeudi badge-large" style="margin-left:8px;">🗓️ Jeudi d\'arrêt</span>' : ''}
                                ${isHorsJeudi ? '<span class="badge badge-hors-jeudi badge-large" style="margin-left:8px;">✓ Hors jeudi</span>' : ''}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Photos -->
                        ${hasPhotos ? `
                        <div class="detail-section">
                            <div class="detail-section-title">Photos (${travail.photos.length})</div>
                            <div class="detail-photos-grid">
                                ${travail.photos.map(p => `
                                    <img src="${p}" class="detail-photo-thumb" onclick="PortailEntrepreneur.showPhoto('${p}')" alt="Photo">
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Documents -->
                        ${(travail.documents && travail.documents.length > 0) ? `
                        <div class="detail-section">
                            <div class="detail-section-title">Documents</div>
                            ${travail.documents.map(d => `
                                <a href="${d.url}" target="_blank" class="document-link">
                                    📄 ${d.nom || 'Document'}
                                </a>
                            `).join('')}
                        </div>
                        ` : ''}

                        <!-- Note du gestionnaire -->
                        ${travail.commentaire ? `
                        <div class="detail-section">
                            <div class="travail-commentaire" style="margin-top:0;">
                                <div class="commentaire-label">💬 Note du gestionnaire</div>
                                <div class="commentaire-text">${travail.commentaire}</div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Votre commentaire -->
                        <div class="detail-section">
                            <div class="detail-section-title">✏️ Votre commentaire</div>
                            <div class="detail-comment-box">
                                <textarea id="detail-comment-${index}"
                                          placeholder="Remarques, questions ou prix..."
                                          onchange="PortailEntrepreneur.updateCommentFromDetail(${index}, this.value)"
                                >${this.commentairesTravaux[index] || ''}</textarea>
                            </div>
                        </div>

                        <!-- Case à voir sur place -->
                        <div class="detail-section">
                            <div class="visite-checkbox-container ${aVoirSurPlace ? 'checked' : ''}"
                                 onclick="PortailEntrepreneur.toggleVisiteFromDetail(${index})"
                                 id="detail-visite-container-${index}">
                                <div class="visite-checkbox">
                                    <span class="visite-checkbox-check">✓</span>
                                </div>
                                <span class="visite-icon">📍</span>
                                <div>
                                    <div class="visite-label">À voir sur place</div>
                                    <div class="visite-sublabel">Cochez si vous devez venir sur site</div>
                                </div>
                            </div>
                        </div>

                        <!-- Section visite terrain (visible si coché) -->
                        <div class="detail-section visite-section ${aVoirSurPlace ? 'show' : ''}" id="detail-visite-section-${index}" style="margin-top:0;">
                            <div class="visite-section-title">📸 Photos et mesures sur place</div>

                            <div class="visite-actions" style="margin-bottom:12px;">
                                <label class="visite-btn" for="detail-visite-photo-input-${index}">
                                    <span class="visite-icon">📷</span> Prendre photo
                                    <input type="file"
                                           id="detail-visite-photo-input-${index}"
                                           accept="image/*"
                                           capture="environment"
                                           multiple
                                           style="display:none"
                                           onchange="PortailEntrepreneur.ajouterPhotoVisiteFromDetail(${index}, this.files)">
                                </label>
                            </div>

                            <!-- Photos prises sur place -->
                            <div id="detail-visite-photos-${index}">
                                ${(this.visitesData[index]?.photos || []).length > 0 ? `
                                    <div class="detail-photos-grid">
                                        ${(this.visitesData[index]?.photos || []).map((photo, photoIndex) => `
                                            <div style="position:relative;">
                                                <img src="${photo}" class="detail-photo-thumb" onclick="PortailEntrepreneur.showPhoto('${photo}')">
                                                <button style="position:absolute;top:5px;right:5px;background:#ef4444;color:white;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:14px;" onclick="PortailEntrepreneur.supprimerPhotoVisite(${index}, ${photoIndex}); PortailEntrepreneur.selectTravail(${index});">×</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="color:#94a3b8;font-size:0.85rem;">Aucune photo terrain</p>'}
                            </div>

                            <!-- Zone mesures/notes terrain -->
                            <div style="margin-top:15px;">
                                <div class="visite-section-title">📏 Notes et mesures terrain</div>
                                <textarea class="visite-mesure-input" style="width:100%;padding:10px;border:2px solid #f9a8d4;border-radius:8px;font-family:inherit;min-height:80px;"
                                          id="detail-visite-mesures-${index}"
                                          placeholder="Notez vos mesures, observations ou remarques prises sur place..."
                                          onchange="PortailEntrepreneur.sauvegarderMesuresFromDetail(${index}, this.value)">${this.visitesData[index]?.mesures || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            },

            updateCommentFromDetail(index, value) {
                this.commentairesTravaux[index] = value;
                // Synchroniser avec le textarea de la carte mobile si existant
                const mobileTextarea = document.getElementById(`comment-travail-${index}`);
                if (mobileTextarea) {
                    mobileTextarea.value = value;
                }
                // Sauvegarde automatique
                this.sauvegarderTousCommentaires();
            },

            toggleVisiteFromDetail(index) {
                this.toggleVisite(index);
                // Mettre à jour le panneau de détail
                const container = document.getElementById(`detail-visite-container-${index}`);
                const detailSection = document.getElementById(`detail-visite-section-${index}`);
                const isChecked = this.visitesData[index]?.aVoirSurPlace;

                if (container) {
                    container.classList.toggle('checked', isChecked);
                }
                if (detailSection) {
                    detailSection.classList.toggle('show', isChecked);
                }
                // Mettre à jour le tableau (colonne visite)
                const row = document.querySelector(`.travaux-table tbody tr[data-index="${index}"]`);
                if (row) {
                    const visiteCell = row.querySelector('.col-visite');
                    if (visiteCell) {
                        visiteCell.textContent = isChecked ? '📍' : '';
                    }
                }
            },

            async ajouterPhotoVisiteFromDetail(index, files) {
                await this.ajouterPhotoVisite(index, files);
                // Rafraîchir le panneau de détail
                this.selectTravail(index);
            },

            async sauvegarderMesuresFromDetail(index, value) {
                // Initialiser si nécessaire
                if (!this.visitesData[index]) {
                    this.visitesData[index] = { aVoirSurPlace: true, photos: [], mesures: '' };
                }
                this.visitesData[index].mesures = value;

                // Synchroniser avec le textarea mobile
                const mobileTextarea = document.getElementById(`visite-mesures-${index}`);
                if (mobileTextarea) {
                    mobileTextarea.value = value;
                }

                await this.sauvegarderVisitesData();
            },

            commentaireEntrepreneur: '',
            commentairesTravaux: [],
            visitesData: [], // Données des visites sur place (aVoirSurPlace, photos, mesures)
            uploadsData: [], // Données des uploads (photos et documents par travail)

            async loadCommentaireEntrepreneur() {
                try {
                    const doc = await firebase.firestore()
                        .collection('commentaires_entrepreneurs')
                        .doc(this.appelId)
                        .get();
                    if (doc.exists) {
                        const data = doc.data();
                        this.commentaireEntrepreneur = data.commentaire || '';
                        this.commentairesTravaux = data.commentairesTravaux || [];
                        this.visitesData = data.visitesData || [];
                        this.uploadsData = data.uploadsData || [];
                    }
                } catch (e) {
                    console.log('Pas de commentaire existant');
                }
            },

            async sauvegarderTousCommentaires() {
                // Récupérer le commentaire global
                const textareaGlobal = document.getElementById('commentaireEntrepreneur');
                const commentaireGlobal = textareaGlobal ? textareaGlobal.value.trim() : '';

                // Récupérer tous les commentaires par travail
                const commentairesTravaux = [];
                this.travaux.forEach((t, index) => {
                    const textarea = document.getElementById(`comment-travail-${index}`);
                    commentairesTravaux[index] = textarea ? textarea.value.trim() : '';
                });

                // Nettoyer les données pour éviter les undefined (Firebase les refuse)
                const cleanVisitesData = this.cleanArrayForFirebase(
                    this.visitesData,
                    { aVoirSurPlace: false, photos: [], mesures: '' }
                );

                const cleanCommentairesTravaux = this.cleanArrayForFirebase(
                    commentairesTravaux,
                    ''
                );

                const cleanUploadsData = this.cleanArrayForFirebase(
                    this.uploadsData,
                    { photos: [], documents: [] }
                );

                try {
                    await firebase.firestore()
                        .collection('commentaires_entrepreneurs')
                        .doc(this.appelId)
                        .set({
                            commentaire: commentaireGlobal || '',
                            commentairesTravaux: cleanCommentairesTravaux,
                            visitesData: cleanVisitesData,
                            uploadsData: cleanUploadsData,
                            entreprise: this.entreprise || '',
                            dateModification: new Date().toISOString()
                        });

                    this.commentaireEntrepreneur = commentaireGlobal;
                    this.commentairesTravaux = commentairesTravaux;
                    this.showToast('✅ Tous les commentaires enregistrés!');
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    this.showToast('❌ Erreur lors de la sauvegarde', 'error');
                }
            },

            async sauvegarderCommentaire() {
                // Utiliser la nouvelle fonction qui sauvegarde tout
                await this.sauvegarderTousCommentaires();
            },

            showPhoto(src) {
                document.getElementById('photoModalImg').src = src;
                document.getElementById('photoModal').classList.add('show');
            },

            closePhotoModal() {
                document.getElementById('photoModal').classList.remove('show');
            },

            // ========== FONCTIONS AIDE ==========

            openHelp() {
                document.getElementById('helpModal').classList.add('show');
                document.body.style.overflow = 'hidden';
            },

            closeHelp() {
                document.getElementById('helpModal').classList.remove('show');
                document.body.style.overflow = '';
            },

            closeHelpOnBackdrop(event) {
                if (event.target === document.getElementById('helpModal')) {
                    this.closeHelp();
                }
            },

            exportPDF() {
                const { jsPDF } = window.jspdf;
                // Format paysage pour style présentation
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                const pageWidth = 297;
                const pageHeight = 210;
                const margin = 15;

                // Debug: afficher les sources de photos
                console.log('=== DEBUG PDF PHOTOS ===');
                this.travaux.forEach((t, i) => {
                    const visiteData = this.visitesData[i] || {};
                    const uploadData = this.uploadsData[i] || {};
                    console.log(`Travail ${i}:`, {
                        photosGestionnaire: (t.photos || []).length,
                        photosVisite: (visiteData.photos || []).length,
                        photosEntrepreneur: (uploadData.photos || []).length,
                        sampleGest: t.photos?.[0]?.substring(0, 80),
                        sampleVisite: visiteData.photos?.[0]?.substring(0, 80),
                        sampleUpload: uploadData.photos?.[0]?.substring(0, 80)
                    });
                });

                // === PAGE DE TITRE ===
                this.renderPDFTitlePage(doc, pageWidth, pageHeight);

                // === UNE PAGE PAR TRAVAIL ===
                this.travaux.forEach((t, index) => {
                    doc.addPage();
                    this.renderPDFTravailPage(doc, t, index, pageWidth, pageHeight, margin);
                });

                // === PAGE DE RÉSUMÉ (optionnelle) ===
                doc.addPage();
                this.renderPDFSummaryPage(doc, pageWidth, pageHeight, margin);

                doc.save(`Soumission_${this.entreprise}_${new Date().toISOString().split('T')[0]}.pdf`);
                this.showToast('📄 PDF PowerPoint téléchargé!');
            },

            renderPDFTitlePage(doc, pageWidth, pageHeight) {
                // Fond bleu foncé en haut
                doc.setFillColor(30, 58, 95);
                doc.rect(0, 0, pageWidth, 80, 'F');

                // Titre principal
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(32);
                doc.setFont(undefined, 'bold');
                doc.text('Appel de Soumission', pageWidth / 2, 35, { align: 'center' });

                // Sous-titre
                doc.setFontSize(20);
                doc.setFont(undefined, 'normal');
                doc.text(this.appelData.nomArret || 'Arrêt Annuel 2025', pageWidth / 2, 55, { align: 'center' });

                // Nom entreprise (badge orange)
                doc.setFillColor(245, 158, 11);
                doc.roundedRect(pageWidth / 2 - 50, 90, 100, 20, 5, 5, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(this.entreprise, pageWidth / 2, 103, { align: 'center' });

                // Stats
                doc.setTextColor(30, 58, 95);
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                const totalHeures = this.travaux.reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const nbVisites = this.visitesData.filter(v => v?.aVoirSurPlace).length;

                doc.text(`${this.travaux.length} travaux`, pageWidth / 2 - 60, 135, { align: 'center' });
                doc.text(`${totalHeures}h estimées`, pageWidth / 2, 135, { align: 'center' });
                doc.text(`${nbVisites} visites terrain`, pageWidth / 2 + 60, 135, { align: 'center' });

                // Date limite si existe
                if (this.appelData.dateLimite) {
                    const dateLimite = new Date(this.appelData.dateLimite);
                    doc.setFontSize(12);
                    doc.setTextColor(180, 83, 9);
                    doc.text(`Date limite: ${dateLimite.toLocaleDateString('fr-CA')}`, pageWidth / 2, 155, { align: 'center' });
                }

                // Footer
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text(`Généré le ${new Date().toLocaleDateString('fr-CA')}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            },

            renderPDFTravailPage(doc, travail, index, pageWidth, pageHeight, margin) {
                const visiteData = this.visitesData[index] || {};
                const uploadData = this.uploadsData[index] || {};
                const commentaire = this.commentairesTravaux[index] || '';

                // Collecter toutes les photos
                const photosGestionnaire = travail.photos || [];
                const photosVisite = visiteData.photos || [];
                const photosEntrepreneur = uploadData.photos || [];
                const allPhotos = [...photosGestionnaire, ...photosVisite, ...photosEntrepreneur];
                const hasPhotos = allPhotos.length > 0;

                // Labels
                const typeLabels = { 'aa': 'Arrêt Annuel', 'tpaa': 'TPAA', 'aa-tpaa': 'AA ou TPAA' };
                const jourLabels = { 'jeudi': 'Jeudi d\'arrêt', 'hors-jeudi': 'Hors jeudi' };

                // === EN-TÊTE BLEU FONCÉ ===
                doc.setFillColor(30, 58, 95);
                doc.rect(0, 0, pageWidth, 22, 'F');

                // Numéro travail à gauche
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(`Travail ${index + 1} sur ${this.travaux.length}`, margin, 14);

                // OT au centre
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`OT: ${travail.ot || 'N/A'}`, pageWidth / 2, 14, { align: 'center' });

                // Badge visite si applicable
                if (visiteData.aVoirSurPlace) {
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(pageWidth - margin - 50, 6, 50, 10, 2, 2, 'F');
                    doc.setTextColor(190, 24, 93);
                    doc.setFontSize(7);
                    doc.setFont(undefined, 'bold');
                    doc.text('À VOIR SUR PLACE', pageWidth - margin - 25, 13, { align: 'center' });
                }

                let y = 30;

                // === DESCRIPTION ===
                doc.setTextColor(30, 41, 59);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                const descLines = doc.splitTextToSize(travail.description || 'Sans description', pageWidth - margin * 2);
                doc.text(descLines.slice(0, 2), margin, y);
                y += descLines.slice(0, 2).length * 5 + 8;

                // === LIGNE TYPE TRAVAIL / JOUR (style HTML) ===
                if (travail.typeTravail) {
                    // Fond gris clair pour toute la section
                    doc.setFillColor(245, 247, 250);
                    doc.roundedRect(margin, y, pageWidth - margin * 2, 14, 2, 2, 'F');

                    let xPos = margin + 6;

                    // Label "Doit etre fait pendant :"
                    doc.setTextColor(71, 85, 105);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text('Doit etre fait pendant :', xPos, y + 10);
                    xPos += 55;

                    // Badge type (AA / TPAA / AA ou TPAA)
                    if (travail.typeTravail === 'aa') {
                        // VIOLET pour Arret Annuel (comme HTML)
                        doc.setFillColor(139, 92, 246);
                        doc.roundedRect(xPos, y + 2, 52, 10, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(9);
                        doc.text('Arret Annuel', xPos + 4, y + 9);
                        xPos += 58;
                    } else if (travail.typeTravail === 'tpaa') {
                        // BLEU pour TPAA (comme HTML)
                        doc.setFillColor(59, 130, 246);
                        doc.roundedRect(xPos, y + 2, 30, 10, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(9);
                        doc.text('TPAA', xPos + 4, y + 9);
                        xPos += 36;
                    } else if (travail.typeTravail === 'aa-tpaa') {
                        // Orange pour AA ou TPAA
                        doc.setFillColor(245, 158, 11);
                        doc.roundedRect(xPos, y + 2, 50, 10, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(9);
                        doc.text('AA ou TPAA', xPos + 4, y + 9);
                        xPos += 56;
                    }

                    // Si TPAA ou AA-TPAA, afficher le jour
                    if (travail.jourArret && travail.typeTravail !== 'aa') {
                        // Separateur
                        doc.setTextColor(148, 163, 184);
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        doc.text('-', xPos + 2, y + 10);
                        xPos += 10;

                        // Label "Durant :"
                        doc.setTextColor(71, 85, 105);
                        doc.setFontSize(10);
                        doc.text('Durant :', xPos, y + 10);
                        xPos += 22;

                        // Badge jour
                        if (travail.jourArret === 'jeudi') {
                            // Jaune/Orange pour Jeudi d'arret
                            doc.setFillColor(251, 191, 36);
                            doc.roundedRect(xPos, y + 2, 50, 10, 2, 2, 'F');
                            doc.setTextColor(0, 0, 0);
                            doc.setFont(undefined, 'bold');
                            doc.setFontSize(9);
                            doc.text("Jeudi d'arret", xPos + 4, y + 9);
                        } else if (travail.jourArret === 'hors-jeudi') {
                            // Vert pour Hors jeudi
                            doc.setFillColor(34, 197, 94);
                            doc.roundedRect(xPos, y + 2, 40, 10, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFont(undefined, 'bold');
                            doc.setFontSize(9);
                            doc.text('Hors jeudi', xPos + 4, y + 9);
                        }
                    }

                    y += 18;
                }

                // === GRILLE D'INFORMATIONS ===
                const infoBoxWidth = (pageWidth - margin * 2 - 15) / 4;
                const infoBoxHeight = 18;

                // Ligne 1: Equipement, Operation, Localisation, Heures
                const infos = [
                    { label: 'Equipement', value: travail.equipement || '-' },
                    { label: 'Operation', value: travail.operation || '-' },
                    { label: 'Localisation', value: travail.localisation || travail.secteur || '-' },
                    { label: 'Heures', value: `${travail.estimationHeures || 0} h` }
                ];

                infos.forEach((info, i) => {
                    const boxX = margin + i * (infoBoxWidth + 5);
                    doc.setFillColor(248, 250, 252);
                    doc.roundedRect(boxX, y, infoBoxWidth, infoBoxHeight, 2, 2, 'F');

                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(info.label, boxX + 4, y + 7);

                    doc.setTextColor(30, 41, 59);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    const valueText = info.value.length > 18 ? info.value.substring(0, 16) + '...' : info.value;
                    doc.text(valueText, boxX + 4, y + 15);
                });

                y += infoBoxHeight + 5;

                // === SECTION 2 COLONNES: Commentaires / Photos ===
                const colWidth = (pageWidth - margin * 2 - 10) / 2;
                const colGauche = margin;
                const colDroite = margin + colWidth + 10;
                let yGauche = y;
                let yDroite = y;

                // === COLONNE GAUCHE: COMMENTAIRES ===

                // Commentaire gestionnaire (si existe)
                if (travail.commentaire) {
                    // Fond jaune
                    doc.setFillColor(254, 249, 195);
                    doc.roundedRect(colGauche, yGauche, colWidth, 28, 3, 3, 'F');
                    // Bordure jaune fonce a gauche
                    doc.setFillColor(251, 191, 36);
                    doc.rect(colGauche, yGauche, 4, 28, 'F');

                    doc.setTextColor(146, 64, 14);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Note du gestionnaire', colGauche + 10, yGauche + 8);

                    doc.setTextColor(113, 63, 18);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    const noteLines = doc.splitTextToSize(travail.commentaire, colWidth - 15);
                    doc.text(noteLines.slice(0, 2), colGauche + 10, yGauche + 17);

                    yGauche += 32;
                }

                // Commentaire entrepreneur (si existe)
                if (commentaire) {
                    // Fond vert
                    doc.setFillColor(220, 252, 231);
                    doc.roundedRect(colGauche, yGauche, colWidth, 28, 3, 3, 'F');
                    // Bordure verte fonce a gauche
                    doc.setFillColor(34, 197, 94);
                    doc.rect(colGauche, yGauche, 4, 28, 'F');

                    doc.setTextColor(22, 101, 52);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Commentaire entrepreneur', colGauche + 10, yGauche + 8);

                    doc.setTextColor(20, 83, 45);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    const entLines = doc.splitTextToSize(commentaire, colWidth - 15);
                    doc.text(entLines.slice(0, 2), colGauche + 10, yGauche + 17);

                    yGauche += 32;
                }

                // Section VISITE SUR PLACE (si coche)
                if (visiteData.aVoirSurPlace) {
                    const hasVisitePhotos = photosVisite.length > 0;
                    const hasVisiteMesures = visiteData.mesures && visiteData.mesures.trim();

                    // Calculer hauteur selon contenu
                    let visiteHeight = 14; // Titre
                    if (hasVisiteMesures) visiteHeight += 18;
                    if (hasVisitePhotos) visiteHeight += 28;
                    if (!hasVisiteMesures && !hasVisitePhotos) visiteHeight += 10;

                    // Fond rose
                    doc.setFillColor(252, 231, 243);
                    doc.roundedRect(colGauche, yGauche, colWidth, visiteHeight, 3, 3, 'F');
                    // Bordure rose fonce a gauche
                    doc.setFillColor(236, 72, 153);
                    doc.rect(colGauche, yGauche, 4, visiteHeight, 'F');

                    // Titre
                    doc.setTextColor(190, 24, 93);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('A voir sur place', colGauche + 10, yGauche + 10);

                    let yVisite = yGauche + 14;

                    // Mesures/notes si presentes
                    if (hasVisiteMesures) {
                        doc.setTextColor(157, 23, 77);
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);
                        const mesuresLines = doc.splitTextToSize(visiteData.mesures, colWidth - 15);
                        doc.text(mesuresLines.slice(0, 2), colGauche + 10, yVisite + 5);
                        yVisite += 18;
                    }

                    // Photos visite si presentes
                    if (hasVisitePhotos) {
                        doc.setTextColor(157, 23, 77);
                        doc.setFontSize(9);
                        doc.text(`${photosVisite.length} photo(s) de visite`, colGauche + 10, yVisite + 5);

                        // Mini apercu des photos (max 3)
                        const miniPhotoSize = 20;
                        const maxMiniPhotos = Math.min(photosVisite.length, 3);
                        for (let i = 0; i < maxMiniPhotos; i++) {
                            try {
                                const photoData = photosVisite[i];
                                if (photoData && typeof photoData === 'string') {
                                    let format = 'JPEG';
                                    if (photoData.includes('data:image/png')) format = 'PNG';
                                    doc.addImage(photoData, format, colGauche + 10 + i * (miniPhotoSize + 3), yVisite + 8, miniPhotoSize, miniPhotoSize);
                                }
                            } catch (e) {
                                // Ignorer erreur photo
                            }
                        }
                    }

                    // Si rien
                    if (!hasVisiteMesures && !hasVisitePhotos) {
                        doc.setTextColor(157, 23, 77);
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);
                        doc.text('Visite a effectuer', colGauche + 10, yGauche + 20);
                    }

                    yGauche += visiteHeight + 4;
                }

                // Si aucun commentaire ni visite, afficher placeholder
                if (!travail.commentaire && !commentaire && !visiteData.aVoirSurPlace) {
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(colGauche, yGauche, colWidth, 25, 3, 3, 'F');
                    doc.setTextColor(148, 163, 184);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text('Aucun commentaire', colGauche + colWidth / 2, yGauche + 15, { align: 'center' });
                    yGauche += 28;
                }

                // === COLONNE DROITE: PHOTOS ===
                if (hasPhotos) {
                    // En-tete photos
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(colDroite, yDroite, colWidth, 12, 2, 2, 'F');
                    doc.setTextColor(51, 65, 85);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Photos (${allPhotos.length})`, colDroite + 8, yDroite + 9);
                    yDroite += 14;

                    // Grille de photos 2x2
                    const photoW = (colWidth - 6) / 2;
                    const photoH = 35;
                    const maxPhotos = Math.min(allPhotos.length, 4);

                    for (let i = 0; i < maxPhotos; i++) {
                        const col = i % 2;
                        const row = Math.floor(i / 2);
                        const pX = colDroite + col * (photoW + 3);
                        const pY = yDroite + row * (photoH + 3);

                        try {
                            const photoData = allPhotos[i];
                            if (photoData && typeof photoData === 'string') {
                                let format = 'JPEG';
                                if (photoData.includes('data:image/png')) format = 'PNG';
                                else if (photoData.includes('data:image/webp')) format = 'WEBP';
                                doc.addImage(photoData, format, pX, pY, photoW, photoH);
                            } else {
                                throw new Error('Photo invalide');
                            }
                        } catch (e) {
                            console.error('Erreur ajout photo PDF:', e);
                            doc.setFillColor(241, 245, 249);
                            doc.roundedRect(pX, pY, photoW, photoH, 2, 2, 'F');
                            doc.setTextColor(148, 163, 184);
                            doc.setFontSize(9);
                            doc.text('Photo', pX + photoW / 2, pY + photoH / 2, { align: 'center' });
                        }
                    }

                    yDroite += Math.ceil(maxPhotos / 2) * (photoH + 3) + 2;

                    if (allPhotos.length > 4) {
                        doc.setTextColor(100, 116, 139);
                        doc.setFontSize(9);
                        doc.text(`+ ${allPhotos.length - 4} autres photos`, colDroite + colWidth / 2, yDroite, { align: 'center' });
                    }
                } else {
                    // Pas de photos
                    doc.setFillColor(248, 250, 252);
                    doc.roundedRect(colDroite, yDroite, colWidth, 40, 3, 3, 'F');
                    doc.setTextColor(148, 163, 184);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text('Aucune photo', colDroite + colWidth / 2, yDroite + 22, { align: 'center' });
                }

                // === DOCUMENTS (en bas si présents) ===
                const nbDocs = (uploadData.documents || []).length;
                const finalY = Math.max(yGauche, yDroite) + 5;
                if (nbDocs > 0) {
                    doc.setFillColor(239, 246, 255);
                    doc.roundedRect(margin, finalY, pageWidth - margin * 2, 12, 2, 2, 'F');
                    doc.setTextColor(29, 78, 216);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`📎 ${nbDocs} document(s) joint(s) par l'entrepreneur`, margin + 8, finalY + 8);
                }

                // === FOOTER ===
                doc.setDrawColor(226, 232, 240);
                doc.line(margin, pageHeight - 12, pageWidth - margin, pageHeight - 12);
                doc.setTextColor(148, 163, 184);
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.text(this.entreprise, margin, pageHeight - 6);
                doc.text(this.appelData.nomArret || 'Arrêt Annuel', pageWidth / 2, pageHeight - 6, { align: 'center' });
                doc.text(new Date().toLocaleDateString('fr-CA'), pageWidth - margin, pageHeight - 6, { align: 'right' });
            },

            renderPDFSummaryPage(doc, pageWidth, pageHeight, margin) {
                // En-tête
                doc.setFillColor(30, 58, 95);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Résumé de la soumission', pageWidth / 2, 20, { align: 'center' });

                let y = 45;

                // Stats globales
                doc.setTextColor(30, 41, 59);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Statistiques:', margin, y);
                y += 10;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                const totalHeures = this.travaux.reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const nbVisites = this.visitesData.filter(v => v?.aVoirSurPlace).length;
                const nbAA = this.travaux.filter(t => t.typeTravail === 'aa').length;
                const nbTPAA = this.travaux.filter(t => t.typeTravail === 'tpaa').length;

                doc.text(`• Total travaux: ${this.travaux.length}`, margin + 10, y); y += 7;
                doc.text(`• Heures estimées: ${totalHeures}h`, margin + 10, y); y += 7;
                doc.text(`• Travaux AA: ${nbAA}`, margin + 10, y); y += 7;
                doc.text(`• Travaux TPAA: ${nbTPAA}`, margin + 10, y); y += 7;
                doc.text(`• Visites terrain prévues: ${nbVisites}`, margin + 10, y); y += 15;

                // Liste des travaux à visiter
                if (nbVisites > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Travaux à voir sur place:', margin, y);
                    y += 8;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);

                    this.travaux.forEach((t, i) => {
                        if (this.visitesData[i]?.aVoirSurPlace) {
                            if (y > pageHeight - 20) return;
                            doc.text(`• [${t.ot || '-'}] ${(t.description || '').substring(0, 50)}...`, margin + 10, y);
                            y += 6;
                        }
                    });
                }

                // Commentaire global
                if (this.commentaireEntrepreneur) {
                    y += 10;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Commentaire global:', margin, y);
                    y += 8;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    const globalLines = doc.splitTextToSize(this.commentaireEntrepreneur, pageWidth - margin * 2);
                    doc.text(globalLines.slice(0, 5), margin, y);
                }

                // Footer
                doc.setTextColor(150, 150, 150);
                doc.setFontSize(8);
                doc.text(`${this.entreprise} - Généré le ${new Date().toLocaleDateString('fr-CA')}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
            },

            // ========== PDF VISITES SUR PLACE ==========
            exportPDFVisites() {
                // Filtrer les travaux à voir sur place
                const travauxVisites = [];
                this.travaux.forEach((t, i) => {
                    if (this.visitesData[i]?.aVoirSurPlace) {
                        travauxVisites.push({ travail: t, index: i });
                    }
                });

                if (travauxVisites.length === 0) {
                    this.showToast('Aucun travail marqué "À voir sur place"', 'error');
                    return;
                }

                const { jsPDF } = window.jspdf;
                // Format portrait pour liste terrain
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 12;

                // === PAGE DE TITRE ===
                // Bandeau rose/rouge en haut
                doc.setFillColor(190, 24, 93);
                doc.rect(0, 0, pageWidth, 45, 'F');

                // Titre
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('Visites sur place', pageWidth / 2, 20, { align: 'center' });

                // Sous-titre
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(`${travauxVisites.length} travaux à voir`, pageWidth / 2, 32, { align: 'center' });

                // Infos entreprise
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(margin, 55, pageWidth - margin * 2, 25, 3, 3, 'F');

                doc.setTextColor(30, 58, 95);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(this.entreprise, pageWidth / 2, 65, { align: 'center' });

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 116, 139);
                doc.text(this.appelData.nomArret || 'Arrêt Annuel 2025', pageWidth / 2, 74, { align: 'center' });

                // Liste des travaux - style checklist
                let y = 95;

                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(30, 58, 95);
                doc.text('Liste des travaux à visiter:', margin, y);
                y += 10;

                travauxVisites.forEach((item, idx) => {
                    const t = item.travail;
                    const visiteData = this.visitesData[item.index] || {};

                    // Vérifier si on a besoin d'une nouvelle page
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = 20;
                    }

                    // Case à cocher
                    doc.setDrawColor(190, 24, 93);
                    doc.setLineWidth(0.5);
                    doc.rect(margin, y - 4, 5, 5);

                    // Numéro
                    doc.setTextColor(190, 24, 93);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${idx + 1}.`, margin + 8, y);

                    // OT
                    doc.setTextColor(30, 58, 95);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`[${t.ot || 'N/A'}]`, margin + 15, y);

                    // Description (tronquée)
                    doc.setTextColor(51, 65, 85);
                    doc.setFont(undefined, 'normal');
                    const descText = (t.description || 'Sans description').substring(0, 70);
                    doc.text(descText + (t.description?.length > 70 ? '...' : ''), margin + 40, y);

                    y += 6;

                    // Infos compactes (Équipement, Localisation)
                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(8);
                    let infoLine = '';
                    if (t.equipement) infoLine += `Équip: ${t.equipement}`;
                    if (t.localisation || t.secteur) infoLine += `  |  Secteur: ${t.localisation || t.secteur}`;
                    if (t.estimationHeures) infoLine += `  |  ${t.estimationHeures}h`;
                    doc.text(infoLine, margin + 15, y);

                    y += 5;

                    // Zone de notes (lignes pour écrire à la main)
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.2);
                    doc.line(margin + 15, y + 2, pageWidth - margin, y + 2);
                    doc.line(margin + 15, y + 8, pageWidth - margin, y + 8);

                    // Si mesures déjà saisies, les afficher
                    if (visiteData.mesures) {
                        doc.setTextColor(16, 185, 129);
                        doc.setFontSize(7);
                        doc.text(`Notes: ${visiteData.mesures.substring(0, 80)}...`, margin + 16, y + 1);
                    }

                    y += 18;

                    // Ligne de séparation entre travaux
                    if (idx < travauxVisites.length - 1) {
                        doc.setDrawColor(226, 232, 240);
                        doc.setLineWidth(0.3);
                        doc.line(margin, y - 5, pageWidth - margin, y - 5);
                    }
                });

                // Footer sur la dernière page
                doc.setTextColor(150, 150, 150);
                doc.setFontSize(8);
                doc.text(`${this.entreprise} - Liste visites terrain - ${new Date().toLocaleDateString('fr-CA')}`, pageWidth / 2, pageHeight - 10, { align: 'center' });

                doc.save(`Visites_terrain_${this.entreprise}_${new Date().toISOString().split('T')[0]}.pdf`);
                this.showToast('📍 PDF visites terrain téléchargé!');
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => toast.classList.remove('show'), 3000);
            },

            // Durées de journée sélectionnées
            dureeJourAA: 8,
            dureeJourTPAA: 8,

            setDureeJour(type, duree) {
                if (type === 'AA') {
                    this.dureeJourAA = duree;
                    // Mettre à jour les boutons
                    document.querySelectorAll('#dureeAA .bilan-duree-btn').forEach(btn => {
                        btn.classList.remove('active-aa');
                        if (parseInt(btn.dataset.duree) === duree) {
                            btn.classList.add('active-aa');
                        }
                    });
                } else {
                    this.dureeJourTPAA = duree;
                    // Mettre à jour les boutons
                    document.querySelectorAll('#dureeTPAA .bilan-duree-btn').forEach(btn => {
                        btn.classList.remove('active-tpaa');
                        if (parseInt(btn.dataset.duree) === duree) {
                            btn.classList.add('active-tpaa');
                        }
                    });
                }
                this.calculerBilan();
            },

            calculerBilan() {
                // Calculer heures par type
                const heuresAA = this.travaux.filter(t => t.typeTravail === 'aa').reduce((sum, t) => sum + (parseFloat(t.estimationHeures) || 0), 0);
                const heuresTPAA = this.travaux.filter(t => t.typeTravail === 'tpaa').reduce((sum, t) => sum + (parseFloat(t.estimationHeures) || 0), 0);

                // Récupérer le nombre de techniciens pour chaque type
                const nbTechAA = parseInt(document.getElementById('bilanTechAA')?.value) || 1;
                const nbTechTPAA = parseInt(document.getElementById('bilanTechTPAA')?.value) || 1;

                // Récupérer les durées de journée
                const dureeAA = this.dureeJourAA || 8;
                const dureeTPAA = this.dureeJourTPAA || 8;

                // Calculs pour AA
                const heuresParTechAA = heuresAA / nbTechAA;
                const journeesAA = Math.floor(heuresParTechAA / dureeAA);
                const resteAA = Math.round((heuresParTechAA % dureeAA) * 10) / 10;

                // Mettre à jour les valeurs AA
                if (document.getElementById('bilanHeuresParTechAA')) {
                    document.getElementById('bilanHeuresParTechAA').textContent = Math.round(heuresParTechAA * 10) / 10;
                    document.getElementById('bilanJourneesAA').textContent = journeesAA;
                    document.getElementById('bilanResteAA').textContent = resteAA;
                }

                // Calculs pour TPAA
                const heuresParTechTPAA = heuresTPAA / nbTechTPAA;
                const journeesTPAA = Math.floor(heuresParTechTPAA / dureeTPAA);
                const resteTPAA = Math.round((heuresParTechTPAA % dureeTPAA) * 10) / 10;

                // Mettre à jour les valeurs TPAA
                if (document.getElementById('bilanHeuresParTechTPAA')) {
                    document.getElementById('bilanHeuresParTechTPAA').textContent = Math.round(heuresParTechTPAA * 10) / 10;
                    document.getElementById('bilanJourneesTPAA').textContent = journeesTPAA;
                    document.getElementById('bilanResteTPAA').textContent = resteTPAA;
                }
            },

            filterTravaux() {
                const searchVal = (document.getElementById('filterSearch')?.value || '').toLowerCase();
                const equipementVal = document.getElementById('filterEquipement')?.value || '';
                const typeVal = document.getElementById('filterType')?.value || '';
                const jourVal = document.getElementById('filterJour')?.value || '';
                const visiteVal = document.getElementById('filterVisite')?.value || '';

                let visibleCount = 0;
                const cards = document.querySelectorAll('.travail-card');

                this.travaux.forEach((travail, index) => {
                    const card = cards[index];
                    if (!card) return;

                    // Filtre recherche texte (OT, description, équipement)
                    const matchSearch = !searchVal ||
                        (travail.ot || '').toLowerCase().includes(searchVal) ||
                        (travail.description || '').toLowerCase().includes(searchVal) ||
                        (travail.equipement || '').toLowerCase().includes(searchVal);

                    // Filtre équipement
                    const matchEquipement = !equipementVal || travail.equipement === equipementVal;

                    // Filtre type (AA/TPAA)
                    const matchType = !typeVal || travail.typeTravail === typeVal;

                    // Filtre jour (jeudi/hors-jeudi)
                    const matchJour = !jourVal || travail.jourArret === jourVal;

                    // Filtre visite sur place
                    const hasVisite = this.visitesData[index]?.aVoirSurPlace || false;
                    const matchVisite = !visiteVal ||
                        (visiteVal === 'oui' && hasVisite) ||
                        (visiteVal === 'non' && !hasVisite);

                    const visible = matchSearch && matchEquipement && matchType && matchJour && matchVisite;
                    card.style.display = visible ? '' : 'none';
                    if (visible) visibleCount++;
                });

                // Mettre à jour le compteur
                const countEl = document.getElementById('filterCount');
                if (countEl) {
                    countEl.textContent = `${visibleCount} / ${this.travaux.length} travaux`;
                }
            },

            // ========== FONCTIONS VISITE SUR PLACE ==========

            async toggleVisite(index) {
                // Initialiser si nécessaire
                if (!this.visitesData[index]) {
                    this.visitesData[index] = { aVoirSurPlace: false, photos: [], mesures: '' };
                }

                // Toggle
                this.visitesData[index].aVoirSurPlace = !this.visitesData[index].aVoirSurPlace;

                // Mettre à jour l'UI
                const container = document.getElementById(`visite-container-${index}`);
                const section = document.getElementById(`visite-section-${index}`);
                const card = document.querySelector(`.travail-card[data-index="${index}"]`);

                if (this.visitesData[index].aVoirSurPlace) {
                    container?.classList.add('checked');
                    section?.classList.add('show');
                    // Ajouter le badge dans le header de la carte
                    const badgesDiv = card?.querySelector('.travail-badges');
                    if (badgesDiv && !badgesDiv.querySelector('.badge-visite')) {
                        badgesDiv.innerHTML = '<span class="badge badge-visite">📍 À voir sur place</span>' + badgesDiv.innerHTML;
                    }
                } else {
                    container?.classList.remove('checked');
                    section?.classList.remove('show');
                    // Retirer le badge
                    const badge = card?.querySelector('.badge-visite');
                    if (badge) badge.remove();
                }

                // Mettre à jour le compteur dans le header
                this.updateVisitesCounter();

                // Sauvegarder
                await this.sauvegarderVisitesData();
            },

            updateVisitesCounter() {
                const nbVisites = this.visitesData.filter(v => v?.aVoirSurPlace).length;
                const headerVisites = document.getElementById('header-visites');
                if (headerVisites) {
                    headerVisites.style.color = nbVisites > 0 ? '#fce7f3' : 'inherit';
                    headerVisites.querySelector('.header-stat-num').textContent = nbVisites;
                }
            },

            async ajouterPhotoVisite(index, files) {
                if (!files || files.length === 0) return;

                // Initialiser si nécessaire
                if (!this.visitesData[index]) {
                    this.visitesData[index] = { aVoirSurPlace: true, photos: [], mesures: '' };
                }
                if (!this.visitesData[index].photos) {
                    this.visitesData[index].photos = [];
                }

                // Compresser et ajouter chaque photo
                for (const file of files) {
                    if (this.visitesData[index].photos.length >= 10) {
                        this.showToast('Maximum 10 photos par travail', 'error');
                        break;
                    }

                    try {
                        const compressed = await this.compressImage(file, 1200, 0.8);
                        this.visitesData[index].photos.push(compressed);
                    } catch (error) {
                        console.error('Erreur compression:', error);
                    }
                }

                // Mettre à jour l'affichage des photos
                this.updateVisitePhotosUI(index);

                // Sauvegarder
                await this.sauvegarderVisitesData();
                this.showToast('📷 Photo(s) ajoutée(s)!');

                // Reset input
                document.getElementById(`visite-photo-input-${index}`).value = '';
            },

            async supprimerPhotoVisite(index, photoIndex) {
                if (!this.visitesData[index]?.photos) return;

                this.visitesData[index].photos.splice(photoIndex, 1);

                // Mettre à jour l'affichage
                this.updateVisitePhotosUI(index);

                // Sauvegarder
                await this.sauvegarderVisitesData();
                this.showToast('Photo supprimée');
            },

            updateVisitePhotosUI(index) {
                const container = document.getElementById(`visite-photos-${index}`);
                if (!container) return;

                const photos = this.visitesData[index]?.photos || [];

                if (photos.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = `
                    <div class="visite-photos-grid">
                        ${photos.map((photo, photoIndex) => `
                            <div class="visite-photo-item">
                                <img src="${photo}" class="visite-photo-img" onclick="PortailEntrepreneur.showPhoto('${photo}')">
                                <button class="visite-photo-delete" onclick="PortailEntrepreneur.supprimerPhotoVisite(${index}, ${photoIndex})">×</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            async sauvegarderMesures(index, value) {
                // Initialiser si nécessaire
                if (!this.visitesData[index]) {
                    this.visitesData[index] = { aVoirSurPlace: true, photos: [], mesures: '' };
                }

                this.visitesData[index].mesures = value;

                // Sauvegarder
                await this.sauvegarderVisitesData();
            },

            // Nettoyer un tableau pour Firebase (remplacer undefined par valeurs par défaut)
            cleanArrayForFirebase(arr, defaultValue) {
                const result = [];
                const length = Math.max(arr.length, this.travaux.length);
                for (let i = 0; i < length; i++) {
                    if (typeof defaultValue === 'object') {
                        const v = arr[i];
                        if (!v) {
                            result[i] = { ...defaultValue };
                        } else {
                            // Nettoyer chaque propriété
                            const clean = {};
                            for (const key in defaultValue) {
                                clean[key] = v[key] !== undefined ? v[key] : defaultValue[key];
                            }
                            result[i] = clean;
                        }
                    } else {
                        result[i] = arr[i] !== undefined ? arr[i] : defaultValue;
                    }
                }
                return result;
            },

            async sauvegarderVisitesData() {
                try {
                    // Nettoyer les données pour éviter les undefined (Firebase les refuse)
                    const cleanVisitesData = this.cleanArrayForFirebase(
                        this.visitesData,
                        { aVoirSurPlace: false, photos: [], mesures: '' }
                    );

                    const cleanCommentairesTravaux = this.cleanArrayForFirebase(
                        this.commentairesTravaux,
                        ''
                    );

                    const cleanUploadsData = this.cleanArrayForFirebase(
                        this.uploadsData,
                        { photos: [], documents: [] }
                    );

                    await firebase.firestore()
                        .collection('commentaires_entrepreneurs')
                        .doc(this.appelId)
                        .set({
                            commentaire: this.commentaireEntrepreneur || '',
                            commentairesTravaux: cleanCommentairesTravaux,
                            visitesData: cleanVisitesData,
                            uploadsData: cleanUploadsData,
                            entreprise: this.entreprise || '',
                            dateModification: new Date().toISOString()
                        }, { merge: true });
                } catch (error) {
                    console.error('Erreur sauvegarde visites:', error);
                    this.showToast('❌ Erreur de sauvegarde', 'error');
                }
            },

            compressImage(file, maxSize = 1200, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            // Redimensionner si nécessaire
                            if (width > maxSize || height > maxSize) {
                                if (width > height) {
                                    height = (height / width) * maxSize;
                                    width = maxSize;
                                } else {
                                    width = (width / height) * maxSize;
                                    height = maxSize;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            // ========== FONCTIONS UPLOAD PHOTOS/DOCUMENTS ENTREPRENEUR ==========

            renderEntrepreneurPhotos(index) {
                const photos = this.uploadsData[index]?.photos || [];
                if (photos.length === 0) return '';

                return `
                    <div class="entrepreneur-photos-grid">
                        ${photos.map((photo, photoIndex) => `
                            <div class="entrepreneur-photo-item">
                                <img src="${photo}" class="entrepreneur-photo-img" onclick="PortailEntrepreneur.showPhoto('${photo}')">
                                <button class="entrepreneur-photo-delete" onclick="PortailEntrepreneur.supprimerPhotoEntrepreneur(${index}, ${photoIndex})">×</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderEntrepreneurDocs(index) {
                const docs = this.uploadsData[index]?.documents || [];
                if (docs.length === 0) return '';

                return `
                    <div class="entrepreneur-docs-list">
                        ${docs.map((doc, docIndex) => `
                            <div class="entrepreneur-doc-item">
                                <span class="entrepreneur-doc-icon">${this.getDocIcon(doc.name)}</span>
                                <div class="entrepreneur-doc-info">
                                    <div class="entrepreneur-doc-name">${doc.name}</div>
                                    <div class="entrepreneur-doc-size">${this.formatFileSize(doc.size)}</div>
                                </div>
                                <a href="${doc.data}" download="${doc.name}" class="entrepreneur-doc-view">Télécharger</a>
                                <button class="entrepreneur-doc-delete" onclick="PortailEntrepreneur.supprimerDocEntrepreneur(${index}, ${docIndex})">Supprimer</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            getDocIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const icons = {
                    'pdf': '📕',
                    'doc': '📘',
                    'docx': '📘',
                    'xls': '📗',
                    'xlsx': '📗',
                    'txt': '📄'
                };
                return icons[ext] || '📄';
            },

            formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            },

            async ajouterPhotosEntrepreneur(index, files) {
                if (!files || files.length === 0) return;

                // Initialiser si nécessaire
                if (!this.uploadsData[index]) {
                    this.uploadsData[index] = { photos: [], documents: [] };
                }
                if (!this.uploadsData[index].photos) {
                    this.uploadsData[index].photos = [];
                }

                // Compresser et ajouter chaque photo
                for (const file of files) {
                    if (this.uploadsData[index].photos.length >= 20) {
                        this.showToast('Maximum 20 photos par travail', 'error');
                        break;
                    }

                    try {
                        const compressed = await this.compressImage(file, 1200, 0.8);
                        this.uploadsData[index].photos.push(compressed);
                    } catch (error) {
                        console.error('Erreur compression:', error);
                    }
                }

                // Mettre à jour l'affichage
                this.updateEntrepreneurPhotosUI(index);

                // Sauvegarder
                await this.sauvegarderUploadsData();
                this.showToast(`🖼️ ${files.length} photo(s) ajoutée(s)!`);

                // Reset input
                document.getElementById(`entrepreneur-photos-input-${index}`).value = '';
            },

            async supprimerPhotoEntrepreneur(index, photoIndex) {
                if (!this.uploadsData[index]?.photos) return;

                this.uploadsData[index].photos.splice(photoIndex, 1);
                this.updateEntrepreneurPhotosUI(index);
                await this.sauvegarderUploadsData();
                this.showToast('Photo supprimée');
            },

            updateEntrepreneurPhotosUI(index) {
                const container = document.getElementById(`entrepreneur-photos-${index}`);
                if (container) {
                    container.innerHTML = this.renderEntrepreneurPhotos(index);
                }
            },

            async ajouterDocsEntrepreneur(index, files) {
                if (!files || files.length === 0) return;

                // Initialiser si nécessaire
                if (!this.uploadsData[index]) {
                    this.uploadsData[index] = { photos: [], documents: [] };
                }
                if (!this.uploadsData[index].documents) {
                    this.uploadsData[index].documents = [];
                }

                // Lire et ajouter chaque document
                for (const file of files) {
                    if (this.uploadsData[index].documents.length >= 10) {
                        this.showToast('Maximum 10 documents par travail', 'error');
                        break;
                    }

                    // Limiter la taille (5MB max par fichier)
                    if (file.size > 5 * 1024 * 1024) {
                        this.showToast(`${file.name} trop volumineux (max 5MB)`, 'error');
                        continue;
                    }

                    try {
                        const base64 = await this.readFileAsBase64(file);
                        this.uploadsData[index].documents.push({
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: base64
                        });
                    } catch (error) {
                        console.error('Erreur lecture fichier:', error);
                    }
                }

                // Mettre à jour l'affichage
                this.updateEntrepreneurDocsUI(index);

                // Sauvegarder
                await this.sauvegarderUploadsData();
                this.showToast(`📄 ${files.length} document(s) ajouté(s)!`);

                // Reset input
                document.getElementById(`entrepreneur-docs-input-${index}`).value = '';
            },

            readFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            async supprimerDocEntrepreneur(index, docIndex) {
                if (!this.uploadsData[index]?.documents) return;

                this.uploadsData[index].documents.splice(docIndex, 1);
                this.updateEntrepreneurDocsUI(index);
                await this.sauvegarderUploadsData();
                this.showToast('Document supprimé');
            },

            updateEntrepreneurDocsUI(index) {
                const container = document.getElementById(`entrepreneur-docs-${index}`);
                if (container) {
                    container.innerHTML = this.renderEntrepreneurDocs(index);
                }
            },

            async sauvegarderUploadsData() {
                try {
                    // Nettoyer les données pour éviter les undefined (Firebase les refuse)
                    const cleanVisitesData = this.cleanArrayForFirebase(
                        this.visitesData,
                        { aVoirSurPlace: false, photos: [], mesures: '' }
                    );

                    const cleanCommentairesTravaux = this.cleanArrayForFirebase(
                        this.commentairesTravaux,
                        ''
                    );

                    const cleanUploadsData = this.cleanArrayForFirebase(
                        this.uploadsData,
                        { photos: [], documents: [] }
                    );

                    await firebase.firestore()
                        .collection('commentaires_entrepreneurs')
                        .doc(this.appelId)
                        .set({
                            commentaire: this.commentaireEntrepreneur || '',
                            commentairesTravaux: cleanCommentairesTravaux,
                            visitesData: cleanVisitesData,
                            uploadsData: cleanUploadsData,
                            entreprise: this.entreprise || '',
                            dateModification: new Date().toISOString()
                        }, { merge: true });
                } catch (error) {
                    console.error('Erreur sauvegarde uploads:', error);
                    this.showToast('❌ Erreur de sauvegarde', 'error');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            PortailEntrepreneur.init();
        });

        // Arrêter la synchronisation quand on quitte la page
        window.addEventListener('beforeunload', () => {
            PortailEntrepreneur.stopRealtimeSync();
        });
    </script>
</body>
</html>
