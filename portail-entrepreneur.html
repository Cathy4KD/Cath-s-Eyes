<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Soumission - Arr√™t Annuel</title>
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#1e3a5f">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- PDF pour export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #1e293b;
            min-height: 100vh;
        }

        /* Header */
        .portal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 25px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .portal-title h1 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .portal-title p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .entreprise-badge {
            background: #f59e0b;
            color: #000;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .header-stats {
            display: flex;
            gap: 25px;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-num {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
        }

        /* Main content */
        .portal-content {
            max-width: 100%;
            margin: 0;
            padding: 20px;
        }

        /* Info banner */
        .info-banner {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .info-banner-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .info-banner-icon {
            font-size: 2rem;
        }

        .info-banner h2 {
            font-size: 1.1rem;
            color: #1e293b;
        }

        .info-banner p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .date-limite {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 12px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .date-limite-label {
            font-size: 0.75rem;
            color: #92400e;
            text-transform: uppercase;
            font-weight: 600;
        }

        .date-limite-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #b45309;
        }

        /* Section title */
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #1e3a5f;
            display: inline-block;
        }

        /* Travail card - compact et pleine largeur */
        .travail-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            overflow: hidden;
            border-left: 4px solid #1e3a5f;
        }

        .travail-header {
            background: #f8fafc;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .travail-ot {
            background: #1e3a5f;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .travail-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-tpaa {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-aa {
            background: #ede9fe;
            color: #6d28d9;
        }

        .badge-aa-tpaa {
            background: linear-gradient(135deg, #ede9fe 50%, #dbeafe 50%);
            color: #4c1d95;
        }

        .badge-jeudi {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-hors-jeudi {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-priorite-haute {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-priorite-moyenne {
            background: #fef3c7;
            color: #b45309;
        }

        .badge-visite {
            background: #fce7f3;
            color: #be185d;
        }

        /* Case √† cocher "√Ä voir sur place" */
        .visite-checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);
            border-radius: 8px;
            margin-top: 12px;
            border: 2px solid #f9a8d4;
            cursor: pointer;
            transition: all 0.2s;
        }

        .visite-checkbox-container:hover {
            border-color: #ec4899;
            background: linear-gradient(135deg, #fbcfe8 0%, #fce7f3 100%);
        }

        .visite-checkbox-container.checked {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            border-color: #be185d;
        }

        .visite-checkbox-container.checked .visite-label {
            color: white;
        }

        .visite-checkbox-container.checked .visite-icon {
            color: white;
        }

        .visite-checkbox {
            width: 24px;
            height: 24px;
            border: 3px solid #ec4899;
            border-radius: 6px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .visite-checkbox-container.checked .visite-checkbox {
            background: white;
            border-color: white;
        }

        .visite-checkbox-check {
            display: none;
            color: #ec4899;
            font-size: 16px;
            font-weight: bold;
        }

        .visite-checkbox-container.checked .visite-checkbox-check {
            display: block;
        }

        .visite-icon {
            font-size: 1.5rem;
            color: #ec4899;
        }

        .visite-label {
            font-weight: 600;
            color: #be185d;
            font-size: 1rem;
        }

        .visite-sublabel {
            font-size: 0.8rem;
            color: #9d174d;
            opacity: 0.8;
        }

        .visite-checkbox-container.checked .visite-sublabel {
            color: rgba(255,255,255,0.9);
        }

        /* Section visite sur place (photos + mesures) */
        .visite-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #fdf2f8;
            border-radius: 10px;
            border: 2px dashed #f9a8d4;
        }

        .visite-section.show {
            display: block;
        }

        .visite-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #be185d;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .visite-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .visite-btn {
            flex: 1;
            min-width: 140px;
            padding: 15px 20px;
            border: 2px solid #ec4899;
            border-radius: 10px;
            background: white;
            color: #be185d;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .visite-btn:hover {
            background: #fce7f3;
            transform: translateY(-2px);
        }

        .visite-btn:active {
            transform: translateY(0);
        }

        .visite-btn-icon {
            font-size: 2rem;
        }

        .visite-btn-label {
            font-size: 0.9rem;
        }

        /* Photos sur place */
        .visite-photos-container {
            margin-top: 12px;
        }

        .visite-photos-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .visite-photo-item {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .visite-photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #f9a8d4;
            cursor: pointer;
        }

        .visite-photo-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mesures sur place */
        .visite-mesures-container {
            margin-top: 12px;
        }

        .visite-mesure-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #f9a8d4;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            background: white;
        }

        .visite-mesure-input:focus {
            outline: none;
            border-color: #ec4899;
        }

        .visite-mesure-input::placeholder {
            color: #d946ef;
            opacity: 0.6;
        }

        /* Mobile optimizations pour visite et utilisation terrain */
        @media (max-width: 600px) {
            .visite-checkbox-container {
                padding: 18px;
            }

            .visite-label {
                font-size: 1.2rem;
            }

            .visite-sublabel {
                font-size: 0.9rem;
            }

            .visite-btn {
                padding: 25px;
                min-width: 100%;
            }

            .visite-btn-icon {
                font-size: 3rem;
            }

            .visite-btn-label {
                font-size: 1.1rem;
            }

            .visite-photo-item {
                width: 90px;
                height: 90px;
            }

            .visite-photo-delete {
                width: 30px;
                height: 30px;
                font-size: 18px;
            }

            .visite-mesure-input {
                font-size: 1.1rem;
                min-height: 100px;
                padding: 15px;
            }

            /* Boutons et inputs plus grands pour le tactile */
            .filter-input, .filter-select {
                padding: 12px 15px;
                font-size: 1rem;
                min-height: 48px;
            }

            .comment-travail-input {
                font-size: 1rem;
                padding: 12px;
                min-height: 100px;
            }

            .btn {
                padding: 15px 25px;
                font-size: 1.1rem;
                min-height: 52px;
            }

            /* Header stats plus compact */
            .header-stats {
                gap: 15px;
            }

            .header-stat-num {
                font-size: 1.5rem;
            }

            /* Info boxes plus lisibles */
            .info-box {
                padding: 10px 14px;
            }

            .info-box-value {
                font-size: 0.95rem;
            }

            /* Toast plus visible */
            .toast {
                bottom: 80px;
                left: 20px;
                right: 20px;
                text-align: center;
                font-size: 1rem;
            }
        }

        /* Tr√®s petits √©crans */
        @media (max-width: 400px) {
            .portal-header {
                padding: 15px;
            }

            .portal-title h1 {
                font-size: 1.3rem;
            }

            .entreprise-badge {
                font-size: 1rem;
                padding: 8px 15px;
            }

            .visite-actions {
                flex-direction: column;
            }

            .visite-btn {
                min-width: 100%;
            }
        }

        /* Mode paysage mobile - optimis√© terrain */
        @media (max-width: 900px) and (orientation: landscape) {
            .visite-actions {
                flex-direction: row;
            }

            .visite-btn {
                min-width: auto;
                flex: 1;
            }
        }

        /* Section upload photos/documents entrepreneur */
        .entrepreneur-uploads-section {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 10px;
            border: 2px solid #bae6fd;
        }

        .uploads-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .uploads-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .upload-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px 15px;
            border: 2px dashed #0ea5e9;
            border-radius: 10px;
            background: white;
            color: #0369a1;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: #e0f2fe;
            border-color: #0284c7;
        }

        .upload-btn .icon {
            font-size: 1.3rem;
        }

        /* Grille photos entrepreneur */
        .entrepreneur-photos-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .entrepreneur-photo-item {
            position: relative;
            width: 90px;
            height: 90px;
        }

        .entrepreneur-photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #0ea5e9;
            cursor: pointer;
        }

        .entrepreneur-photo-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Liste documents entrepreneur */
        .entrepreneur-docs-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .entrepreneur-doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }

        .entrepreneur-doc-icon {
            font-size: 1.5rem;
        }

        .entrepreneur-doc-info {
            flex: 1;
            min-width: 0;
        }

        .entrepreneur-doc-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entrepreneur-doc-size {
            font-size: 0.75rem;
            color: #64748b;
        }

        .entrepreneur-doc-delete {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .entrepreneur-doc-delete:hover {
            background: #fee2e2;
        }

        .entrepreneur-doc-view {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .entrepreneur-doc-view:hover {
            background: #dbeafe;
        }

        /* Mobile uploads */
        @media (max-width: 600px) {
            .uploads-row {
                flex-direction: column;
            }

            .upload-btn {
                min-width: 100%;
                padding: 15px;
            }

            .entrepreneur-photo-item {
                width: 80px;
                height: 80px;
            }

            .entrepreneur-doc-item {
                flex-wrap: wrap;
            }

            .entrepreneur-doc-info {
                width: 100%;
                order: 1;
            }

            .entrepreneur-doc-view,
            .entrepreneur-doc-delete {
                order: 2;
                flex: 1;
                text-align: center;
            }
        }

        .travail-body {
            padding: 12px 15px;
        }

        .travail-description {
            font-size: 1rem;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        /* Grille d'infos - layout horizontal compact */
        .travail-infos {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .info-box {
            background: #f8fafc;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .info-box-label {
            font-size: 0.65rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-box-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: #1e293b;
        }

        /* Layout avec photo √† droite */
        .travail-content-wrapper {
            display: flex;
            gap: 20px;
        }

        .travail-card.has-photo .travail-body {
            flex: 1;
            min-width: 0;
        }

        .travail-photo-side {
            flex-shrink: 0;
            width: 220px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-self: stretch;
        }

        .photo-preview {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
            flex: 1;
            min-height: 180px;
        }

        .photo-preview:hover {
            transform: scale(1.02);
            border-color: #1e3a5f;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .more-photos {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .photo-thumb-small {
            width: 68px;
            height: 68px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .photo-thumb-small:hover {
            transform: scale(1.1);
            border-color: #1e3a5f;
        }

        /* Photos - inline (pour compatibilit√© si pas de layout 2 colonnes) */
        .travail-photos {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .photos-title {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .photos-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .photo-thumb {
            width: 80px;
            height: 80px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .photo-thumb:hover {
            transform: scale(1.05);
            border-color: #1e3a5f;
        }

        /* Mobile : photo en dessous */
        @media (max-width: 600px) {
            .travail-content-wrapper {
                flex-direction: column-reverse;
            }

            .travail-photo-side {
                width: 100%;
                flex-direction: row;
                align-items: center;
            }

            .photo-preview {
                width: 120px;
                height: 90px;
            }

            .more-photos {
                flex: 1;
            }
        }

        /* Documents */
        .travail-documents {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .document-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #eff6ff;
            color: #1e40af;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            margin-right: 10px;
            margin-bottom: 8px;
        }

        .document-link:hover {
            background: #dbeafe;
        }

        /* Commentaire gestionnaire (jaune) */
        .travail-commentaire {
            margin-top: 10px;
            padding: 10px 12px;
            background: #fffbeb;
            border-radius: 6px;
            border-left: 3px solid #f59e0b;
        }

        .commentaire-label {
            font-size: 0.7rem;
            color: #92400e;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .commentaire-text {
            color: #78350f;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Section Type de travail (AA/TPAA + Jour) */
        .travail-type-section {
            margin-top: 12px;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .type-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .type-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .type-separator {
            color: #cbd5e1;
            font-weight: 300;
            margin: 0 4px;
        }

        .badge-large {
            padding: 6px 12px !important;
            font-size: 0.9rem !important;
            font-weight: 600;
        }

        /* Ligne des deux commentaires c√¥te √† c√¥te */
        .comments-row {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .comments-row .travail-commentaire {
            flex: 1;
            margin-top: 0;
            display: flex;
            flex-direction: column;
        }

        .comments-row .travail-commentaire .commentaire-text {
            flex: 1;
            min-height: 80px;
        }

        .comments-row .entrepreneur-travail-comment {
            flex: 1;
            margin-top: 0;
            display: flex;
            flex-direction: column;
        }

        /* Commentaire entrepreneur par travail */
        .entrepreneur-travail-comment {
            padding: 10px 12px;
            background: #f0fdf4;
            border-radius: 6px;
            border-left: 3px solid #10b981;
        }

        .entrepreneur-travail-comment .commentaire-label {
            color: #065f46;
            margin-bottom: 8px;
        }

        .comment-travail-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d1fae5;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            flex: 1;
        }

        .comment-travail-input:focus {
            outline: none;
            border-color: #10b981;
        }

        /* Filtres de recherche */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        .filter-input, .filter-select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .filter-count {
            margin-left: auto;
            font-size: 0.9rem;
            color: #64748b;
        }

        @media (max-width: 600px) {
            .comments-row {
                flex-direction: column;
            }

            .filters-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }

            .filter-input, .filter-select {
                width: 100%;
            }
        }

        .comment-travail-input::placeholder {
            color: #94a3b8;
        }

        /* Plan section */
        .plan-section {
            margin-bottom: 30px;
        }

        .plan-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .plan-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .plan-image:hover {
            transform: scale(1.02);
        }

        /* Section commentaire entrepreneur */
        .entrepreneur-comment-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 5px solid #10b981;
        }

        .comment-box {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-box textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .comment-box textarea:focus {
            outline: none;
            border-color: #10b981;
        }

        .comment-box .btn {
            align-self: flex-start;
        }

        .comment-saved {
            color: #10b981;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 5px;
        }

        .comment-saved.show {
            display: flex;
        }

        /* Boutons */
        .actions-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #1e3a5f;
            color: white;
        }

        .btn-primary:hover {
            background: #2d5a87;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        /* Loading */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #1e3a5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #64748b;
            font-size: 1rem;
        }

        /* Error */
        .error-container {
            text-align: center;
            padding: 80px 20px;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 1.5rem;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .error-message {
            color: #64748b;
        }

        /* Photo modal */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .photo-modal.show {
            display: flex;
        }

        .photo-modal img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #ef4444;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-stats {
                justify-content: center;
            }

            .info-banner {
                flex-direction: column;
                text-align: center;
            }

            .travail-infos {
                grid-template-columns: 1fr 1fr;
            }

            .photo-thumb {
                width: 80px;
                height: 80px;
            }
        }

        /* Print styles */
        @media print {
            .portal-header {
                background: #1e3a5f !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .actions-bar {
                display: none;
            }

            .travail-card {
                break-inside: avoid;
            }

            .help-btn {
                display: none !important;
            }
        }

        /* Bouton d'aide flottant */
        .help-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            z-index: 999;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .help-btn:active {
            transform: scale(0.95);
        }

        /* Modal d'aide */
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
            overflow-y: auto;
        }

        .help-modal.show {
            display: flex;
        }

        .help-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .help-modal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .help-modal-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .help-modal-header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .help-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .help-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .help-modal-body {
            padding: 30px;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .help-section-title .icon {
            font-size: 1.5rem;
        }

        .help-text {
            color: #475569;
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .help-text p {
            margin-bottom: 12px;
        }

        .help-text ul {
            margin: 12px 0;
            padding-left: 25px;
        }

        .help-text li {
            margin-bottom: 8px;
        }

        .help-highlight {
            background: #fef3c7;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #f59e0b;
            margin: 15px 0;
        }

        .help-highlight-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
        }

        .help-tip {
            background: #ecfdf5;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #10b981;
            margin: 15px 0;
        }

        .help-tip-title {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 8px;
        }

        .help-warning {
            background: #fef2f2;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #ef4444;
            margin: 15px 0;
        }

        .help-warning-title {
            font-weight: 600;
            color: #b91c1c;
            margin-bottom: 8px;
        }

        .help-feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .help-feature-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .help-feature-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .help-feature-card h4 {
            color: #1e3a5f;
            margin-bottom: 8px;
        }

        .help-feature-card p {
            font-size: 0.85rem;
            color: #64748b;
        }

        .help-step {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .help-step-num {
            background: #1e3a5f;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .help-step-content h4 {
            color: #1e293b;
            margin-bottom: 5px;
        }

        .help-step-content p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .help-badge-demo {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 3px;
        }

        .help-badge-demo.visite {
            background: #fce7f3;
            color: #be185d;
        }

        .help-badge-demo.aa {
            background: #ede9fe;
            color: #6d28d9;
        }

        .help-badge-demo.tpaa {
            background: #dbeafe;
            color: #1e40af;
        }

        .help-badge-demo.jeudi {
            background: #fef3c7;
            color: #92400e;
        }

        /* Mobile pour aide */
        @media (max-width: 600px) {
            .help-btn {
                bottom: 20px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.6rem;
            }

            .help-modal-content {
                max-height: 95vh;
                margin: 10px;
            }

            .help-modal-header {
                padding: 20px;
            }

            .help-modal-header h2 {
                font-size: 1.3rem;
            }

            .help-modal-body {
                padding: 20px;
            }

            .help-section-title {
                font-size: 1.1rem;
            }

            .help-feature-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p class="loading-text">Chargement du portail...</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Bouton d'aide flottant -->
    <button class="help-btn" onclick="PortailEntrepreneur.openHelp()" title="Aide et guide d'utilisation">?</button>

    <!-- Modal d'aide -->
    <div class="help-modal" id="helpModal" onclick="PortailEntrepreneur.closeHelpOnBackdrop(event)">
        <div class="help-modal-content" onclick="event.stopPropagation()">
            <div class="help-modal-header">
                <h2>Guide d'utilisation du portail</h2>
                <p>Tout ce que vous devez savoir pour bien utiliser ce portail</p>
                <button class="help-modal-close" onclick="PortailEntrepreneur.closeHelp()">&times;</button>
            </div>
            <div class="help-modal-body">
                <!-- Section 1: Apercu -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üìã</span> Qu'est-ce que ce portail ?</h3>
                    <div class="help-text">
                        <p>Ce portail vous permet de consulter les travaux pour lesquels une soumission est demandee et d'y repondre directement en ligne.</p>

                        <div class="help-feature-grid">
                            <div class="help-feature-card">
                                <div class="icon">üìÑ</div>
                                <h4>Consulter</h4>
                                <p>Voir tous les details des travaux a soumissionner</p>
                            </div>
                            <div class="help-feature-card">
                                <div class="icon">üí¨</div>
                                <h4>Commenter</h4>
                                <p>Ajouter vos remarques et questions</p>
                            </div>
                            <div class="help-feature-card">
                                <div class="icon">üìç</div>
                                <h4>Planifier</h4>
                                <p>Marquer les travaux a voir sur place</p>
                            </div>
                            <div class="help-feature-card">
                                <div class="icon">üì∑</div>
                                <h4>Documenter</h4>
                                <p>Prendre des photos et notes sur le terrain</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: En-tete -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üîù</span> L'en-tete du portail</h3>
                    <div class="help-text">
                        <p>L'en-tete affiche les informations principales :</p>
                        <ul>
                            <li><strong>Nom de votre entreprise</strong> - Badge orange avec le nom de l'entrepreneur</li>
                            <li><strong>Nombre de travaux</strong> - Combien de travaux sont inclus dans cet appel</li>
                            <li><strong>Heures estimees</strong> - Total des heures estimees pour l'ensemble</li>
                            <li><strong>Visites</strong> - Nombre de travaux marques "a voir sur place"</li>
                        </ul>

                        <div class="help-highlight">
                            <div class="help-highlight-title">Date limite</div>
                            Si une date limite est definie, elle s'affiche dans un encadre jaune. Assurez-vous de completer votre soumission avant cette date.
                        </div>
                    </div>
                </div>

                <!-- Section 3: Filtres -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üîç</span> Les filtres de recherche</h3>
                    <div class="help-text">
                        <p>Utilisez les filtres pour trouver rapidement les travaux qui vous interessent :</p>
                        <ul>
                            <li><strong>Recherche</strong> - Tapez un mot-cle (OT, description, equipement)</li>
                            <li><strong>Equipement</strong> - Filtrer par equipement specifique</li>
                            <li><strong>Type</strong> - AA (Arret Annuel), TPAA, ou les deux</li>
                            <li><strong>Jour</strong> - Jeudi d'arret ou Hors jeudi</li>
                            <li><strong>Visite sur place</strong> - Voir uniquement les travaux a visiter</li>
                        </ul>

                        <div class="help-tip">
                            <div class="help-tip-title">Astuce terrain</div>
                            Utilisez le filtre "A voir sur place" quand vous etes sur le site pour voir uniquement les travaux que vous devez inspecter.
                        </div>
                    </div>
                </div>

                <!-- Section 4: Cartes de travaux -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üìù</span> Les cartes de travaux</h3>
                    <div class="help-text">
                        <p>Chaque travail est presente dans une carte contenant :</p>
                        <ul>
                            <li><strong>Numero OT</strong> - Identifiant du bon de travail (en haut a gauche)</li>
                            <li><strong>Description</strong> - Detail du travail a realiser</li>
                            <li><strong>Informations</strong> - Equipement, operation, heures, localisation</li>
                            <li><strong>Photos</strong> - Images fournies par le gestionnaire (si disponibles)</li>
                            <li><strong>Type et Jour</strong> - Quand le travail doit etre fait</li>
                        </ul>

                        <p><strong>Badges de statut :</strong></p>
                        <div style="margin: 10px 0;">
                            <span class="help-badge-demo aa">AA</span>
                            <span class="help-badge-demo tpaa">TPAA</span>
                            <span class="help-badge-demo jeudi">Jeudi</span>
                            <span class="help-badge-demo visite">A voir sur place</span>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Commentaires -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üí¨</span> Les commentaires</h3>
                    <div class="help-text">
                        <p>Deux types de commentaires sont disponibles :</p>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #f59e0b;">1</div>
                            <div class="help-step-content">
                                <h4>Note du gestionnaire (jaune)</h4>
                                <p>Informations importantes du gestionnaire concernant ce travail specifique. Lisez-les attentivement.</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #10b981;">2</div>
                            <div class="help-step-content">
                                <h4>Votre commentaire (vert)</h4>
                                <p>Zone pour ajouter vos remarques, questions ou informations de prix pour ce travail.</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #1e3a5f;">3</div>
                            <div class="help-step-content">
                                <h4>Commentaire global (en bas)</h4>
                                <p>Section pour vos remarques generales sur l'ensemble de la soumission.</p>
                            </div>
                        </div>

                        <div class="help-warning">
                            <div class="help-warning-title">Important</div>
                            N'oubliez pas de cliquer sur "Enregistrer le commentaire" pour sauvegarder vos remarques globales.
                        </div>
                    </div>
                </div>

                <!-- Section 6: Visite sur place -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üìç</span> Fonction "A voir sur place"</h3>
                    <div class="help-text">
                        <p>Cette fonction vous permet de marquer les travaux que vous devez visiter physiquement avant de soumettre votre offre.</p>

                        <div class="help-step">
                            <div class="help-step-num">1</div>
                            <div class="help-step-content">
                                <h4>Cocher la case</h4>
                                <p>Cliquez sur la zone rose "A voir sur place" pour marquer un travail. Un badge apparaitra sur la carte.</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num">2</div>
                            <div class="help-step-content">
                                <h4>Prendre des photos</h4>
                                <p>Une fois coche, vous pouvez prendre des photos directement avec votre telephone (jusqu'a 10 par travail).</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num">3</div>
                            <div class="help-step-content">
                                <h4>Noter vos mesures</h4>
                                <p>Utilisez la zone de texte pour noter vos mesures, observations et remarques prises sur le terrain.</p>
                            </div>
                        </div>

                        <div class="help-tip">
                            <div class="help-tip-title">Utilisation sur mobile</div>
                            Cette fonction est optimisee pour le terrain. Sur votre telephone, le bouton "Prendre photo" ouvrira directement l'appareil photo.
                        </div>
                    </div>
                </div>

                <!-- Section 7: Upload photos et documents -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üìé</span> Ajouter des pieces jointes</h3>
                    <div class="help-text">
                        <p>Pour chaque travail, vous pouvez joindre des photos et des documents :</p>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #0ea5e9;">1</div>
                            <div class="help-step-content">
                                <h4>Ajouter des photos</h4>
                                <p>Cliquez sur "Ajouter photos" pour selectionner plusieurs images depuis votre appareil (jusqu'a 20 par travail).</p>
                            </div>
                        </div>

                        <div class="help-step">
                            <div class="help-step-num" style="background: #0ea5e9;">2</div>
                            <div class="help-step-content">
                                <h4>Ajouter des documents</h4>
                                <p>Cliquez sur "Ajouter documents" pour joindre des fichiers PDF, Word, Excel ou texte (jusqu'a 10 par travail, max 5MB chacun).</p>
                            </div>
                        </div>

                        <div class="help-tip">
                            <div class="help-tip-title">Formats acceptes</div>
                            <ul style="margin-top: 8px;">
                                <li><strong>Photos</strong> : JPG, PNG, GIF et autres formats image</li>
                                <li><strong>Documents</strong> : PDF, DOC, DOCX, XLS, XLSX, TXT</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Section 8: Export -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üìÑ</span> Export et impression</h3>
                    <div class="help-text">
                        <p>En bas de page, vous trouverez deux options :</p>
                        <ul>
                            <li><strong>Exporter en PDF</strong> - Genere un document PDF avec tous les travaux</li>
                            <li><strong>Imprimer</strong> - Ouvre la fenetre d'impression de votre navigateur</li>
                        </ul>
                    </div>
                </div>

                <!-- Section 9: Sauvegarde et synchronisation -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üíæ</span> Sauvegarde et synchronisation</h3>
                    <div class="help-text">
                        <div class="help-tip">
                            <div class="help-tip-title">Synchronisation temps reel!</div>
                            Toutes les modifications sont synchronisees instantanement entre tous les appareils :
                            <ul style="margin-top: 10px;">
                                <li>Les cases "A voir sur place" - mise a jour immediate</li>
                                <li>Les photos et documents - visibles instantanement</li>
                                <li>Les notes de terrain - synchronisees en temps reel</li>
                                <li>Commentaires - partages entre mobile et ordinateur</li>
                            </ul>
                        </div>
                        <div class="help-highlight">
                            <div class="help-highlight-title">Indicateur de synchronisation</div>
                            Un indicateur vert "Synchronise" apparait en haut de l'ecran. Quand une modification arrive d'un autre appareil, vous verrez "Mise a jour recue".
                        </div>
                        <p>Vous pouvez travailler sur plusieurs appareils simultanement - les changements sont visibles partout en temps reel.</p>
                    </div>
                </div>

                <!-- Section 9: Support -->
                <div class="help-section">
                    <h3 class="help-section-title"><span class="icon">üÜò</span> Besoin d'aide ?</h3>
                    <div class="help-text">
                        <p>Si vous rencontrez des difficultes ou avez des questions concernant les travaux :</p>
                        <ul>
                            <li>Utilisez le champ commentaire pour poser vos questions</li>
                            <li>Contactez le gestionnaire qui vous a envoye ce lien</li>
                        </ul>

                        <div class="help-highlight">
                            <div class="help-highlight-title">Rappel</div>
                            Ce portail est accessible uniquement via le lien unique qui vous a ete envoye. Conservez ce lien pour pouvoir y revenir.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="photo-modal" id="photoModal" onclick="PortailEntrepreneur.closePhotoModal()">
        <button class="photo-modal-close" onclick="PortailEntrepreneur.closePhotoModal()">&times;</button>
        <img id="photoModalImg" src="" alt="Photo">
    </div>

    <script src="firebase.js"></script>
    <script>
        const PortailEntrepreneur = {
            appelId: null,
            appelData: null,
            entreprise: null,
            travaux: [],
            unsubscribeCommentaires: null, // Listener temps r√©el
            isUpdatingFromServer: false, // Flag pour √©viter les boucles

            async init() {
                const params = new URLSearchParams(window.location.search);
                this.appelId = params.get('id');

                if (!this.appelId) {
                    this.showError('Lien invalide', 'Ce lien de soumission n\'est pas valide.');
                    return;
                }

                try {
                    await this.loadAppelData();
                    // D√©marrer l'√©coute temps r√©el
                    this.startRealtimeSync();
                } catch (error) {
                    console.error('Erreur:', error);
                    this.showError('Erreur de chargement', 'Impossible de charger les donn√©es.');
                }
            },

            async loadAppelData() {
                const doc = await firebase.firestore().collection('appels_soumission').doc(this.appelId).get();

                if (!doc.exists) {
                    this.showError('Appel non trouv√©', 'Cet appel de soumission n\'existe pas ou a expir√©.');
                    return;
                }

                this.appelData = doc.data();
                this.entreprise = this.appelData.entreprise;
                this.travaux = this.appelData.travaux || [];

                // Charger le commentaire entrepreneur s'il existe
                await this.loadCommentaireEntrepreneur();

                this.render();
            },

            // ========== SYNCHRONISATION TEMPS R√âEL ==========

            startRealtimeSync() {
                // √âcouter les changements sur le document commentaires_entrepreneurs
                this.unsubscribeCommentaires = firebase.firestore()
                    .collection('commentaires_entrepreneurs')
                    .doc(this.appelId)
                    .onSnapshot((doc) => {
                        if (doc.exists && !this.isUpdatingFromServer) {
                            const data = doc.data();
                            this.handleRealtimeUpdate(data);
                        }
                    }, (error) => {
                        console.error('Erreur sync temps r√©el:', error);
                    });

                // Afficher indicateur de connexion
                this.showSyncStatus('connected');
            },

            handleRealtimeUpdate(data) {
                // Comparer et mettre √† jour seulement si diff√©rent
                const newCommentaire = data.commentaire || '';
                const newCommentairesTravaux = data.commentairesTravaux || [];
                const newVisitesData = data.visitesData || [];
                const newUploadsData = data.uploadsData || [];

                let hasChanges = false;

                // V√©rifier si le commentaire global a chang√©
                if (newCommentaire !== this.commentaireEntrepreneur) {
                    this.commentaireEntrepreneur = newCommentaire;
                    const textarea = document.getElementById('commentaireEntrepreneur');
                    if (textarea && document.activeElement !== textarea) {
                        textarea.value = newCommentaire;
                    }
                    hasChanges = true;
                }

                // V√©rifier les commentaires par travail
                if (JSON.stringify(newCommentairesTravaux) !== JSON.stringify(this.commentairesTravaux)) {
                    this.commentairesTravaux = newCommentairesTravaux;
                    newCommentairesTravaux.forEach((comment, index) => {
                        const textarea = document.getElementById(`comment-travail-${index}`);
                        if (textarea && document.activeElement !== textarea) {
                            textarea.value = comment || '';
                        }
                    });
                    hasChanges = true;
                }

                // V√©rifier les donn√©es de visite
                if (JSON.stringify(newVisitesData) !== JSON.stringify(this.visitesData)) {
                    this.visitesData = newVisitesData;
                    this.updateAllVisitesUI();
                    hasChanges = true;
                }

                // V√©rifier les uploads
                if (JSON.stringify(newUploadsData) !== JSON.stringify(this.uploadsData)) {
                    this.uploadsData = newUploadsData;
                    this.updateAllUploadsUI();
                    hasChanges = true;
                }

                if (hasChanges) {
                    this.showSyncNotification();
                    this.updateVisitesCounter();
                }
            },

            updateAllVisitesUI() {
                this.travaux.forEach((t, index) => {
                    const container = document.getElementById(`visite-container-${index}`);
                    const section = document.getElementById(`visite-section-${index}`);
                    const card = document.querySelector(`.travail-card[data-index="${index}"]`);
                    const isChecked = this.visitesData[index]?.aVoirSurPlace || false;

                    if (container) {
                        container.classList.toggle('checked', isChecked);
                    }
                    if (section) {
                        section.classList.toggle('show', isChecked);
                    }

                    // Badge
                    const badgesDiv = card?.querySelector('.travail-badges');
                    if (badgesDiv) {
                        const existingBadge = badgesDiv.querySelector('.badge-visite');
                        if (isChecked && !existingBadge) {
                            badgesDiv.innerHTML = '<span class="badge badge-visite">üìç √Ä voir sur place</span>' + badgesDiv.innerHTML;
                        } else if (!isChecked && existingBadge) {
                            existingBadge.remove();
                        }
                    }

                    // Photos visite
                    this.updateVisitePhotosUI(index);

                    // Mesures
                    const mesuresInput = document.getElementById(`visite-mesures-${index}`);
                    if (mesuresInput && document.activeElement !== mesuresInput) {
                        mesuresInput.value = this.visitesData[index]?.mesures || '';
                    }
                });
            },

            updateAllUploadsUI() {
                this.travaux.forEach((t, index) => {
                    this.updateEntrepreneurPhotosUI(index);
                    this.updateEntrepreneurDocsUI(index);
                });
            },

            showSyncStatus(status) {
                // Cr√©er indicateur si n'existe pas
                let indicator = document.getElementById('syncIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'syncIndicator';
                    indicator.style.cssText = `
                        position: fixed;
                        top: 10px;
                        left: 50%;
                        transform: translateX(-50%);
                        padding: 6px 15px;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        font-weight: 600;
                        z-index: 1000;
                        transition: all 0.3s;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    `;
                    document.body.appendChild(indicator);
                }

                if (status === 'connected') {
                    indicator.innerHTML = 'üü¢ Synchronis√©';
                    indicator.style.background = '#d1fae5';
                    indicator.style.color = '#065f46';
                    // Masquer apr√®s 3 secondes
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                    }, 3000);
                }
            },

            showSyncNotification() {
                const indicator = document.getElementById('syncIndicator');
                if (indicator) {
                    indicator.innerHTML = 'üîÑ Mise √† jour re√ßue';
                    indicator.style.background = '#dbeafe';
                    indicator.style.color = '#1e40af';
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.innerHTML = 'üü¢ Synchronis√©';
                        indicator.style.background = '#d1fae5';
                        indicator.style.color = '#065f46';
                        setTimeout(() => {
                            indicator.style.opacity = '0';
                        }, 2000);
                    }, 1500);
                }
            },

            // Arr√™ter l'√©coute quand on quitte la page
            stopRealtimeSync() {
                if (this.unsubscribeCommentaires) {
                    this.unsubscribeCommentaires();
                    this.unsubscribeCommentaires = null;
                }
            },

            showError(title, message) {
                document.getElementById('app').innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">‚ùå</div>
                        <h1 class="error-title">${title}</h1>
                        <p class="error-message">${message}</p>
                    </div>
                `;
            },

            render() {
                const totalHeures = this.travaux.reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const dateLimite = this.appelData.dateLimite ? new Date(this.appelData.dateLimite) : null;
                const nbVisites = this.visitesData.filter(v => v?.aVoirSurPlace).length;

                document.getElementById('app').innerHTML = `
                    <header class="portal-header">
                        <div class="header-content">
                            <div class="portal-title">
                                <h1>üìã Appel de Soumission</h1>
                                <p>${this.appelData.nomArret || 'Arr√™t Annuel'}</p>
                            </div>
                            <span class="entreprise-badge">${this.entreprise}</span>
                            <div class="header-stats">
                                <div class="header-stat">
                                    <div class="header-stat-num">${this.travaux.length}</div>
                                    <div class="header-stat-label">Travaux</div>
                                </div>
                                <div class="header-stat">
                                    <div class="header-stat-num">${totalHeures}h</div>
                                    <div class="header-stat-label">Estim√©es</div>
                                </div>
                                <div class="header-stat" id="header-visites" style="color: ${nbVisites > 0 ? '#fce7f3' : 'inherit'}">
                                    <div class="header-stat-num">${nbVisites}</div>
                                    <div class="header-stat-label">üìç Visites</div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main class="portal-content">
                        <div class="info-banner">
                            <div class="info-banner-left">
                                <div class="info-banner-icon">üìÑ</div>
                                <div>
                                    <h2>Liste des travaux √† soumissionner</h2>
                                    <p>Veuillez consulter les d√©tails ci-dessous et soumettre votre offre.</p>
                                </div>
                            </div>
                            ${dateLimite ? `
                                <div class="date-limite">
                                    <div class="date-limite-label">Date limite</div>
                                    <div class="date-limite-value">${dateLimite.toLocaleDateString('fr-CA')}</div>
                                </div>
                            ` : ''}
                        </div>

                        ${this.appelData.planImage ? `
                            <div class="plan-section">
                                <h2 class="section-title">üó∫Ô∏è Plan de localisation</h2>
                                <div class="plan-container">
                                    <img src="${this.appelData.planImage}" alt="Plan" class="plan-image" onclick="PortailEntrepreneur.showPhoto('${this.appelData.planImage}')">
                                </div>
                            </div>
                        ` : ''}

                        <h2 class="section-title">üìã Travaux (${this.travaux.length})</h2>

                        <!-- Filtres de recherche -->
                        <div class="filters-section">
                            <div class="filter-group">
                                <span class="filter-label">Recherche</span>
                                <input type="text" class="filter-input" id="filterSearch" placeholder="OT, description..." oninput="PortailEntrepreneur.filterTravaux()">
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">√âquipement</span>
                                <select class="filter-select" id="filterEquipement" onchange="PortailEntrepreneur.filterTravaux()">
                                    <option value="">Tous</option>
                                    ${[...new Set(this.travaux.map(t => t.equipement).filter(Boolean))].sort().map(e => `<option value="${e}">${e}</option>`).join('')}
                                </select>
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Type</span>
                                <select class="filter-select" id="filterType" onchange="PortailEntrepreneur.filterTravaux()">
                                    <option value="">Tous</option>
                                    <option value="aa">AA (Arr√™t Annuel)</option>
                                    <option value="tpaa">TPAA</option>
                                    <option value="aa-tpaa">AA ou TPAA</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Jour</span>
                                <select class="filter-select" id="filterJour" onchange="PortailEntrepreneur.filterTravaux()">
                                    <option value="">Tous</option>
                                    <option value="jeudi">Jeudi d'arr√™t</option>
                                    <option value="hors-jeudi">Hors jeudi</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Visite sur place</span>
                                <select class="filter-select" id="filterVisite" onchange="PortailEntrepreneur.filterTravaux()">
                                    <option value="">Tous</option>
                                    <option value="oui">√Ä voir sur place</option>
                                    <option value="non">Sans visite</option>
                                </select>
                            </div>
                            <span class="filter-count" id="filterCount">${this.travaux.length} travaux</span>
                        </div>

                        <div id="travauxContainer">
                            ${this.travaux.map((t, i) => this.renderTravailCard(t, i)).join('')}
                        </div>

                        <!-- Section commentaire entrepreneur -->
                        <div class="entrepreneur-comment-section">
                            <h2 class="section-title">üí¨ Votre commentaire</h2>
                            <div class="comment-box">
                                <textarea id="commentaireEntrepreneur"
                                          placeholder="Ajoutez vos remarques, questions ou commentaires ici..."
                                          rows="4">${this.commentaireEntrepreneur || ''}</textarea>
                                <button class="btn btn-primary" onclick="PortailEntrepreneur.sauvegarderCommentaire()">
                                    üíæ Enregistrer le commentaire
                                </button>
                            </div>
                        </div>

                        <div class="actions-bar">
                            <button class="btn btn-primary" onclick="PortailEntrepreneur.exportPDF()">
                                üìÑ Exporter en PDF
                            </button>
                            <button class="btn btn-secondary" onclick="window.print()">
                                üñ®Ô∏è Imprimer
                            </button>
                        </div>
                    </main>
                `;
            },

            renderTravailCard(travail, index) {
                // Type de travail : AA, TPAA ou AA ou TPAA (depuis la colonne Type)
                const isTypeAA = travail.typeTravail === 'aa';
                const isTypeTPAA = travail.typeTravail === 'tpaa';
                const isTypeAaOuTpaa = travail.typeTravail === 'aa-tpaa';

                // Jour : Jeudi ou Hors Jeudi (depuis la colonne Jour)
                const isJeudi = travail.jourArret === 'jeudi';
                const isHorsJeudi = travail.jourArret === 'hors-jeudi';

                const hasPhotos = travail.photos && travail.photos.length > 0;

                const aVoirSurPlace = this.visitesData[index]?.aVoirSurPlace || false;

                return `
                    <div class="travail-card ${hasPhotos ? 'has-photo' : ''}" data-index="${index}">
                        <div class="travail-header">
                            <span class="travail-ot">${travail.ot || `#${index + 1}`}</span>
                            <div class="travail-badges">
                                ${aVoirSurPlace ? '<span class="badge badge-visite">üìç √Ä voir sur place</span>' : ''}
                            </div>
                        </div>

                        <div class="travail-content-wrapper">
                            <!-- Colonne gauche : infos -->
                            <div class="travail-body">
                                <div class="travail-description">${travail.description || 'Aucune description'}</div>

                                <div class="travail-infos">
                                    <div class="info-box">
                                        <div class="info-box-label">√âquipement</div>
                                        <div class="info-box-value">${travail.equipement || '-'}</div>
                                    </div>
                                    <div class="info-box">
                                        <div class="info-box-label">Op√©ration</div>
                                        <div class="info-box-value">${travail.operation || '-'}</div>
                                    </div>
                                    <div class="info-box">
                                        <div class="info-box-label">Heures estim√©es</div>
                                        <div class="info-box-value">${travail.estimationHeures || '-'} h</div>
                                    </div>
                                    <div class="info-box">
                                        <div class="info-box-label">Secteur / Localisation</div>
                                        <div class="info-box-value">${travail.localisation || travail.secteur || '-'}</div>
                                    </div>
                                    ${travail.conditions ? `
                                    <div class="info-box">
                                        <div class="info-box-label">Conditions</div>
                                        <div class="info-box-value">${travail.conditions}</div>
                                    </div>
                                    ` : ''}
                                </div>

                                ${(travail.documents && travail.documents.length > 0) ? `
                                    <div class="travail-documents">
                                        <div class="photos-title">üìé Documents</div>
                                        ${travail.documents.map(d => `
                                            <a href="${d.url}" target="_blank" class="document-link">
                                                üìÑ ${d.nom || 'Document'}
                                            </a>
                                        `).join('')}
                                    </div>
                                ` : ''}

                                <!-- Type de travail (AA/TPAA + Jour) sur une seule ligne -->
                                ${(isTypeAA || isTypeTPAA || isTypeAaOuTpaa) ? `
                                    <div class="travail-type-section">
                                        <div class="type-row">
                                            <span class="type-label">Doit √™tre fait pendant :</span>
                                            ${isTypeAA ? '<span class="badge badge-aa badge-large">üîß Arr√™t Annuel</span>' : ''}
                                            ${isTypeTPAA ? '<span class="badge badge-tpaa badge-large">üìã TPAA</span>' : ''}
                                            ${isTypeAaOuTpaa ? '<span class="badge badge-aa-tpaa badge-large">üîßüìã AA ou TPAA</span>' : ''}
                                            ${(isTypeTPAA || isTypeAaOuTpaa) && (isJeudi || isHorsJeudi) ? `
                                                <span class="type-separator">‚Äî</span>
                                                <span class="type-label">Durant :</span>
                                                ${isJeudi ? '<span class="badge badge-jeudi badge-large">üóìÔ∏è Jeudi d\'arr√™t</span>' : ''}
                                                ${isHorsJeudi ? '<span class="badge badge-hors-jeudi badge-large">‚úì Hors jeudi</span>' : ''}
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Commentaires c√¥te √† c√¥te : gestionnaire (jaune) + entrepreneur (vert) -->
                                <div class="comments-row">
                                    ${travail.commentaire ? `
                                        <div class="travail-commentaire">
                                            <div class="commentaire-label">üí¨ Note du gestionnaire</div>
                                            <div class="commentaire-text">${travail.commentaire}</div>
                                        </div>
                                    ` : ''}
                                    <div class="entrepreneur-travail-comment">
                                        <div class="commentaire-label">‚úèÔ∏è Votre commentaire</div>
                                        <textarea class="comment-travail-input"
                                                  id="comment-travail-${index}"
                                                  data-travail-index="${index}"
                                                  placeholder="Remarques, questions ou prix..."
                                                  rows="2">${this.commentairesTravaux[index] || ''}</textarea>
                                    </div>
                                </div>

                                <!-- Case √† cocher "√Ä voir sur place" -->
                                <div class="visite-checkbox-container ${this.visitesData[index]?.aVoirSurPlace ? 'checked' : ''}"
                                     onclick="PortailEntrepreneur.toggleVisite(${index})"
                                     id="visite-container-${index}">
                                    <div class="visite-checkbox">
                                        <span class="visite-checkbox-check">‚úì</span>
                                    </div>
                                    <span class="visite-icon">üìç</span>
                                    <div>
                                        <div class="visite-label">√Ä voir sur place</div>
                                        <div class="visite-sublabel">Cochez si vous devez venir sur site</div>
                                    </div>
                                </div>

                                <!-- Section visite (photos + mesures) - visible si coch√© -->
                                <div class="visite-section ${this.visitesData[index]?.aVoirSurPlace ? 'show' : ''}" id="visite-section-${index}">
                                    <div class="visite-section-title">üì∏ Photos et mesures sur place</div>

                                    <div class="visite-actions">
                                        <label class="visite-btn" for="visite-photo-input-${index}">
                                            <span class="visite-btn-icon">üì∑</span>
                                            <span class="visite-btn-label">Prendre photo</span>
                                            <input type="file"
                                                   id="visite-photo-input-${index}"
                                                   accept="image/*"
                                                   capture="environment"
                                                   multiple
                                                   style="display:none"
                                                   onchange="PortailEntrepreneur.ajouterPhotoVisite(${index}, this.files)">
                                        </label>
                                    </div>

                                    <!-- Photos prises sur place -->
                                    <div class="visite-photos-container" id="visite-photos-${index}">
                                        ${(this.visitesData[index]?.photos || []).length > 0 ? `
                                            <div class="visite-photos-grid">
                                                ${(this.visitesData[index]?.photos || []).map((photo, photoIndex) => `
                                                    <div class="visite-photo-item">
                                                        <img src="${photo}" class="visite-photo-img" onclick="PortailEntrepreneur.showPhoto('${photo}')">
                                                        <button class="visite-photo-delete" onclick="PortailEntrepreneur.supprimerPhotoVisite(${index}, ${photoIndex})">√ó</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- Zone mesures/notes terrain -->
                                    <div class="visite-mesures-container">
                                        <div class="visite-section-title" style="margin-top:15px">üìè Notes et mesures terrain</div>
                                        <textarea class="visite-mesure-input"
                                                  id="visite-mesures-${index}"
                                                  placeholder="Notez vos mesures, observations ou remarques prises sur place..."
                                                  onchange="PortailEntrepreneur.sauvegarderMesures(${index}, this.value)">${this.visitesData[index]?.mesures || ''}</textarea>
                                    </div>
                                </div>

                                <!-- Section upload photos et documents entrepreneur -->
                                <div class="entrepreneur-uploads-section">
                                    <div class="uploads-section-title">üìé Vos pi√®ces jointes</div>
                                    <div class="uploads-row">
                                        <label class="upload-btn" for="entrepreneur-photos-input-${index}">
                                            <span class="icon">üñºÔ∏è</span>
                                            Ajouter photos
                                            <input type="file"
                                                   id="entrepreneur-photos-input-${index}"
                                                   accept="image/*"
                                                   multiple
                                                   style="display:none"
                                                   onchange="PortailEntrepreneur.ajouterPhotosEntrepreneur(${index}, this.files)">
                                        </label>
                                        <label class="upload-btn" for="entrepreneur-docs-input-${index}">
                                            <span class="icon">üìÑ</span>
                                            Ajouter documents
                                            <input type="file"
                                                   id="entrepreneur-docs-input-${index}"
                                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.txt"
                                                   multiple
                                                   style="display:none"
                                                   onchange="PortailEntrepreneur.ajouterDocsEntrepreneur(${index}, this.files)">
                                        </label>
                                    </div>

                                    <!-- Photos upload√©es -->
                                    <div id="entrepreneur-photos-${index}">
                                        ${this.renderEntrepreneurPhotos(index)}
                                    </div>

                                    <!-- Documents upload√©s -->
                                    <div id="entrepreneur-docs-${index}">
                                        ${this.renderEntrepreneurDocs(index)}
                                    </div>
                                </div>
                            </div>

                            <!-- Colonne droite : photo -->
                            ${hasPhotos ? `
                                <div class="travail-photo-side">
                                    <img src="${travail.photos[0]}"
                                         class="photo-preview"
                                         onclick="PortailEntrepreneur.showPhoto('${travail.photos[0]}')"
                                         alt="Photo">
                                    ${travail.photos.length > 1 ? `
                                        <div class="more-photos">
                                            ${travail.photos.slice(1).map(p => `
                                                <img src="${p}" class="photo-thumb-small" onclick="PortailEntrepreneur.showPhoto('${p}')" alt="Photo">
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            commentaireEntrepreneur: '',
            commentairesTravaux: [],
            visitesData: [], // Donn√©es des visites sur place (aVoirSurPlace, photos, mesures)
            uploadsData: [], // Donn√©es des uploads (photos et documents par travail)

            async loadCommentaireEntrepreneur() {
                try {
                    const doc = await firebase.firestore()
                        .collection('commentaires_entrepreneurs')
                        .doc(this.appelId)
                        .get();
                    if (doc.exists) {
                        const data = doc.data();
                        this.commentaireEntrepreneur = data.commentaire || '';
                        this.commentairesTravaux = data.commentairesTravaux || [];
                        this.visitesData = data.visitesData || [];
                        this.uploadsData = data.uploadsData || [];
                    }
                } catch (e) {
                    console.log('Pas de commentaire existant');
                }
            },

            async sauvegarderTousCommentaires() {
                // R√©cup√©rer le commentaire global
                const textareaGlobal = document.getElementById('commentaireEntrepreneur');
                const commentaireGlobal = textareaGlobal ? textareaGlobal.value.trim() : '';

                // R√©cup√©rer tous les commentaires par travail
                const commentairesTravaux = [];
                this.travaux.forEach((t, index) => {
                    const textarea = document.getElementById(`comment-travail-${index}`);
                    commentairesTravaux[index] = textarea ? textarea.value.trim() : '';
                });

                try {
                    await firebase.firestore()
                        .collection('commentaires_entrepreneurs')
                        .doc(this.appelId)
                        .set({
                            commentaire: commentaireGlobal,
                            commentairesTravaux: commentairesTravaux,
                            visitesData: this.visitesData,
                            entreprise: this.entreprise,
                            dateModification: new Date().toISOString()
                        });

                    this.commentaireEntrepreneur = commentaireGlobal;
                    this.commentairesTravaux = commentairesTravaux;
                    this.showToast('‚úÖ Tous les commentaires enregistr√©s!');
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    this.showToast('‚ùå Erreur lors de la sauvegarde', 'error');
                }
            },

            async sauvegarderCommentaire() {
                // Utiliser la nouvelle fonction qui sauvegarde tout
                await this.sauvegarderTousCommentaires();
            },

            showPhoto(src) {
                document.getElementById('photoModalImg').src = src;
                document.getElementById('photoModal').classList.add('show');
            },

            closePhotoModal() {
                document.getElementById('photoModal').classList.remove('show');
            },

            // ========== FONCTIONS AIDE ==========

            openHelp() {
                document.getElementById('helpModal').classList.add('show');
                document.body.style.overflow = 'hidden';
            },

            closeHelp() {
                document.getElementById('helpModal').classList.remove('show');
                document.body.style.overflow = '';
            },

            closeHelpOnBackdrop(event) {
                if (event.target === document.getElementById('helpModal')) {
                    this.closeHelp();
                }
            },

            exportPDF() {
                const { jsPDF } = window.jspdf;
                // Format paysage pour style pr√©sentation
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                const pageWidth = 297;
                const pageHeight = 210;
                const margin = 15;

                // === PAGE DE TITRE ===
                this.renderPDFTitlePage(doc, pageWidth, pageHeight);

                // === UNE PAGE PAR TRAVAIL ===
                this.travaux.forEach((t, index) => {
                    doc.addPage();
                    this.renderPDFTravailPage(doc, t, index, pageWidth, pageHeight, margin);
                });

                // === PAGE DE R√âSUM√â (optionnelle) ===
                doc.addPage();
                this.renderPDFSummaryPage(doc, pageWidth, pageHeight, margin);

                doc.save(`Soumission_${this.entreprise}_${new Date().toISOString().split('T')[0]}.pdf`);
                this.showToast('üìÑ PDF PowerPoint t√©l√©charg√©!');
            },

            renderPDFTitlePage(doc, pageWidth, pageHeight) {
                // Fond bleu fonc√© en haut
                doc.setFillColor(30, 58, 95);
                doc.rect(0, 0, pageWidth, 80, 'F');

                // Titre principal
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(32);
                doc.setFont(undefined, 'bold');
                doc.text('Appel de Soumission', pageWidth / 2, 35, { align: 'center' });

                // Sous-titre
                doc.setFontSize(20);
                doc.setFont(undefined, 'normal');
                doc.text(this.appelData.nomArret || 'Arr√™t Annuel 2025', pageWidth / 2, 55, { align: 'center' });

                // Nom entreprise (badge orange)
                doc.setFillColor(245, 158, 11);
                doc.roundedRect(pageWidth / 2 - 50, 90, 100, 20, 5, 5, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(this.entreprise, pageWidth / 2, 103, { align: 'center' });

                // Stats
                doc.setTextColor(30, 58, 95);
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                const totalHeures = this.travaux.reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const nbVisites = this.visitesData.filter(v => v?.aVoirSurPlace).length;

                doc.text(`${this.travaux.length} travaux`, pageWidth / 2 - 60, 135, { align: 'center' });
                doc.text(`${totalHeures}h estim√©es`, pageWidth / 2, 135, { align: 'center' });
                doc.text(`${nbVisites} visites terrain`, pageWidth / 2 + 60, 135, { align: 'center' });

                // Date limite si existe
                if (this.appelData.dateLimite) {
                    const dateLimite = new Date(this.appelData.dateLimite);
                    doc.setFontSize(12);
                    doc.setTextColor(180, 83, 9);
                    doc.text(`Date limite: ${dateLimite.toLocaleDateString('fr-CA')}`, pageWidth / 2, 155, { align: 'center' });
                }

                // Footer
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-CA')}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            },

            renderPDFTravailPage(doc, travail, index, pageWidth, pageHeight, margin) {
                const visiteData = this.visitesData[index] || {};
                const uploadData = this.uploadsData[index] || {};
                const commentaire = this.commentairesTravaux[index] || '';

                // Collecter toutes les photos
                const photosGestionnaire = travail.photos || [];
                const photosVisite = visiteData.photos || [];
                const photosEntrepreneur = uploadData.photos || [];
                const allPhotos = [...photosGestionnaire, ...photosVisite, ...photosEntrepreneur];
                const hasPhotos = allPhotos.length > 0;

                // === EN-T√äTE AVEC BANDE BLEUE ===
                doc.setFillColor(30, 58, 95);
                doc.rect(0, 0, pageWidth, 25, 'F');

                // Num√©ro travail √† gauche
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${index + 1} / ${this.travaux.length}`, margin, 16);

                // OT au centre
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`OT: ${travail.ot || 'N/A'}`, pageWidth / 2, 16, { align: 'center' });

                // Badge visite √† droite si applicable
                if (visiteData.aVoirSurPlace) {
                    doc.setFillColor(252, 231, 243);
                    doc.roundedRect(pageWidth - margin - 45, 8, 45, 12, 3, 3, 'F');
                    doc.setTextColor(190, 24, 93);
                    doc.setFontSize(8);
                    doc.text('√Ä voir sur place', pageWidth - margin - 22.5, 16, { align: 'center' });
                }

                // === DESCRIPTION SOUS L'EN-T√äTE ===
                doc.setTextColor(30, 41, 59);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                const descLines = doc.splitTextToSize(travail.description || 'Sans description', pageWidth - margin * 2);
                doc.text(descLines.slice(0, 2), pageWidth / 2, 35, { align: 'center' });

                // === MISE EN PAGE 2 COLONNES ===
                const colGauche = margin;
                const colDroite = pageWidth / 2 + 5;
                const colWidth = pageWidth / 2 - margin - 5;
                let yGauche = 50;
                let yDroite = 50;

                // === COLONNE GAUCHE: INFORMATIONS ===

                // Bloc infos principales
                doc.setFillColor(248, 250, 252);
                doc.roundedRect(colGauche, yGauche, colWidth, 50, 4, 4, 'F');

                let yInfo = yGauche + 12;
                const labelX = colGauche + 8;
                const valueX = colGauche + 55;

                // Ligne 1: √âquipement
                doc.setTextColor(100, 116, 139);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('√âquipement:', labelX, yInfo);
                doc.setTextColor(30, 41, 59);
                doc.setFont(undefined, 'bold');
                doc.text((travail.equipement || '-').substring(0, 25), valueX, yInfo);

                // Ligne 2: Op√©ration
                yInfo += 10;
                doc.setTextColor(100, 116, 139);
                doc.setFont(undefined, 'normal');
                doc.text('Op√©ration:', labelX, yInfo);
                doc.setTextColor(30, 41, 59);
                doc.setFont(undefined, 'bold');
                doc.text((travail.operation || '-').substring(0, 25), valueX, yInfo);

                // Ligne 3: Localisation
                yInfo += 10;
                doc.setTextColor(100, 116, 139);
                doc.setFont(undefined, 'normal');
                doc.text('Localisation:', labelX, yInfo);
                doc.setTextColor(30, 41, 59);
                doc.setFont(undefined, 'bold');
                doc.text((travail.localisation || travail.secteur || '-').substring(0, 25), valueX, yInfo);

                // Ligne 4: Discipline
                yInfo += 10;
                doc.setTextColor(100, 116, 139);
                doc.setFont(undefined, 'normal');
                doc.text('Discipline:', labelX, yInfo);
                doc.setTextColor(30, 41, 59);
                doc.setFont(undefined, 'bold');
                doc.text((travail.discipline || '-').substring(0, 25), valueX, yInfo);

                yGauche += 55;

                // Badges Type / Jour / Heures sur une ligne
                const typeLabels = { 'aa': 'Arr√™t Annuel', 'tpaa': 'TPAA', 'aa-tpaa': 'AA ou TPAA' };
                const jourLabels = { 'jeudi': 'Jeudi d\'arr√™t', 'hors-jeudi': 'Hors jeudi' };

                let badgeX = colGauche;

                // Badge heures
                doc.setFillColor(219, 234, 254);
                doc.roundedRect(badgeX, yGauche, 35, 14, 3, 3, 'F');
                doc.setTextColor(29, 78, 216);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text(`${travail.estimationHeures || 0}h`, badgeX + 17.5, yGauche + 10, { align: 'center' });
                badgeX += 40;

                // Badge priorit√©
                if (travail.priorite) {
                    const prioColors = { 'haute': [254, 226, 226], 'moyenne': [254, 243, 199], 'basse': [220, 252, 231] };
                    const prioText = { 'haute': [185, 28, 28], 'moyenne': [146, 64, 14], 'basse': [6, 95, 70] };
                    const prio = travail.priorite.toLowerCase();
                    doc.setFillColor(...(prioColors[prio] || [229, 231, 235]));
                    doc.roundedRect(badgeX, yGauche, 40, 14, 3, 3, 'F');
                    doc.setTextColor(...(prioText[prio] || [100, 100, 100]));
                    doc.setFontSize(9);
                    doc.text(travail.priorite, badgeX + 20, yGauche + 10, { align: 'center' });
                    badgeX += 45;
                }

                // Badge type travail
                if (travail.typeTravail) {
                    doc.setFillColor(237, 233, 254);
                    doc.roundedRect(badgeX, yGauche, 50, 14, 3, 3, 'F');
                    doc.setTextColor(109, 40, 217);
                    doc.setFontSize(9);
                    doc.text(typeLabels[travail.typeTravail] || travail.typeTravail, badgeX + 25, yGauche + 10, { align: 'center' });
                }

                yGauche += 20;

                // Badge jour arr√™t
                if (travail.jourArret && travail.typeTravail !== 'aa') {
                    doc.setFillColor(254, 243, 199);
                    doc.roundedRect(colGauche, yGauche, 55, 14, 3, 3, 'F');
                    doc.setTextColor(146, 64, 14);
                    doc.setFontSize(9);
                    doc.text(jourLabels[travail.jourArret] || travail.jourArret, colGauche + 27.5, yGauche + 10, { align: 'center' });
                    yGauche += 18;
                }

                // === COMMENTAIRE GESTIONNAIRE ===
                if (travail.commentaire) {
                    doc.setFillColor(254, 249, 195);
                    doc.roundedRect(colGauche, yGauche, colWidth, 35, 4, 4, 'F');
                    doc.setTextColor(146, 64, 14);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('Note du gestionnaire', colGauche + 5, yGauche + 10);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    const noteLines = doc.splitTextToSize(travail.commentaire, colWidth - 10);
                    doc.text(noteLines.slice(0, 4), colGauche + 5, yGauche + 18);
                    yGauche += 40;
                }

                // === COMMENTAIRE ENTREPRENEUR ===
                if (commentaire) {
                    doc.setFillColor(220, 252, 231);
                    doc.roundedRect(colGauche, yGauche, colWidth, 35, 4, 4, 'F');
                    doc.setTextColor(6, 95, 70);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('Commentaire entrepreneur', colGauche + 5, yGauche + 10);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    const entLines = doc.splitTextToSize(commentaire, colWidth - 10);
                    doc.text(entLines.slice(0, 4), colGauche + 5, yGauche + 18);
                    yGauche += 40;
                }

                // === VISITE SUR PLACE ===
                if (visiteData.aVoirSurPlace && visiteData.mesures) {
                    doc.setFillColor(252, 231, 243);
                    doc.roundedRect(colGauche, yGauche, colWidth, 28, 4, 4, 'F');
                    doc.setTextColor(190, 24, 93);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('Notes visite terrain', colGauche + 5, yGauche + 10);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    const mesuresLines = doc.splitTextToSize(visiteData.mesures, colWidth - 10);
                    doc.text(mesuresLines.slice(0, 3), colGauche + 5, yGauche + 18);
                    yGauche += 33;
                }

                // === COLONNE DROITE: PHOTOS ===
                if (hasPhotos) {
                    // Titre section photos
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(colDroite, yDroite, colWidth, 20, 4, 4, 'F');
                    doc.setTextColor(71, 85, 105);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Photos (${allPhotos.length})`, colDroite + colWidth / 2, yDroite + 13, { align: 'center' });
                    yDroite += 25;

                    // Grille de photos 2x3
                    const photoW = (colWidth - 10) / 2;
                    const photoH = 40;
                    const maxPhotos = Math.min(allPhotos.length, 6);

                    for (let i = 0; i < maxPhotos; i++) {
                        const col = i % 2;
                        const row = Math.floor(i / 2);
                        const pX = colDroite + col * (photoW + 5);
                        const pY = yDroite + row * (photoH + 5);

                        try {
                            doc.addImage(allPhotos[i], 'JPEG', pX, pY, photoW, photoH);
                        } catch (e) {
                            doc.setFillColor(229, 231, 235);
                            doc.roundedRect(pX, pY, photoW, photoH, 3, 3, 'F');
                            doc.setTextColor(150, 150, 150);
                            doc.setFontSize(8);
                            doc.text('Photo', pX + photoW / 2, pY + photoH / 2, { align: 'center' });
                        }
                    }

                    yDroite += Math.ceil(maxPhotos / 2) * (photoH + 5) + 5;

                    if (allPhotos.length > 6) {
                        doc.setTextColor(100, 116, 139);
                        doc.setFontSize(9);
                        doc.text(`+ ${allPhotos.length - 6} autres photos`, colDroite + colWidth / 2, yDroite, { align: 'center' });
                        yDroite += 10;
                    }
                } else {
                    // Pas de photos - afficher placeholder
                    doc.setFillColor(248, 250, 252);
                    doc.roundedRect(colDroite, yDroite, colWidth, 80, 4, 4, 'F');
                    doc.setTextColor(148, 163, 184);
                    doc.setFontSize(10);
                    doc.text('Aucune photo', colDroite + colWidth / 2, yDroite + 40, { align: 'center' });
                    yDroite += 85;
                }

                // === PI√àCES JOINTES (sous les photos) ===
                const nbDocs = (uploadData.documents || []).length;
                if (nbDocs > 0) {
                    doc.setFillColor(239, 246, 255);
                    doc.roundedRect(colDroite, yDroite, colWidth, 18, 4, 4, 'F');
                    doc.setTextColor(29, 78, 216);
                    doc.setFontSize(9);
                    doc.text(`${nbDocs} document(s) joint(s)`, colDroite + colWidth / 2, yDroite + 12, { align: 'center' });
                }

                // === FOOTER ===
                doc.setDrawColor(226, 232, 240);
                doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
                doc.setTextColor(148, 163, 184);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text(this.entreprise, margin, pageHeight - 8);
                doc.text(this.appelData.nomArret || 'Arr√™t Annuel', pageWidth / 2, pageHeight - 8, { align: 'center' });
                doc.text(new Date().toLocaleDateString('fr-CA'), pageWidth - margin, pageHeight - 8, { align: 'right' });
            },

            renderPDFSummaryPage(doc, pageWidth, pageHeight, margin) {
                // En-t√™te
                doc.setFillColor(30, 58, 95);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('R√©sum√© de la soumission', pageWidth / 2, 20, { align: 'center' });

                let y = 45;

                // Stats globales
                doc.setTextColor(30, 41, 59);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Statistiques:', margin, y);
                y += 10;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                const totalHeures = this.travaux.reduce((sum, t) => sum + (t.estimationHeures || 0), 0);
                const nbVisites = this.visitesData.filter(v => v?.aVoirSurPlace).length;
                const nbAA = this.travaux.filter(t => t.typeTravail === 'aa').length;
                const nbTPAA = this.travaux.filter(t => t.typeTravail === 'tpaa').length;

                doc.text(`‚Ä¢ Total travaux: ${this.travaux.length}`, margin + 10, y); y += 7;
                doc.text(`‚Ä¢ Heures estim√©es: ${totalHeures}h`, margin + 10, y); y += 7;
                doc.text(`‚Ä¢ Travaux AA: ${nbAA}`, margin + 10, y); y += 7;
                doc.text(`‚Ä¢ Travaux TPAA: ${nbTPAA}`, margin + 10, y); y += 7;
                doc.text(`‚Ä¢ Visites terrain pr√©vues: ${nbVisites}`, margin + 10, y); y += 15;

                // Liste des travaux √† visiter
                if (nbVisites > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Travaux √† voir sur place:', margin, y);
                    y += 8;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);

                    this.travaux.forEach((t, i) => {
                        if (this.visitesData[i]?.aVoirSurPlace) {
                            if (y > pageHeight - 20) return;
                            doc.text(`‚Ä¢ [${t.ot || '-'}] ${(t.description || '').substring(0, 50)}...`, margin + 10, y);
                            y += 6;
                        }
                    });
                }

                // Commentaire global
                if (this.commentaireEntrepreneur) {
                    y += 10;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Commentaire global:', margin, y);
                    y += 8;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    const globalLines = doc.splitTextToSize(this.commentaireEntrepreneur, pageWidth - margin * 2);
                    doc.text(globalLines.slice(0, 5), margin, y);
                }

                // Footer
                doc.setTextColor(150, 150, 150);
                doc.setFontSize(8);
                doc.text(`${this.entreprise} - G√©n√©r√© le ${new Date().toLocaleDateString('fr-CA')}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => toast.classList.remove('show'), 3000);
            },

            filterTravaux() {
                const searchVal = (document.getElementById('filterSearch')?.value || '').toLowerCase();
                const equipementVal = document.getElementById('filterEquipement')?.value || '';
                const typeVal = document.getElementById('filterType')?.value || '';
                const jourVal = document.getElementById('filterJour')?.value || '';
                const visiteVal = document.getElementById('filterVisite')?.value || '';

                let visibleCount = 0;
                const cards = document.querySelectorAll('.travail-card');

                this.travaux.forEach((travail, index) => {
                    const card = cards[index];
                    if (!card) return;

                    // Filtre recherche texte (OT, description, √©quipement)
                    const matchSearch = !searchVal ||
                        (travail.ot || '').toLowerCase().includes(searchVal) ||
                        (travail.description || '').toLowerCase().includes(searchVal) ||
                        (travail.equipement || '').toLowerCase().includes(searchVal);

                    // Filtre √©quipement
                    const matchEquipement = !equipementVal || travail.equipement === equipementVal;

                    // Filtre type (AA/TPAA)
                    const matchType = !typeVal || travail.typeTravail === typeVal;

                    // Filtre jour (jeudi/hors-jeudi)
                    const matchJour = !jourVal || travail.jourArret === jourVal;

                    // Filtre visite sur place
                    const hasVisite = this.visitesData[index]?.aVoirSurPlace || false;
                    const matchVisite = !visiteVal ||
                        (visiteVal === 'oui' && hasVisite) ||
                        (visiteVal === 'non' && !hasVisite);

                    const visible = matchSearch && matchEquipement && matchType && matchJour && matchVisite;
                    card.style.display = visible ? '' : 'none';
                    if (visible) visibleCount++;
                });

                // Mettre √† jour le compteur
                const countEl = document.getElementById('filterCount');
                if (countEl) {
                    countEl.textContent = `${visibleCount} / ${this.travaux.length} travaux`;
                }
            },

            // ========== FONCTIONS VISITE SUR PLACE ==========

            async toggleVisite(index) {
                // Initialiser si n√©cessaire
                if (!this.visitesData[index]) {
                    this.visitesData[index] = { aVoirSurPlace: false, photos: [], mesures: '' };
                }

                // Toggle
                this.visitesData[index].aVoirSurPlace = !this.visitesData[index].aVoirSurPlace;

                // Mettre √† jour l'UI
                const container = document.getElementById(`visite-container-${index}`);
                const section = document.getElementById(`visite-section-${index}`);
                const card = document.querySelector(`.travail-card[data-index="${index}"]`);

                if (this.visitesData[index].aVoirSurPlace) {
                    container?.classList.add('checked');
                    section?.classList.add('show');
                    // Ajouter le badge dans le header de la carte
                    const badgesDiv = card?.querySelector('.travail-badges');
                    if (badgesDiv && !badgesDiv.querySelector('.badge-visite')) {
                        badgesDiv.innerHTML = '<span class="badge badge-visite">üìç √Ä voir sur place</span>' + badgesDiv.innerHTML;
                    }
                } else {
                    container?.classList.remove('checked');
                    section?.classList.remove('show');
                    // Retirer le badge
                    const badge = card?.querySelector('.badge-visite');
                    if (badge) badge.remove();
                }

                // Mettre √† jour le compteur dans le header
                this.updateVisitesCounter();

                // Sauvegarder
                await this.sauvegarderVisitesData();
            },

            updateVisitesCounter() {
                const nbVisites = this.visitesData.filter(v => v?.aVoirSurPlace).length;
                const headerVisites = document.getElementById('header-visites');
                if (headerVisites) {
                    headerVisites.style.color = nbVisites > 0 ? '#fce7f3' : 'inherit';
                    headerVisites.querySelector('.header-stat-num').textContent = nbVisites;
                }
            },

            async ajouterPhotoVisite(index, files) {
                if (!files || files.length === 0) return;

                // Initialiser si n√©cessaire
                if (!this.visitesData[index]) {
                    this.visitesData[index] = { aVoirSurPlace: true, photos: [], mesures: '' };
                }
                if (!this.visitesData[index].photos) {
                    this.visitesData[index].photos = [];
                }

                // Compresser et ajouter chaque photo
                for (const file of files) {
                    if (this.visitesData[index].photos.length >= 10) {
                        this.showToast('Maximum 10 photos par travail', 'error');
                        break;
                    }

                    try {
                        const compressed = await this.compressImage(file, 1200, 0.8);
                        this.visitesData[index].photos.push(compressed);
                    } catch (error) {
                        console.error('Erreur compression:', error);
                    }
                }

                // Mettre √† jour l'affichage des photos
                this.updateVisitePhotosUI(index);

                // Sauvegarder
                await this.sauvegarderVisitesData();
                this.showToast('üì∑ Photo(s) ajout√©e(s)!');

                // Reset input
                document.getElementById(`visite-photo-input-${index}`).value = '';
            },

            async supprimerPhotoVisite(index, photoIndex) {
                if (!this.visitesData[index]?.photos) return;

                this.visitesData[index].photos.splice(photoIndex, 1);

                // Mettre √† jour l'affichage
                this.updateVisitePhotosUI(index);

                // Sauvegarder
                await this.sauvegarderVisitesData();
                this.showToast('Photo supprim√©e');
            },

            updateVisitePhotosUI(index) {
                const container = document.getElementById(`visite-photos-${index}`);
                if (!container) return;

                const photos = this.visitesData[index]?.photos || [];

                if (photos.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = `
                    <div class="visite-photos-grid">
                        ${photos.map((photo, photoIndex) => `
                            <div class="visite-photo-item">
                                <img src="${photo}" class="visite-photo-img" onclick="PortailEntrepreneur.showPhoto('${photo}')">
                                <button class="visite-photo-delete" onclick="PortailEntrepreneur.supprimerPhotoVisite(${index}, ${photoIndex})">√ó</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            async sauvegarderMesures(index, value) {
                // Initialiser si n√©cessaire
                if (!this.visitesData[index]) {
                    this.visitesData[index] = { aVoirSurPlace: true, photos: [], mesures: '' };
                }

                this.visitesData[index].mesures = value;

                // Sauvegarder
                await this.sauvegarderVisitesData();
            },

            async sauvegarderVisitesData() {
                try {
                    await firebase.firestore()
                        .collection('commentaires_entrepreneurs')
                        .doc(this.appelId)
                        .set({
                            commentaire: this.commentaireEntrepreneur,
                            commentairesTravaux: this.commentairesTravaux,
                            visitesData: this.visitesData,
                            entreprise: this.entreprise,
                            dateModification: new Date().toISOString()
                        }, { merge: true });
                } catch (error) {
                    console.error('Erreur sauvegarde visites:', error);
                    this.showToast('‚ùå Erreur de sauvegarde', 'error');
                }
            },

            compressImage(file, maxSize = 1200, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            // Redimensionner si n√©cessaire
                            if (width > maxSize || height > maxSize) {
                                if (width > height) {
                                    height = (height / width) * maxSize;
                                    width = maxSize;
                                } else {
                                    width = (width / height) * maxSize;
                                    height = maxSize;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            // ========== FONCTIONS UPLOAD PHOTOS/DOCUMENTS ENTREPRENEUR ==========

            renderEntrepreneurPhotos(index) {
                const photos = this.uploadsData[index]?.photos || [];
                if (photos.length === 0) return '';

                return `
                    <div class="entrepreneur-photos-grid">
                        ${photos.map((photo, photoIndex) => `
                            <div class="entrepreneur-photo-item">
                                <img src="${photo}" class="entrepreneur-photo-img" onclick="PortailEntrepreneur.showPhoto('${photo}')">
                                <button class="entrepreneur-photo-delete" onclick="PortailEntrepreneur.supprimerPhotoEntrepreneur(${index}, ${photoIndex})">√ó</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderEntrepreneurDocs(index) {
                const docs = this.uploadsData[index]?.documents || [];
                if (docs.length === 0) return '';

                return `
                    <div class="entrepreneur-docs-list">
                        ${docs.map((doc, docIndex) => `
                            <div class="entrepreneur-doc-item">
                                <span class="entrepreneur-doc-icon">${this.getDocIcon(doc.name)}</span>
                                <div class="entrepreneur-doc-info">
                                    <div class="entrepreneur-doc-name">${doc.name}</div>
                                    <div class="entrepreneur-doc-size">${this.formatFileSize(doc.size)}</div>
                                </div>
                                <a href="${doc.data}" download="${doc.name}" class="entrepreneur-doc-view">T√©l√©charger</a>
                                <button class="entrepreneur-doc-delete" onclick="PortailEntrepreneur.supprimerDocEntrepreneur(${index}, ${docIndex})">Supprimer</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            getDocIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const icons = {
                    'pdf': 'üìï',
                    'doc': 'üìò',
                    'docx': 'üìò',
                    'xls': 'üìó',
                    'xlsx': 'üìó',
                    'txt': 'üìÑ'
                };
                return icons[ext] || 'üìÑ';
            },

            formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            },

            async ajouterPhotosEntrepreneur(index, files) {
                if (!files || files.length === 0) return;

                // Initialiser si n√©cessaire
                if (!this.uploadsData[index]) {
                    this.uploadsData[index] = { photos: [], documents: [] };
                }
                if (!this.uploadsData[index].photos) {
                    this.uploadsData[index].photos = [];
                }

                // Compresser et ajouter chaque photo
                for (const file of files) {
                    if (this.uploadsData[index].photos.length >= 20) {
                        this.showToast('Maximum 20 photos par travail', 'error');
                        break;
                    }

                    try {
                        const compressed = await this.compressImage(file, 1200, 0.8);
                        this.uploadsData[index].photos.push(compressed);
                    } catch (error) {
                        console.error('Erreur compression:', error);
                    }
                }

                // Mettre √† jour l'affichage
                this.updateEntrepreneurPhotosUI(index);

                // Sauvegarder
                await this.sauvegarderUploadsData();
                this.showToast(`üñºÔ∏è ${files.length} photo(s) ajout√©e(s)!`);

                // Reset input
                document.getElementById(`entrepreneur-photos-input-${index}`).value = '';
            },

            async supprimerPhotoEntrepreneur(index, photoIndex) {
                if (!this.uploadsData[index]?.photos) return;

                this.uploadsData[index].photos.splice(photoIndex, 1);
                this.updateEntrepreneurPhotosUI(index);
                await this.sauvegarderUploadsData();
                this.showToast('Photo supprim√©e');
            },

            updateEntrepreneurPhotosUI(index) {
                const container = document.getElementById(`entrepreneur-photos-${index}`);
                if (container) {
                    container.innerHTML = this.renderEntrepreneurPhotos(index);
                }
            },

            async ajouterDocsEntrepreneur(index, files) {
                if (!files || files.length === 0) return;

                // Initialiser si n√©cessaire
                if (!this.uploadsData[index]) {
                    this.uploadsData[index] = { photos: [], documents: [] };
                }
                if (!this.uploadsData[index].documents) {
                    this.uploadsData[index].documents = [];
                }

                // Lire et ajouter chaque document
                for (const file of files) {
                    if (this.uploadsData[index].documents.length >= 10) {
                        this.showToast('Maximum 10 documents par travail', 'error');
                        break;
                    }

                    // Limiter la taille (5MB max par fichier)
                    if (file.size > 5 * 1024 * 1024) {
                        this.showToast(`${file.name} trop volumineux (max 5MB)`, 'error');
                        continue;
                    }

                    try {
                        const base64 = await this.readFileAsBase64(file);
                        this.uploadsData[index].documents.push({
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: base64
                        });
                    } catch (error) {
                        console.error('Erreur lecture fichier:', error);
                    }
                }

                // Mettre √† jour l'affichage
                this.updateEntrepreneurDocsUI(index);

                // Sauvegarder
                await this.sauvegarderUploadsData();
                this.showToast(`üìÑ ${files.length} document(s) ajout√©(s)!`);

                // Reset input
                document.getElementById(`entrepreneur-docs-input-${index}`).value = '';
            },

            readFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            async supprimerDocEntrepreneur(index, docIndex) {
                if (!this.uploadsData[index]?.documents) return;

                this.uploadsData[index].documents.splice(docIndex, 1);
                this.updateEntrepreneurDocsUI(index);
                await this.sauvegarderUploadsData();
                this.showToast('Document supprim√©');
            },

            updateEntrepreneurDocsUI(index) {
                const container = document.getElementById(`entrepreneur-docs-${index}`);
                if (container) {
                    container.innerHTML = this.renderEntrepreneurDocs(index);
                }
            },

            async sauvegarderUploadsData() {
                try {
                    await firebase.firestore()
                        .collection('commentaires_entrepreneurs')
                        .doc(this.appelId)
                        .set({
                            commentaire: this.commentaireEntrepreneur,
                            commentairesTravaux: this.commentairesTravaux,
                            visitesData: this.visitesData,
                            uploadsData: this.uploadsData,
                            entreprise: this.entreprise,
                            dateModification: new Date().toISOString()
                        }, { merge: true });
                } catch (error) {
                    console.error('Erreur sauvegarde uploads:', error);
                    this.showToast('‚ùå Erreur de sauvegarde', 'error');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            PortailEntrepreneur.init();
        });

        // Arr√™ter la synchronisation quand on quitte la page
        window.addEventListener('beforeunload', () => {
            PortailEntrepreneur.stopRealtimeSync();
        });
    </script>
</body>
</html>
